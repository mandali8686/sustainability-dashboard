<!DOCTYPE html>
<!-- saved from url=(0030)https://sankeymatic.com/build/ -->
<html lang="en-US"><script src="chrome-extension://dpjiaamadbcfheiamdaamhgpomlkohbn/preInjected.js"></script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="initial-scale=1">
<title>SankeyMATIC: Build a Sankey Diagram</title>
<link rel="stylesheet" href="./SankeyMATIC_ Build a Sankey Diagram_files/build.css">
<link rel="stylesheet" href="./SankeyMATIC_ Build a Sankey Diagram_files/main.css">
<link rel="stylesheet" href="./SankeyMATIC_ Build a Sankey Diagram_files/nav.css">
<script defer="" src="./SankeyMATIC_ Build a Sankey Diagram_files/d3.min.js"></script>
<script defer="" src="./SankeyMATIC_ Build a Sankey Diagram_files/umd.js"></script>
<script defer="" src="./SankeyMATIC_ Build a Sankey Diagram_files/constants.js"></script>
<script defer="" src="./SankeyMATIC_ Build a Sankey Diagram_files/sankey.js"></script>
<script defer="" src="./SankeyMATIC_ Build a Sankey Diagram_files/sankeymatic.js"></script>
<meta name="description" content="Make beautiful Sankey diagrams. Export them as images or SVG with this free data visualization tool.">
<meta property="og:title" content="SankeyMATIC: Build a Sankey Diagram">
<meta property="og:type" content="website">
<meta property="og:url" content="https://sankeymatic.com/build/">
<meta property="og:description" content="Make beautiful flow diagrams. Export them as images or SVG.">
<meta property="og:site_name" content="SankeyMATIC.com">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sankeymatic.com/i/sankeymatic-build-card-image.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="2700">
<meta property="og:image:height" content="1350">
<meta property="og:image:alt" content="Screenshot of the SankeyMATIC diagram-building interface">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@SankeyMATIC">
<meta name="twitter:creator" content="@nowthis">
<meta name="twitter:title" content="SankeyMATIC: Build a Sankey Diagram">
<meta name="twitter:description" content="Make beautiful flow diagrams. Export them as images or SVG.">
<meta name="twitter:image" content="https://sankeymatic.com/i/sankeymatic-build-card-image.png">
<meta name="twitter:image:alt" content="Screenshot of the SankeyMATIC diagram-building interface">
</head>
<body>
<header>
<nav id="top_nav" class="main_nav_behavior">
  <label for="top_nav_checkbox" id="top_nav_icon" class="main_nav_icon">☰ &nbsp; SankeyMATIC</label>
  <input id="top_nav_checkbox" class="main_nav_checkbox" type="checkbox">
  <!-- [MENU ITEMS] -->
  <div id="top_nav_items" class="main_nav_items">
<ul>
  <li><a title="SankeyMATIC home page" href="https://sankeymatic.com/"><img alt="SankeyMATIC logo" src="./SankeyMATIC_ Build a Sankey Diagram_files/SKM-trsp-300.png" height="27" width="27" class="skm_logo_small">&nbsp;<strong>SankeyMATIC</strong></a></li>
  <li><a title="Build a Sankey Diagram" href="https://sankeymatic.com/build/">Build a Sankey Diagram</a></li>
  <li><a title="How to use SankeyMATIC to the fullest" href="https://sankeymatic.com/manual/">Manual</a></li>
  <li><a title="What&#39;s New with SankeyMATIC&#39;" href="https://sankeymatic.com/news/">News</a></li>
  <li><a title="Gallery of Sankey Examples" href="https://sankeymatic.com/gallery/">Gallery</a></li>
  <li><a title="About SankeyMATIC and how to support the site" href="https://sankeymatic.com/about/">About/Donate</a></li>
</ul>
  </div>
</nav>
</header>

<div class="callout_container"><span class="callout">
If you find SankeyMATIC useful, please consider <a href="https://sankeymatic.com/about/" target="_blank">donating to support further development</a>. Thanks!
</span></div>

<main>
<div class="center_basic">

<form id="skm_form" onsubmit="process_sankey(); return false;">
<div id="example_diagrams" class="text_center">
<h4>Sample Diagrams &amp; Starting Points:
<button type="button" id="load_example_simple" onclick="replaceGraph(&#39;simple_start&#39;); return false;">Start Simple</button>
<button type="button" id="load_example_financial_results" onclick="replaceGraph(&#39;financial_results&#39;); return false;">Financial Results</button>
<button type="button" id="load_example_job_search" onclick="replaceGraph(&#39;job_search&#39;); return false;">Job Search</button>
<button type="button" id="load_example_election" onclick="replaceGraph(&#39;election&#39;); return false;">Ranked Election</button>
<!-- <button type="button" id="load_example_energy_all" onclick="replaceGraph('energy_flows_all'); return false;">Energy Flows</button> &nbsp; -->
<button type="button" id="load_example_basic_budget" onclick="replaceGraph(&#39;default_budget&#39;); return false;">Budget (Default)</button>
</h4>

<p id="replace_graph_warning" style="display: none;">
<em>This will <strong>erase</strong> your changes. Are you sure?</em><br>
<input type="hidden" id="demo_graph_chosen" value="">
<button type="button" id="replace_graph_yes" onclick="replaceGraphConfirmed(); return false;">Yes, replace the diagram</button>
<button type="button" id="replace_graph_no" onclick="hideReplaceGraphWarning(); return false;">Cancel</button>
</p>
</div>

<table><tbody><tr><td>

<table class="center_basic">
<tbody><tr>
    <td id="other_entry">

<h2 class="ui_head" onclick="togglePanel(&#39;input_options&#39;);">
<span id="input_options_indicator" class="indicator">–</span>
Inputs<span id="input_options_hint">:</span></h2>

<div id="input_options" class="text_center grid_sidebar_right">
<div>
    <textarea id="flows_in" title="Diagram Inputs" rows="19" cols="40" class="font_sans" onchange="process_sankey();">// SankeyMATIC diagram inputs - Saved: 10/7/2023, 5:31:31 PM
        // https://sankeymatic.com/build/
        
        // === Nodes and Flows ===
        
        // Enter Flows between Nodes, like this:
        //         Source [AMOUNT] Target
        
        //Metric
        Vanderbilt [1000] Water
        Vanderbilt [5000] Electricity
        Vanderbilt [3000] Landfill
        Vanderbilt [1000] Compost/Recycling
        
        // Use
        Water [500] Buildings
        Water [500] Dining
        
        Electricity [2500] Purchased Energy
        Electricity [250] Transportation
        Electricity [1250] Dining
        Electricity [1000] Buildings
        
        Landfill [1800] Dining
        Landfill [1200] Buildings
        
        Compost/Recycling [800] Dining
        Compost/Recycling [200] Buildings
        
        // Opportunity
        Purchased Energy [750] Renewable Energy
        Purchased Energy [1750] Fossil-Fuel Dependent
        
        Transportation [150] Air Travel
        Transportation [75] Car
        Transportation [12.5] Public Transit
        Transportation [12.5] Bike/Scooter/Walk
        
        Dining [1740] Cooking
        Dining [435] Dishes
        Dining [2175] Food Consumption
        
        Buildings [290] Plumbing
        Buildings [290] Lighting
        Buildings [870] HVAC
        Buildings [1450] Construction
        
        //Responsibility
        Renewable Energy [750] University Control
        Fossil-Fuel Dependent [1750] University Control
        Air Travel [75] University Control
        Air Travel [75] Individual Action
        Car [15] University Control
        Car [60] Individual Action
        Public Transit [2.5] University Control
        Public Transit [10] Individual Action
        Bike/Scooter/Walk [2.5] University Control
        Bike/Scooter/Walk [10] Individual Action
        Cooking [1740] University Control
        Dishes [435] University Control
        Food Consumption [675] University Control
        Food Consumption [1500] Individual Action
        Plumbing [200] University Control
        Plumbing [90] Individual Action
        Lighting [200] University Control
        Lighting [90] Individual Action
        HVAC [470] University Control
        HVAC [400] Individual Action
        Construction [1400] University Control
        Construction [50] Individual Action
        
        // === Settings ===
        
        size w 1200
          h 1000
        margin l 12
          r 12
          t 18
          b 20
        bg color #ffffff
          transparent N
        node w 9
          h 50
          spacing 85
          border 0
          theme a
          color #888888
          opacity 1
        flow curvature 0.5
          inheritfrom target
          color #999999
          opacity 0.45
        layout order automatic
          justifyorigins N
          justifyends N
          reversegraph N
          attachincompletesto nearest
        labels color #000000
          highlight 0.55
          fontface sans-serif
        labelname appears Y
          size 16
          weight 400
        labelvalue appears Y
          fullprecision Y
        labelposition first before
          breakpoint 6
        value format ',.'
          prefix ''
          suffix ''
        themeoffset a 9
          b 0
          c 0
          d 0
        meta mentionsankeymatic Y
          listimbalances Y
        </textarea>
</div>

<div class="separated_stack">

<div class="top_center_self"><button id="preview_graph" type="submit">Show &gt;</button></div>

<div class="bottom_center_self">
<button id="save_my_work_button" type="submit" class="loadsave_button" onclick="saveDiagramToFile(); return false;" title="Save the current diagram and settings to a local text file">Save my<br>work  ▼</button>

<p>
<input type="file" id="load_diagram_from_file" accept=".txt,.text,.skm,text/plain" class="hidden_under" onchange="loadDiagramFile(); return null;">
<label id="load_diagram_button" for="load_diagram_from_file" role="button" class="label_as_button loadsave_button" title="Load a diagram definition from a text file">◄ Load<br>from file</label></p>

</div>
</div>

<p class="form_elements3 grid_entire_row">
<strong>Arrange the diagram:</strong><br>
<span><input name="layout_order" id="layout_order_automatic" value="automatic" type="radio" onchange="process_sankey();" checked="checked"><label for="layout_order_automatic" class="ropt">Automatically</label></span>
<span><input name="layout_order" id="layout_order_exact" value="exact" type="radio" onchange="process_sankey();" class="spaced_checkbox"><label for="layout_order_exact" class="ropt">Using the exact input order</label></span>
</p>
</div>

<!-- NODES -->

<h2 class="ui_head" onclick="togglePanel(&#39;node_options&#39;);">
<span id="node_options_indicator" class="indicator">–</span>
Nodes<span id="node_options_hint">:</span></h2>
<!-- tabindex="0" -->
<div id="node_options" class="form_chunk">
<p class="form_elements1">
<span class="no_wrap output_container" onmouseover="revealVal(&#39;node_h&#39;);" onmouseout="fadeVal(&#39;node_h&#39;);">
<label for="node_h"><strong>Height:</strong></label>
.<input id="node_h" class="slider_small" type="range" min="0" max="100" step="1" value="50" onfocus="revealVal(&#39;node_h&#39;);" onblur="fadeVal(&#39;node_h&#39;);" oninput="updateOutput(&#39;node_h&#39;); process_sankey();" onchange="process_sankey();">|
<output id="node_h_val" for="node_h" class="output_wide fade-out">50%</output></span>

<span class="no_wrap output_container" onmouseover="revealVal(&#39;node_spacing&#39;);" onmouseout="fadeVal(&#39;node_spacing&#39;);">
<label for="node_spacing" class="spaced_label"><strong>Spacing:</strong></label>
<span class="smalllabel">0</span><input id="node_spacing" class="slider_small" type="range" min="0" max="100" step="1" value="85" onfocus="revealVal(&#39;node_spacing&#39;);" onblur="fadeVal(&#39;node_spacing&#39;);" oninput="updateOutput(&#39;node_spacing&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel">Max</span>
<output id="node_spacing_val" for="node_spacing" class="output_wide fade-out">85%</output></span>
</p>

<p class="form_elements2">
<span class="no_wrap"><label for="node_w"><strong>Width:</strong></label>
<input id="node_w" type="number" class="wholenumber number_100s" min="0" value="9" step="1" onchange="process_sankey();"></span>

<span class="no_wrap"><label for="node_border" class="spaced_label"><strong>Border:</strong></label>
<input id="node_border" type="number" class="wholenumber number_10s" min="0" value="0" step="1" onchange="process_sankey();"></span>

<span class="no_wrap output_container" onmouseover="revealVal(&#39;node_opacity&#39;);" onmouseout="fadeVal(&#39;node_opacity&#39;);">
<label for="node_opacity" class="spaced_label"><strong>Opacity:</strong></label>
<span class="smalllabel">0</span><input id="node_opacity" class="slider_xxsmall" type="range" min="0" max="1" step="0.05" value="1.0" onfocus="revealVal(&#39;node_opacity&#39;);" onblur="fadeVal(&#39;node_opacity&#39;);" oninput="updateOutput(&#39;node_opacity&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel">1</span>
<output id="node_opacity_val" for="node_opacity" class="fade-init output_medium"></output></span>
</p>

<fieldset class="form_elements1">
<legend>Default Node Colors:</legend>
<div class="fieldset_contents">
Use <input name="node_theme" type="radio" id="node_theme_none" value="none" onchange="process_sankey();"><label for="node_theme_none" class="ropt">one color:</label>
<input type="color" id="node_color" title="Single Node Color" size="7" maxlength="7" value="#888888" onchange="checkRadio(&#39;node_theme_none&#39;); process_sankey();"> or a Theme:<br>
<table id="color_themes">
<tbody><tr>
<td class="text_left">
<span id="theme_a" class="theme_container">
<input name="node_theme" type="radio" id="theme_a_radio" value="a" onchange="process_sankey();" checked="checked"><label id="theme_a_label" for="theme_a_radio" class="ropt">Categories</label>
</span>
</td>
<td class="text_left">
<span class="no_wrap">
<button id="theme_a_rotate_left" type="submit" title="Rotate theme colors left" onclick="nudgeColorTheme(&#39;a&#39;,1); return false;">&lt;</button>
<span id="theme_a_guide"><span style="background-color: #17becf;" class="color_sample_10" title="#17becf from d3 color scheme Category10">&nbsp;</span><span style="background-color: #1f77b4;" class="color_sample_10" title="#1f77b4 from d3 color scheme Category10">&nbsp;</span><span style="background-color: #ff7f0e;" class="color_sample_10" title="#ff7f0e from d3 color scheme Category10">&nbsp;</span><span style="background-color: #2ca02c;" class="color_sample_10" title="#2ca02c from d3 color scheme Category10">&nbsp;</span><span style="background-color: #d62728;" class="color_sample_10" title="#d62728 from d3 color scheme Category10">&nbsp;</span><span style="background-color: #9467bd;" class="color_sample_10" title="#9467bd from d3 color scheme Category10">&nbsp;</span><span style="background-color: #8c564b;" class="color_sample_10" title="#8c564b from d3 color scheme Category10">&nbsp;</span><span style="background-color: #e377c2;" class="color_sample_10" title="#e377c2 from d3 color scheme Category10">&nbsp;</span><span style="background-color: #7f7f7f;" class="color_sample_10" title="#7f7f7f from d3 color scheme Category10">&nbsp;</span><span style="background-color: #bcbd22;" class="color_sample_10" title="#bcbd22 from d3 color scheme Category10">&nbsp;</span></span><input type="hidden" id="themeoffset_a" value="9">
<button id="theme_a_rotate_right" type="submit" title="Rotate theme colors right" onclick="nudgeColorTheme(&#39;a&#39;,-1); return false;">&gt;</button>
</span>
</td>
</tr>
<tr>
<td class="text_left">
<span id="theme_b" class="theme_container">
<input name="node_theme" type="radio" id="theme_b_radio" value="b" onchange="process_sankey();"><label id="theme_b_label" for="theme_b_radio" class="ropt">Tableau10</label>
</span>
</td>
<td class="text_left">
<span class="no_wrap">
<button id="theme_b_rotate_left" type="submit" title="Rotate theme colors left" onclick="nudgeColorTheme(&#39;b&#39;,1); return false;">&lt;</button>
<span id="theme_b_guide"><span style="background-color: #4e79a7;" class="color_sample_10" title="#4e79a7 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #f28e2c;" class="color_sample_10" title="#f28e2c from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #e15759;" class="color_sample_10" title="#e15759 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #76b7b2;" class="color_sample_10" title="#76b7b2 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #59a14f;" class="color_sample_10" title="#59a14f from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #edc949;" class="color_sample_10" title="#edc949 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #af7aa1;" class="color_sample_10" title="#af7aa1 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #ff9da7;" class="color_sample_10" title="#ff9da7 from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #9c755f;" class="color_sample_10" title="#9c755f from d3 color scheme Tableau10">&nbsp;</span><span style="background-color: #bab0ab;" class="color_sample_10" title="#bab0ab from d3 color scheme Tableau10">&nbsp;</span></span><input type="hidden" id="themeoffset_b" value="0">
<button id="theme_b_rotate_right" type="submit" title="Rotate theme colors right" onclick="nudgeColorTheme(&#39;b&#39;,-1); return false;">&gt;</button>
</span>
</td>
</tr>
<tr>
<td class="text_left">
<span id="theme_c" class="theme_container">
<input name="node_theme" type="radio" id="theme_c_radio" value="c" onchange="process_sankey();"><label id="theme_c_label" for="theme_c_radio" class="ropt">Dark</label>
</span>
</td>
<td class="text_left">
<span class="no_wrap">
<button id="theme_c_rotate_left" type="submit" title="Rotate theme colors left" onclick="nudgeColorTheme(&#39;c&#39;,1); return false;">&lt;</button>
<span id="theme_c_guide"><span style="background-color: #1b9e77;" class="color_sample_8" title="#1b9e77 from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #d95f02;" class="color_sample_8" title="#d95f02 from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #7570b3;" class="color_sample_8" title="#7570b3 from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #e7298a;" class="color_sample_8" title="#e7298a from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #66a61e;" class="color_sample_8" title="#66a61e from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #e6ab02;" class="color_sample_8" title="#e6ab02 from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #a6761d;" class="color_sample_8" title="#a6761d from d3 color scheme Dark2">&nbsp;</span><span style="background-color: #666666;" class="color_sample_8" title="#666666 from d3 color scheme Dark2">&nbsp;</span></span><input type="hidden" id="themeoffset_c" value="0">
<button id="theme_c_rotate_right" type="submit" title="Rotate theme colors right" onclick="nudgeColorTheme(&#39;c&#39;,-1); return false;">&gt;</button>
</span>
</td>
</tr>
<tr>
<td class="text_left">
<span id="theme_d" class="theme_container">
<input name="node_theme" type="radio" id="theme_d_radio" value="d" onchange="process_sankey();"><label id="theme_d_label" for="theme_d_radio" class="ropt">Varied</label>
</span>
</td>
<td class="text_left">
<span class="no_wrap">
<button id="theme_d_rotate_left" type="submit" title="Rotate theme colors left" onclick="nudgeColorTheme(&#39;d&#39;,1); return false;">&lt;</button>
<span id="theme_d_guide"><span style="background-color: #8dd3c7;" class="color_sample_12" title="#8dd3c7 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #ffffb3;" class="color_sample_12" title="#ffffb3 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #bebada;" class="color_sample_12" title="#bebada from d3 color scheme Set3">&nbsp;</span><span style="background-color: #fb8072;" class="color_sample_12" title="#fb8072 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #80b1d3;" class="color_sample_12" title="#80b1d3 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #fdb462;" class="color_sample_12" title="#fdb462 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #b3de69;" class="color_sample_12" title="#b3de69 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #fccde5;" class="color_sample_12" title="#fccde5 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #d9d9d9;" class="color_sample_12" title="#d9d9d9 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #bc80bd;" class="color_sample_12" title="#bc80bd from d3 color scheme Set3">&nbsp;</span><span style="background-color: #ccebc5;" class="color_sample_12" title="#ccebc5 from d3 color scheme Set3">&nbsp;</span><span style="background-color: #ffed6f;" class="color_sample_12" title="#ffed6f from d3 color scheme Set3">&nbsp;</span></span><input type="hidden" id="themeoffset_d" value="0">
<button id="theme_d_rotate_right" type="submit" title="Rotate theme colors right" onclick="nudgeColorTheme(&#39;d&#39;,-1); return false;">&gt;</button>
</span>
</td>
</tr>
</tbody></table>
</div>

</fieldset>
</div>

<h2 class="ui_head" onclick="togglePanel(&#39;flow_options&#39;);">
<span id="flow_options_indicator" class="indicator">–</span>
Flows<span id="flow_options_hint">:</span></h2>

<div id="flow_options" class="form_chunk">
<p class="form_elements1">
<span class="no_wrap output_container" onmouseover="revealVal(&#39;flow_opacity&#39;);" onmouseout="fadeVal(&#39;flow_opacity&#39;);">
<label for="flow_opacity"><strong>Opacity:</strong></label>
<span class="smalllabel">0</span><input id="flow_opacity" class="slider_xsmall" type="range" min="0" max="1" step="0.05" value="0.45" onfocus="revealVal(&#39;flow_opacity&#39;);" onblur="fadeVal(&#39;flow_opacity&#39;);" oninput="updateOutput(&#39;flow_opacity&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel">1</span>
<output id="flow_opacity_val" for="flow_opacity" class="fade-init output_medium"></output></span>

<span class="no_wrap output_container" onmouseover="revealVal(&#39;flow_curvature&#39;);" onmouseout="fadeVal(&#39;flow_curvature&#39;);">
<label for="flow_curvature" class="spaced_label"><strong>Curviness:</strong></label>&nbsp;
|<input id="flow_curvature" class="slider_small" type="range" min="0.1" max="0.9" step="0.04" value="0.5" onfocus="revealVal(&#39;flow_curvature&#39;);" onblur="fadeVal(&#39;flow_curvature&#39;);" oninput="updateOutput(&#39;flow_curvature&#39;); process_sankey();" onchange="process_sankey();">(
<output id="flow_curvature_val" for="flow_curvature" class="fade-init output_medium_long"></output></span>
</p>

<fieldset class="form_elements2">
<legend>Default Flow Colors:</legend>

<div class="fieldset_contents">

Use <input name="flow_inheritfrom" type="radio" id="flow_inherit_none" value="none" onchange="process_sankey();"><label for="flow_inherit_none" class="ropt">one color:</label>

<input type="color" id="flow_color" title="Single Flow Color" size="7" maxlength="7" value="#999999" onchange="checkRadio(&#39;flow_inherit_none&#39;); process_sankey();"> or colors from:<br>
<span class="no_wrap"><input name="flow_inheritfrom" type="radio" id="flow_inherit_from_source" value="source" onchange="process_sankey();"><label class="ropt" for="flow_inherit_from_source">each flow's Source</label></span>
<span class="no_wrap"><input name="flow_inheritfrom" type="radio" id="flow_inherit_from_target" value="target" onchange="process_sankey();"><label class="ropt" for="flow_inherit_from_target">each flow's Target</label></span>
<br>
<span class="no_wrap"><input name="flow_inheritfrom" type="radio" id="flow_inherit_outside_in" value="outside-in" onchange="process_sankey();" checked="checked"><label class="ropt" for="flow_inherit_outside_in">the outermost nodes (flowing in)</label></span>
</div>

</fieldset>

</div>

<!-- LABELS -->

<h2 class="ui_head" onclick="togglePanel(&#39;label_options&#39;);">
<span id="label_options_indicator" class="indicator">+</span>
Labels &amp; Units<span id="label_options_hint">...</span></h2>

<div id="label_options" class="form_chunk" style="display: none;">
<p class="form_elements1">
<span><input type="checkbox" id="labelname_appears" value="1" onchange="process_sankey();" checked="checked">
<label for="labelname_appears" class="ropt">Show labels</label> <small class="rnote">(hide to apply your own text to the graph)</small></span>
<br>

&nbsp;&nbsp;<span><input type="checkbox" id="labelvalue_appears" value="1" onchange="process_sankey();" checked="checked">
<label for="labelvalue_appears" class="ropt">Show Node totals as part of labels</label></span>
<br>

&nbsp;&nbsp;&nbsp;&nbsp;<span><input type="checkbox" id="labelvalue_fullprecision" value="1" onchange="process_sankey();" checked="checked">
<label for="labelvalue_fullprecision" class="ropt">Show trailing zeroes <small>(best for currency)</small></label></span>
<br>
</p>

<p class="form_elements2">
<label for="labelname_size"><strong>Size:</strong></label>
<span class="no_wrap"><input id="labelname_size" type="number" class="wholenumber number_100s" min="6" step="1" value="16" onchange="process_sankey();"></span>
<input type="color" id="labels_color" size="7" maxlength="7" value="#000000" onchange="process_sankey();">

<span class="no_wrap output_container spaced_label" onmouseover="revealVal(&#39;labels_highlight&#39;);" onmouseout="fadeVal(&#39;labels_highlight&#39;);">
<label for="labels_highlight" id="highlight_fld_label"><strong>Highlight:</strong></label>
<span class="smalllabel">0</span><input id="labels_highlight" class="slider_small" type="range" min="0" max="0.9" step="0.05" value="0.55" onfocus="revealVal(&#39;labels_highlight&#39;);" onblur="fadeVal(&#39;labels_highlight&#39;);" oninput="updateOutput(&#39;labels_highlight&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel">Max</span>
<output id="labels_highlight_val" for="labels_highlight" class="fade-init output_medium"></output></span>
</p>

<fieldset class="form_elements1">
<legend>Position:</legend>
<div class="fieldset_contents">

<p class="form_elements">
Place the <strong>first</strong> labels:
<span class="no_wrap"><input name="labelposition_first" type="radio" id="label_first_before" value="before" onchange="process_sankey();" checked="checked"><label for="label_first_before" class="ropt">Before the node</label></span>
<span class="no_wrap"><input name="labelposition_first" type="radio" id="label_first_after" value="after" onchange="process_sankey();"><label for="label_first_after" class="ropt">After the node</label></span>
</p>

<p class="form_elements">
<label for="labelposition_breakpoint">Place labels on the <strong>other side</strong> starting at:</label>
<span class="no_wrap output_container" onmouseover="revealVal(&#39;labelposition_breakpoint&#39;);" onmouseout="fadeVal(&#39;labelposition_breakpoint&#39;);">
<span class="smalllabel">Stage 2</span><input id="labelposition_breakpoint" class="slider_xxsmall" type="range" min="2" max="6" step="1" value="4" onfocus="revealVal(&#39;labelposition_breakpoint&#39;);" onblur="fadeVal(&#39;labelposition_breakpoint&#39;);" oninput="updateOutput(&#39;labelposition_breakpoint&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel">(never)</span>
<output id="labelposition_breakpoint_val" for="labelposition_breakpoint" class="fade-init output_10s"></output></span>
</p>
</div>
</fieldset>

<p class="form_elements2">
<strong>Face:</strong>
<span class="no_wrap"><input name="labels_fontface" type="radio" id="sans_serif" value="sans-serif" checked="checked" onchange="process_sankey();"><label for="sans_serif" class="ropt font_sans">sans</label></span>
<span class="no_wrap"><input name="labels_fontface" type="radio" id="serif" value="serif" onchange="process_sankey();"><label for="serif" class="ropt font_serif">serif</label></span>
<span class="no_wrap"><input name="labels_fontface" type="radio" id="monospace" value="monospace" onchange="process_sankey();"><label for="monospace" class="ropt font_mono">mono</label></span>

&nbsp;

<span class="no_wrap output_container" onmouseover="revealVal(&#39;labelname_weight&#39;);" onmouseout="fadeVal(&#39;labelname_weight&#39;);">
<label for="labelname_weight"><strong>Style:</strong></label>
<span class="smalllabel font_light">Light</span><input id="labelname_weight" class="slider_xxsmall" type="range" min="100" max="700" step="300" value="400" onfocus="revealVal(&#39;labelname_weight&#39;);" onblur="fadeVal(&#39;labelname_weight&#39;);" oninput="updateOutput(&#39;labelname_weight&#39;); process_sankey();" onchange="process_sankey();"><span class="smalllabel font_bolder">Bold</span>
<output id="labelname_weight_val" for="labelname_weight" class="fade-init output_medium"></output></span>
</p>

<fieldset class="form_elements1">
<legend>Units:</legend>
<div class="fieldset_contents">
<span class="no_wrap"><label for="value_prefix">Prefix =</label> <input type="text" id="value_prefix" size="3" maxlength="10" onchange="process_sankey();"></span>
<span class="no_wrap"><label for="value_suffix">Suffix =</label> <input type="text" id="value_suffix" size="5" maxlength="10" onchange="process_sankey();"></span>
<br>
<label for="value_format"><strong>Number Format:</strong></label>
<select id="value_format" onchange="process_sankey();">
<option value=",." selected="selected">1,000,000.00</option>
<option value=".,">1.000.000,00</option>
<option value=" .">1 000 000.00</option>
<option value=" ,">1 000 000,00</option>
<option value="X.">1000000.00</option>
<option value="X,">1000000,00</option>
</select>
</div>
</fieldset>

</div>

<!-- LAYOUT OPTIONS -->

<h2 class="ui_head" onclick="togglePanel(&#39;layout_options&#39;);" id="layout_options_section">
<span id="layout_options_indicator" class="indicator">+</span>
Layout Options<span id="layout_options_hint">...</span></h2>
<div id="layout_options" class="form_chunk" style="display: none;">
<div class="form_elements1 text_center">
<small>Note: these options only apply to diagrams<br> with 3 or more columns of nodes:</small>

<table style="width: 100%;"><tbody><tr>
<td class="text_left">
<input type="checkbox" id="layout_justifyorigins" value="1" onchange="process_sankey();"><br>
<label for="layout_justifyorigins" class="ropt">Place all<br> flow <strong>origins</strong><br> at the <strong>left</strong> edge</label>
</td>
<td class="text_right">
<input type="checkbox" id="layout_justifyends" value="1" onchange="process_sankey();"><br>
<label for="layout_justifyends" class="spaced_label ropt">Place all<br> flow <strong>endpoints</strong><br> at the <strong>right</strong> edge</label>
</td>
</tr></tbody></table>
</div>
<p class="form_elements2 center_content">
<input type="checkbox" id="layout_reversegraph" value="1" onchange="process_sankey();">
<label for="layout_reversegraph" class="ropt"><strong>Reverse the graph</strong> (flow right-to-left)</label>
</p>

<p class="form_elements1 center_content">
<strong>Diagram Scale</strong> = <span id="scale_figures"><strong>20.5128</strong> per pixel (10,000.0/487.5px)</span><br>
For fair comparisons <em>between</em> diagrams:<br>
1) Use the same units for each, and 2) Make their<br>
Diagram Scales match as closely as possible.
</p>

<h3 class="ui_head" onclick="togglePanel(&#39;debug_options&#39;);"><span id="debug_options_indicator" class="indicator">+</span>Tools for Debugging<span id="debug_options_hint">...</span></h3>
<div id="debug_options" class="form_chunk" style="display: none;">
<div class="form_elements1">
  <span class="no_wrap output_container" onmouseover="revealVal(&#39;internal_iterations&#39;);" onmouseout="fadeVal(&#39;internal_iterations&#39;);">
    <label for="internal_iterations" class="spaced_label"><strong># of Layout Iterations:</strong></label>
    <span class="smalllabel">0</span>
    <input id="internal_iterations" class="slider_small" type="range" min="0" max="30" step="1" value="25" onfocus="revealVal(&#39;internal_iterations&#39;);" onblur="fadeVal(&#39;internal_iterations&#39;);" oninput="updateOutput(&#39;internal_iterations&#39;); process_sankey();" onchange="process_sankey();">
    <span class="smalllabel">30</span>
    <output id="internal_iterations_val" for="internal_iterations" class="fade-init output_medium_long"></output></span>
</div>
<div class="form_elements2">
<input type="checkbox" id="internal_revealshadows" value="1" onchange="process_sankey();" class="spaced_checkbox"><label for="internal_revealshadows" class="ropt">Reveal Shadow Nodes</label>
</div>

</div>

</div>

</td>
</tr>
</tbody></table>

</td><td id="grapharea">
<!-- SIZE & SPACING & BACKGROUND -->

<div class="expandable_box">
<h2 class="ui_head" onclick="togglePanel(&#39;diagram_options&#39;);">
<span id="diagram_options_indicator" class="indicator">–</span>
Diagram Size &amp; Background<span id="diagram_options_hint">:</span></h2>

<div id="diagram_options" class="form_chunk">
<p class="form_elements1">
<span class="no_wrap"><label for="size_w" title="Diagram Width in pixels"><strong>Width:</strong></label>
<input id="size_w" type="number" class="wholenumber number_10000s" min="40" value="600" step="2" onchange="process_sankey();"></span>
<span class="no_wrap"><label for="size_h" class="spaced_label" title="Diagram Height in pixels"><strong>Height:</strong></label>
<input id="size_h" type="number" class="wholenumber number_10000s" min="40" value="600" step="2" onchange="process_sankey();"></span>

<label for="bg_color" class="spaced_label"><strong>Background Color:</strong></label>
<input type="color" id="bg_color" size="7" maxlength="7" value="#FFFFFF" onchange="process_sankey();">
<input type="checkbox" id="bg_transparent" value="1" onchange="process_sankey();" class="spaced_checkbox"><label for="bg_transparent" class="ropt">Transparent</label><br>
</p>

<p class="form_elements2">
<strong>Margins:</strong>
<span class="no_wrap"><label for="margin_l" class="spaced_label">Left</label>
<input id="margin_l" type="number" class="wholenumber number_100s" min="0" value="12" step="1" onchange="process_sankey();">
<label for="margin_r">Right</label>
<input id="margin_r" type="number" class="wholenumber number_100s" min="0" value="12" step="1" onchange="process_sankey();"></span>
<span class="no_wrap"><label for="margin_t" class="spaced_label">Top</label>
<input id="margin_t" type="number" class="wholenumber number_100s" min="0" value="18" step="1" onchange="process_sankey();">
<label for="margin_b">Bot</label>
<input id="margin_b" type="number" class="wholenumber number_100s" min="0" value="20" step="1" onchange="process_sankey();"></span>
</p>
</div>
</div>

<!-- EXPORT -->
<div class="expandable_box">
<p id="download_central" class="form_box">
<strong>Export:</strong> Save as:
<button id="save_as_png_2x" type="submit" title="PNG image file: 2400 x 2000" onclick="saveDiagramAsPNG(2); return false;"><strong>.PNG image</strong></button>
<span class="toggleable" onclick="togglePanel(&#39;png_size_options&#39;);" title="Select to choose another resolution">
<span id="png_size_options_indicator" class="indicator1">+</span>
<small>more</small><span id="png_size_options_hint">...</span></span>
<span id="png_size_options" style="display: none;">
<button id="save_as_png_4x" type="submit" title="PNG image file: 4800 x 4000" onclick="saveDiagramAsPNG(4); return false;"><strong>Large</strong> (4x)</button>
<button id="save_as_png_6x" type="submit" title="PNG image file: 7200 x 6000" onclick="saveDiagramAsPNG(6); return false;"><strong>Huge</strong> (6x)</button>
<button id="save_as_png_1x" type="submit" title="PNG image file: 1200 x 1000" onclick="saveDiagramAsPNG(1); return false;"><strong>Tiny</strong> (1x)</button>
</span>
<span style="padding-left: 0.4em; padding-right: 0.4em;">or</span>
<button id="save_as_svg" type="submit" title="Save this diagram as a Scalable Vector Graphics file" onclick="saveDiagramAsSVG(); return false;"><strong>Download .SVG</strong></button>
</p>
</div>

<!-- MOVING NODES -->
<p id="reset_moves_area" class="form_elements1">
Move Nodes by <em>dragging</em>. Double-click a Node to reset, or: <button type="button" id="reset_all_moved_nodes" onclick="resetMovesAndRender(); return false;" disabled="">Reset all moved Nodes</button>
</p>
<div id="top_messages_container">
  <div id="info_messages"></div>
  <div id="issue_messages"></div>
</div>

<p id="chart" style="height: 1000px; width: 1200px;">
<svg id="svg_scratch" height="1000" width="1200" xmlns="http://www.w3.org/2000/svg" class="hidden_under" text-anchor="middle" opacity="0" font-family="sans-serif" font-size="16px" font-weight="400"><text id="bb_em" x="600" y="500">m</text><text id="bb_ex" x="600" y="500">x</text><text id="bb_undefined" x="600" y="500">Vanderbilt: 10,000.0</text></svg>
<svg id="sankey_svg" height="1000" width="1200" xmlns="http://www.w3.org/2000/svg" class="svg_background_default"><rect height="1000" width="1200" fill="#ffffff"></rect><g transform="translate(165.40128906249998,18)"><g id="sankey_flows"><path id="flow1" d="M9 342.11607C131.19984 342.11607 131.19984 308.50566 253.39968 308.50566" fill="none" stroke-width="243.75" stroke="#ff7f0e" opacity="0.45"><title>Vanderbilt → Electricity: 5,000.0</title></path><path id="flow2" d="M9 585.86607C131.19984 585.86607 131.19984 619.47649 253.39968 619.47649" fill="none" stroke-width="146.25" stroke="#2ca02c" opacity="0.45"><title>Vanderbilt → Landfill: 3,000.0</title></path><path id="flow6" d="M262.39968 247.56816C384.59952 247.56816 384.59952 183.61491 506.79936 183.61491" fill="none" stroke-width="121.875" stroke="#e377c2" opacity="0.45"><title>Electricity → Purchased Energy: 2,500.0</title></path><path id="flow22" d="M515.79936 533.99599C637.99919 533.99599 637.99919 597.97083 760.19903 597.97083" fill="none" stroke-width="106.03125" stroke="#e377c2" opacity="0.45"><title>Dining → Food Consumption: 2,175.0</title></path><path id="flow10" d="M262.39968 590.22649C384.59952 590.22649 384.59952 504.13661 506.79936 504.13661" fill="none" stroke-width="87.75" stroke="#8c564b" opacity="0.45"><title>Landfill → Dining: 1,800.0</title></path><path id="flow15" d="M515.79936 201.89616C637.99919 201.89616 637.99919 148.02604 760.19903 148.02604" fill="none" stroke-width="85.3125" stroke="#17becf" opacity="0.45"><title>Purchased Energy → Fossil-Fuel Dependent: 1,750.0</title></path><path id="flow28" d="M769.19903 148.02604C891.39887 148.02604 891.39887 291.77984 1013.59871 291.77984" fill="none" stroke-width="85.3125" stroke="#ff7f0e" opacity="0.45"><title>Fossil-Fuel Dependent → University Control: 1,750.0</title></path><path id="flow20" d="M515.79936 417.36161C637.99919 417.36161 637.99919 266.70521 760.19903 266.70521" fill="none" stroke-width="84.825" stroke="#9467bd" opacity="0.45"><title>Dining → Cooking: 1,740.0</title></path><path id="flow37" d="M769.19903 266.70521C891.39887 266.70521 891.39887 376.84859 1013.59871 376.84859" fill="none" stroke-width="84.825" stroke="#ff7f0e" opacity="0.45"><title>Cooking → University Control: 1,740.0</title></path><path id="flow40" d="M769.19903 614.42396C891.39887 614.42396 891.39887 666.39651 1013.59871 666.39651" fill="none" stroke-width="73.125" stroke="#2ca02c" opacity="0.45"><title>Food Consumption → Individual Action: 1,500.0</title></path><path id="flow26" d="M515.79936 655.96578C637.99919 655.96578 637.99919 719.94062 760.19903 719.94062" fill="none" stroke-width="70.6875" stroke="#1f77b4" opacity="0.45"><title>Buildings → Construction: 1,450.0</title></path><path id="flow47" d="M769.19903 718.72187C891.39887 718.72187 891.39887 512.12984 1013.59871 512.12984" fill="none" stroke-width="68.25" stroke="#ff7f0e" opacity="0.45"><title>Construction → University Control: 1,400.0</title></path><path id="flow8" d="M262.39968 351.16191C384.59952 351.16191 384.59952 405.41786 506.79936 405.41786" fill="none" stroke-width="60.9375" stroke="#8c564b" opacity="0.45"><title>Electricity → Dining: 1,250.0</title></path><path id="flow11" d="M262.39968 663.35149C384.59952 663.35149 384.59952 722.99703 506.79936 722.99703" fill="none" stroke-width="58.5" stroke="#9467bd" opacity="0.45"><title>Landfill → Buildings: 1,200.0</title></path><path id="flow0" d="M9 463.99107v48.75L253.39968 512.74107v-48.75z" fill="#1f77b4" stroke-width="0.5" stroke="#1f77b4" opacity="0.45"><title>Vanderbilt → Water: 1,000.0</title></path><path id="flow3" d="M9 683.36607C131.19984 683.36607 131.19984 750.58691 253.39968 750.58691" fill="none" stroke-width="48.75" stroke="#d62728" opacity="0.45"><title>Vanderbilt → Compost/Recycling: 1,000.0</title></path><path id="flow9" d="M262.39968 406.00566C384.59952 406.00566 384.59952 644.99703 506.79936 644.99703" fill="none" stroke-width="48.75" stroke="#9467bd" opacity="0.45"><title>Electricity → Buildings: 1,000.0</title></path><path id="flow25" d="M515.79936 740.79078C637.99919 740.79078 637.99919 905.59687 760.19903 905.59687" fill="none" stroke-width="42.4125" stroke="#17becf" opacity="0.45"><title>Buildings → HVAC: 870.0</title></path><path id="flow12" d="M262.39968 745.71191C384.59952 745.71191 384.59952 567.51161 506.79936 567.51161" fill="none" stroke-width="39" stroke="#8c564b" opacity="0.45"><title>Compost/Recycling → Dining: 800.0</title></path><path id="flow14" d="M515.79936 140.95866C637.99919 140.95866 637.99919 53.47813 760.19903 53.47813" fill="none" stroke-width="36.5625" stroke="#bcbd22" opacity="0.45"><title>Purchased Energy → Renewable Energy: 750.0</title></path><path id="flow27" d="M769.19903 53.47813C891.39887 53.47813 891.39887 230.84234 1013.59871 230.84234" fill="none" stroke-width="36.5625" stroke="#ff7f0e" opacity="0.45"><title>Renewable Energy → University Control: 750.0</title></path><path id="flow39" d="M769.19903 561.40833C891.39887 561.40833 891.39887 461.55172 1013.59871 461.55172" fill="none" stroke-width="32.90625" stroke="#ff7f0e" opacity="0.45"><title>Food Consumption → University Control: 675.0</title></path><path id="flow4" d="M262.39968 500.55357C384.59952 500.55357 384.59952 681.55953 506.79936 681.55953" fill="none" stroke-width="24.375" stroke="#9467bd" opacity="0.45"><title>Water → Buildings: 500.0</title></path><path id="flow5" d="M262.39968 476.17857C384.59952 476.17857 384.59952 448.07411 506.79936 448.07411" fill="none" stroke-width="24.375" stroke="#8c564b" opacity="0.45"><title>Water → Dining: 500.0</title></path><path id="flow45" d="M769.19903 895.84687C891.39887 895.84687 891.39887 577.21109 1013.59871 577.21109" fill="none" stroke-width="22.9125" stroke="#ff7f0e" opacity="0.45"><title>HVAC → University Control: 470.0</title></path><path id="flow21" d="M515.79936 470.37724C637.99919 470.37724 637.99919 394.25417 760.19903 394.25417" fill="none" stroke-width="21.20625" stroke="#8c564b" opacity="0.45"><title>Dining → Dishes: 435.0</title></path><path id="flow38" d="M769.19903 394.25417C891.39887 394.25417 891.39887 433.52047 1013.59871 433.52047" fill="none" stroke-width="21.20625" stroke="#ff7f0e" opacity="0.45"><title>Dishes → University Control: 435.0</title></path><path id="flow46" d="M769.19903 917.05313C891.39887 917.05313 891.39887 723.92151 1013.59871 723.92151" fill="none" stroke-width="19.5" stroke="#2ca02c" opacity="0.45"><title>HVAC → Individual Action: 400.0</title></path><path id="flow23" d="M515.79936 698.37828C637.99919 698.37828 637.99919 795.96354 760.19903 795.96354" fill="none" stroke-width="14.1375" stroke="#7f7f7f" opacity="0.45"><title>Buildings → Plumbing: 290.0</title></path><path id="flow24" d="M515.79936 712.51578C637.99919 712.51578 637.99919 843.71146 760.19903 843.71146" fill="none" stroke-width="14.1375" stroke="#bcbd22" opacity="0.725"><title>Buildings → Lighting: 290.0</title></path><path id="flow7" d="M262.39968 314.59941C384.59952 314.59941 384.59952 335.24495 506.79936 335.24495" fill="none" stroke-width="12.1875" stroke="#7f7f7f" opacity="0.45"><title>Electricity → Transportation: 250.0</title></path><path id="flow13" d="M262.39968 770.08691C384.59952 770.08691 384.59952 757.12203 506.79936 757.12203" fill="none" stroke-width="9.75" stroke="#9467bd" opacity="0.45"><title>Compost/Recycling → Buildings: 200.0</title></path><path id="flow41" d="M769.19903 793.76979C891.39887 793.76979 891.39887 551.12984 1013.59871 551.12984" fill="none" stroke-width="9.75" stroke="#ff7f0e" opacity="0.45"><title>Plumbing → University Control: 200.0</title></path><path id="flow43" d="M769.19903 841.51771C891.39887 841.51771 891.39887 560.87984 1013.59871 560.87984" fill="none" stroke-width="9.75" stroke="#ff7f0e" opacity="0.45"><title>Lighting → University Control: 200.0</title></path><path id="flow16" d="M515.79936 332.80745C637.99919 332.80745 637.99919 346.38437 760.19903 346.38437" fill="none" stroke-width="7.3125" stroke="#1f77b4" opacity="0.45"><title>Transportation → Air Travel: 150.0</title></path><path id="flow42" d="M769.19903 800.83854C891.39887 800.83854 891.39887 707.59026 1013.59871 707.59026" fill="none" stroke-width="4.3875" stroke="#2ca02c" opacity="0.45"><title>Plumbing → Individual Action: 90.0</title></path><path id="flow44" d="M769.19903 848.58646C891.39887 848.58646 891.39887 711.97776 1013.59871 711.97776" fill="none" stroke-width="4.3875" stroke="#2ca02c" opacity="0.45"><title>Lighting → Individual Action: 90.0</title></path><path id="flow17" d="M515.79936 338.29182C637.99919 338.29182 637.99919 440.29583 760.19903 440.29583" fill="none" stroke-width="3.65625" stroke="#ff7f0e" opacity="0.45"><title>Transportation → Car: 75.0</title></path><path id="flow29" d="M769.19903 344.55625C891.39887 344.55625 891.39887 421.08922 1013.59871 421.08922" fill="none" stroke-width="3.65625" stroke="#ff7f0e" opacity="0.45"><title>Air Travel → University Control: 75.0</title></path><path id="flow30" d="M769.19903 348.2125C891.39887 348.2125 891.39887 624.10589 1013.59871 624.10589" fill="none" stroke-width="3.65625" stroke="#2ca02c" opacity="0.45"><title>Air Travel → Individual Action: 75.0</title></path><path id="flow32" d="M769.19903 440.66146C891.39887 440.66146 891.39887 627.39651 1013.59871 627.39651" fill="none" stroke-width="2.925" stroke="#2ca02c" opacity="0.45"><title>Car → Individual Action: 60.0</title></path><path id="flow48" d="M769.19903 754.06562C891.39887 754.06562 891.39887 704.17776 1013.59871 704.17776" fill="none" stroke-width="2.4375" stroke="#2ca02c" opacity="0.45"><title>Construction → Individual Action: 50.0</title></path><path id="flow31" d="M769.19903 438.83333C891.39887 438.83333 891.39887 444.48922 1013.59871 444.48922" fill="none" stroke-width="1" stroke="#ff7f0e" opacity="0.45"><title>Car → University Control: 15.0</title></path><path id="flow18" d="M515.79936 340.42463C637.99919 340.42463 637.99919 476.03906 760.19903 476.03906" fill="none" stroke-width="1" stroke="#2ca02c" opacity="0.45"><title>Transportation → Public Transit: 12.5</title></path><path id="flow19" d="M515.79936 341.03401C637.99919 341.03401 637.99919 510.64948 760.19903 510.64948" fill="none" stroke-width="1" stroke="#d62728" opacity="0.45"><title>Transportation → Bike/Scooter/Walk: 12.5</title></path><path id="flow34" d="M769.19903 476.1C891.39887 476.1 891.39887 629.10276 1013.59871 629.10276" fill="none" stroke-width="1" stroke="#2ca02c" opacity="0.45"><title>Public Transit → Individual Action: 10.0</title></path><path id="flow36" d="M769.19903 510.71042C891.39887 510.71042 891.39887 629.59026 1013.59871 629.59026" fill="none" stroke-width="1" stroke="#2ca02c" opacity="0.45"><title>Bike/Scooter/Walk → Individual Action: 10.0</title></path><path id="flow33" d="M769.19903 475.79531C891.39887 475.79531 891.39887 444.91578 1013.59871 444.91578" fill="none" stroke-width="1" stroke="#ff7f0e" opacity="0.45"><title>Public Transit → University Control: 2.5</title></path><path id="flow35" d="M769.19903 510.40573C891.39887 510.40573 891.39887 445.03766 1013.59871 445.03766" fill="none" stroke-width="1" stroke="#ff7f0e" opacity="0.45"><title>Bike/Scooter/Walk → University Control: 2.5</title></path></g><g id="sankey_nodes"><g class="node"><rect id="r0" class="for_r0" x="0" y="220.24107" height="487.5" width="9" fill="#17becf" fill-opacity="1"><title>Vanderbilt:
10,000.0</title></rect></g><g class="node"><rect id="r1" class="for_r1" x="253.39968" y="463.99107" height="48.75" width="9" fill="#1f77b4" fill-opacity="1"><title>Water:
1,000.0</title></rect></g><g class="node"><rect id="r2" class="for_r2" x="253.39968" y="186.63066" height="243.75" width="9" fill="#ff7f0e" fill-opacity="1"><title>Electricity:
5,000.0</title></rect></g><g class="node"><rect id="r3" class="for_r3" x="253.39968" y="546.35149" height="146.25" width="9" fill="#2ca02c" fill-opacity="1"><title>Landfill:
3,000.0</title></rect></g><g class="node"><rect id="r4" class="for_r4" x="253.39968" y="726.21191" height="48.75" width="9" fill="#d62728" fill-opacity="1"><title>Compost/Recycling:
1,000.0</title></rect></g><g class="node"><rect id="r5" class="for_r5" x="506.79936" y="620.62203" height="141.375" width="9" fill="#9467bd" fill-opacity="1"><title>Buildings:
2,900.0</title></rect></g><g class="node"><rect id="r6" class="for_r6" x="506.79936" y="374.94911" height="212.0625" width="9" fill="#8c564b" fill-opacity="1"><title>Dining:
4,350.0</title></rect></g><g class="node"><rect id="r7" class="for_r7" x="506.79936" y="122.67741" height="121.875" width="9" fill="#e377c2" fill-opacity="1"><title>Purchased Energy:
2,500.0</title></rect></g><g class="node"><rect id="r8" class="for_r8" x="506.79936" y="329.1512" height="12.1875" width="9" fill="#7f7f7f" fill-opacity="1"><title>Transportation:
250.0</title></rect></g><g class="node"><rect id="r9" class="for_r9" x="760.19903" y="35.19688" height="36.5625" width="9" fill="#bcbd22" fill-opacity="1"><title>Renewable Energy:
750.0</title></rect></g><g class="node"><rect id="r10" class="for_r10" x="760.19903" y="105.36979" height="85.3125" width="9" fill="#17becf" fill-opacity="1"><title>Fossil-Fuel Dependent:
1,750.0</title></rect></g><g class="node"><rect id="r11" class="for_r11" x="760.19903" y="342.72812" height="7.3125" width="9" fill="#1f77b4" fill-opacity="1"><title>Air Travel:
150.0</title></rect></g><g class="node"><rect id="r12" class="for_r12" x="760.19903" y="438.46771" height="3.65625" width="9" fill="#ff7f0e" fill-opacity="1"><title>Car:
75.0</title></rect></g><g class="node"><rect id="r13" class="for_r13" x="760.19903" y="475.73437" height="1" width="9" fill="#2ca02c" fill-opacity="1"><title>Public Transit:
12.5</title></rect></g><g class="node"><rect id="r14" class="for_r14" x="760.19903" y="510.34479" height="1" width="9" fill="#d62728" fill-opacity="1"><title>Bike/Scooter/Walk:
12.5</title></rect></g><g class="node"><rect id="r15" class="for_r15" x="760.19903" y="224.29271" height="84.825" width="9" fill="#9467bd" fill-opacity="1"><title>Cooking:
1,740.0</title></rect></g><g class="node"><rect id="r16" class="for_r16" x="760.19903" y="383.65104" height="21.20625" width="9" fill="#8c564b" fill-opacity="1"><title>Dishes:
435.0</title></rect></g><g class="node"><rect id="r17" class="for_r17" x="760.19903" y="544.95521" height="106.03125" width="9" fill="#e377c2" fill-opacity="1"><title>Food Consumption:
2,175.0</title></rect></g><g class="node"><rect id="r18" class="for_r18" x="760.19903" y="788.89479" height="14.1375" width="9" fill="#7f7f7f" fill-opacity="1"><title>Plumbing:
290.0</title></rect></g><g class="node"><rect id="r19" class="for_r19" x="760.19903" y="836.64271" height="14.1375" width="9" fill="#bcbd22" fill-opacity="1"><title>Lighting:
290.0</title></rect></g><g class="node"><rect id="r20" class="for_r20" x="760.19903" y="884.39063" height="42.4125" width="9" fill="#17becf" fill-opacity="1"><title>HVAC:
870.0</title></rect></g><g class="node"><rect id="r21" class="for_r21" x="760.19903" y="684.59687" height="70.6875" width="9" fill="#1f77b4" fill-opacity="1"><title>Construction:
1,450.0</title></rect></g><g class="node"><rect id="r22" class="for_r22" x="1013.59871" y="212.56109" height="376.10625" width="9" fill="#ff7f0e" fill-opacity="1"><title>University Control:
7,715.0</title></rect></g><g class="node"><rect id="r23" class="for_r23" x="1013.59871" y="622.27776" height="111.39375" width="9" fill="#2ca02c" fill-opacity="1"><title>Individual Action:
2,285.0</title></rect></g></g><g id="sankey_labels" font-family="sans-serif" font-size="16px" font-weight="400" fill="#000000"><text text-anchor="middle" x="434.5987109375" y="977" font-size="11px" font-weight="400" fill="rgb(127, 127, 127)">Made with SankeyMATIC</text><rect id="label0_bg" class="for_r0" x="-153.4013" y="451.95605" width="151.76859" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label0" class="for_r0" text-anchor="end" x="-6.29754" y="463.99107" dy="5.364999999999999">Vanderbilt: 10,000.0</text><rect id="label1_bg" class="for_r1" x="137.67808" y="476.33105" width="114.08891" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label1" class="for_r1" text-anchor="end" x="247.10214" y="488.36607" dy="5.364999999999999">Water: 1,000.0</text><rect id="label2_bg" class="for_r2" x="111.31089" y="296.47064" width="140.45609" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label2" class="for_r2" text-anchor="end" x="247.10214" y="308.50566" dy="5.364999999999999">Electricity: 5,000.0</text><rect id="label3_bg" class="for_r3" x="129.06089" y="607.44149" width="122.70609" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label3" class="for_r3" text-anchor="end" x="247.10214" y="619.47649" dy="5.364999999999999">Landfill: 3,000.0</text><rect id="label4_bg" class="for_r4" x="41.93589" y="738.5519" width="209.83109" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label4" class="for_r4" text-anchor="end" x="247.10214" y="750.58691" dy="5.364999999999999">Compost/Recycling: 1,000.0</text><rect id="label5_bg" class="for_r5" x="368.23402" y="679.2745" width="136.93266" height="23.33906" rx="4" fill="#ffb" fill-opacity="0.84933" stroke="#440" stroke-width="1" stroke-opacity="0.7"></rect><text id="label5" class="for_r5" text-anchor="end" x="500.50182" y="691.30953" dy="5.364999999999999">Buildings: 2,900.0</text><rect id="label6_bg" class="for_r6" x="387.80433" y="468.94534" width="117.36234" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label6" class="for_r6" text-anchor="end" x="500.50182" y="480.98036" dy="5.364999999999999">Dining: 4,350.0</text><rect id="label7_bg" class="for_r7" x="301.53089" y="171.57992" width="203.63578" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label7" class="for_r7" text-anchor="end" x="500.50182" y="183.61491" dy="5.364999999999999">Purchased Energy: 2,500.0</text><rect id="label8_bg" class="for_r8" x="343.92933" y="323.20995" width="161.23734" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label8" class="for_r8" text-anchor="end" x="500.50182" y="335.24495" dy="5.364999999999999">Transportation: 250.0</text><rect id="label9_bg" class="for_r9" x="564.7118" y="41.44313" width="193.85453" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label9" class="for_r9" text-anchor="end" x="753.90149" y="53.47813" dy="5.364999999999999">Renewable Energy: 750.0</text><rect id="label10_bg" class="for_r10" x="525.59461" y="135.99105" width="232.97172" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label10" class="for_r10" text-anchor="end" x="753.90149" y="148.02604" dy="5.364999999999999">Fossil-Fuel Dependent: 1,750.0</text><rect id="label11_bg" class="for_r11" x="632.32118" y="334.34936" width="126.24516" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label11" class="for_r11" text-anchor="end" x="753.90149" y="346.38437" dy="5.364999999999999">Air Travel: 150.0</text><rect id="label12_bg" class="for_r12" x="683.0243" y="428.26083" width="75.54203" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label12" class="for_r12" text-anchor="end" x="753.90149" y="440.29583" dy="5.364999999999999">Car: 75.0</text><rect id="label13_bg" class="for_r13" x="612.75086" y="464.19937" width="145.81547" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label13" class="for_r13" text-anchor="end" x="753.90149" y="476.23437" dy="5.364999999999999">Public Transit: 12.5</text><rect id="label14_bg" class="for_r14" x="578.68055" y="498.80978" width="179.88578" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label14" class="for_r14" text-anchor="end" x="753.90149" y="510.84479" dy="5.364999999999999">Bike/Scooter/Walk: 12.5</text><rect id="label15_bg" class="for_r15" x="627.86024" y="254.67019" width="130.70609" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label15" class="for_r15" text-anchor="end" x="753.90149" y="266.70521" dy="5.364999999999999">Cooking: 1,740.0</text><rect id="label16_bg" class="for_r16" x="651.00086" y="382.21917" width="107.56547" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label16" class="for_r16" text-anchor="end" x="753.90149" y="394.25417" dy="5.364999999999999">Dishes: 435.0</text><rect id="label17_bg" class="for_r17" x="551.37586" y="585.93582" width="207.19047" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label17" class="for_r17" text-anchor="end" x="753.90149" y="597.97083" dy="5.364999999999999">Food Consumption: 2,175.0</text><rect id="label18_bg" class="for_r18" x="633.20399" y="783.92855" width="125.36234" height="23.33906" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label18" class="for_r18" text-anchor="end" x="753.90149" y="795.96354" dy="5.364999999999999">Plumbing: 290.0</text><rect id="label19_bg" class="for_r19" x="643.86024" y="831.67648" width="114.70609" height="23.33906" rx="4" fill="#ffb" fill-opacity="0.84933" stroke="#440" stroke-width="1" stroke-opacity="0.7"></rect><text id="label19" class="for_r19" text-anchor="end" x="753.90149" y="843.71146" dy="5.364999999999999">Lighting: 290.0</text><rect id="label20_bg" class="for_r20" x="656.63368" y="893.56185" width="101.93266" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label20" class="for_r20" text-anchor="end" x="753.90149" y="905.59687" dy="5.364999999999999">HVAC: 870.0</text><rect id="label21_bg" class="for_r21" x="596.74305" y="707.9056" width="161.82328" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label21" class="for_r21" text-anchor="end" x="753.90149" y="719.94062" dy="5.364999999999999">Construction: 1,450.0</text><rect id="label22_bg" class="for_r22" x="813.70521" y="388.57922" width="198.26078" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label22" class="for_r22" text-anchor="end" x="1007.30117" y="400.61422" dy="5.364999999999999">University Control: 7,715.0</text><rect id="label23_bg" class="for_r23" x="824.3224" y="665.93966" width="187.64359" height="23.3" rx="4" fill="#fff" fill-opacity="0.55" stroke="none" stroke-width="0" stroke-opacity="0"></rect><text id="label23" class="for_r23" text-anchor="end" x="1007.30117" y="677.97464" dy="5.364999999999999">Individual Action: 2,285.0</text></g></g></svg>
</p>
<canvas id="png_preview" height="600" width="600" style="background-color: transparent; display: none;"></canvas>
<div id="chartfooter">
<p class="form_elements1 center_content">
<input type="checkbox" id="meta_mentionsankeymatic" value="1" onchange="process_sankey();" checked="">
<label class="smalllabel ropt" for="meta_mentionsankeymatic">Include “Made with SankeyMATIC”</label>
</p>
</div>
<table id="messages" class="expandable_box">
<tbody><tr><td>
  <div id="messages_area">
    <h4>About this diagram</h4>
    <div id="totals_area"><div><strong>49 Flows</strong> between <strong>24 Nodes</strong>. Total Inputs = Total Outputs = <strong>10,000.0</strong> ✅</div></div>
  </div>
</td></tr>
<tr><td id="imbalances_area" aria-disabled="true">
<div id="imbalance_control">
<span class="underline"><strong><em>When Total Inputs ≠ Total Outputs:</em></strong></span><br>
<p class="form_elements3">
  Attach incomplete flow groups to:<br>
<span><input name="layout_attachincompletesto" id="layout_attachto_leading" value="leading" type="radio" onchange="process_sankey();" disabled=""><label for="layout_attachto_leading" class="ropt">The leading edge of the Node</label></span><br>
<span><input name="layout_attachincompletesto" id="layout_attachto_trailing" value="trailing" type="radio" onchange="process_sankey();" disabled=""><label for="layout_attachto_trailing" class="ropt">The trailing edge of the Node</label></span><br>
<span><input name="layout_attachincompletesto" id="layout_attachto_nearest" value="nearest" type="radio" onchange="process_sankey();" checked="checked" disabled=""><label for="layout_attachto_nearest" class="ropt">The edge nearest to the flow group's center</label></span>
</p>
<p class="lastrow">
<input type="checkbox" id="meta_listimbalances" value="1" onchange="process_sankey();" checked="checked" disabled="">
<label class="ropt" for="meta_listimbalances">List all imbalanced Nodes</label>
</p>
<div id="imbalance_messages"></div>
</div>
</td></tr>
</tbody></table>
</td></tr></tbody></table>
</form>

</div>
<!-- ====================== Bottom Matter ====================== -->

</main>

<hr class="ad_divider">
<div class="ad_center">
<script async="" src="./SankeyMATIC_ Build a Sankey Diagram_files/f.txt" crossorigin="anonymous"></script>
<!-- SKM 90h -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3811177942013776" data-ad-slot="9379103907" data-ad-format="auto"></ins>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>


<div class="callout_container">
<span class="callout">
If you find SankeyMATIC useful, please consider <a href="https://sankeymatic.com/about/" target="_blank">donating to support further development</a>. Thanks!</span>
</div>

<footer>

<nav id="footer_nav" class="main_nav_behavior">
  <input id="footer_nav_checkbox" class="main_nav_checkbox" type="checkbox" checked="checked">
  <!-- [MENU ITEMS] -->
  <div id="footer_nav_items" class="main_nav_items">
<ul>
  <li><a title="SankeyMATIC home page" href="https://sankeymatic.com/"><img alt="SankeyMATIC logo" src="./SankeyMATIC_ Build a Sankey Diagram_files/SKM-trsp-300.png" height="27" width="27" class="skm_logo_small">&nbsp;<strong>SankeyMATIC</strong>&nbsp;Home</a></li>
  <li><a title="Build a Sankey Diagram" href="https://sankeymatic.com/build/">Build a Sankey Diagram</a></li>
  <li><a title="How to use SankeyMATIC to the fullest" href="https://sankeymatic.com/manual/">Manual</a></li>
  <li><a title="What&#39;s New with SankeyMATIC&#39;" href="https://sankeymatic.com/news/">News</a></li>
  <li><a title="Gallery of Sankey Examples" href="https://sankeymatic.com/gallery/">Gallery</a></li>
  <li><a title="About SankeyMATIC and how to support the site" href="https://sankeymatic.com/about/">About/Donate</a></li>
</ul>
  </div>
</nav>

<p>
<strong>SankeyMATIC</strong> (<a rel="me" href="https://vis.social/@SankeyMATIC" target="_blank">@SankeyMATIC@vis.social</a>) is produced by
<a href="http://nowthis.com/" target="_blank">Steve Bogart</a>
(<a href="https://tilde.zone/@nowthis" target="_blank">@nowthis@tilde.zone</a>).<br>
Source code is available at <a href="https://github.com/nowthis/sankeymatic" target="_blank">GitHub</a>.
</p>
</footer>



<div>

<style>
    #videoTogetherLoading {
        touch-action: none;
        height: 50px;
        border: 1px solid #c9c8c8;
        background: #ffffff;
        color: #212529;
        display: flex;
        align-items: center;
        z-index: 2147483646;
        position: fixed;
        bottom: 15px;
        right: 15px;
        width: 250px;
        text-align: center;
        box-shadow: 0 3px 6px -4px #0000001f, 0 6px 16px #00000014, 0 9px 28px 8px #0000000d;
        border-radius: 5px;
    }
    #videoTogetherLoadingwrap {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #videoTogetherLoadingwrap img {
        margin-right: 12px;
    }
    #videoTogetherLoadingwrap a {
        color: #212529;
        text-decoration: none;
    }
    #videoTogetherLoadingwrap a:hover {
        color: #1890ff;
        text-decoration: underline;
    }
</style>
</div><script type="text/javascript" src="chrome-extension://dpjiaamadbcfheiamdaamhgpomlkohbn/load.en-us.js" cachedvt="// ==UserScript==
// @name         Video Together 一起看视频
// @namespace    https://2gether.video/
// @version      1696582274
// @description  Watch video together 一起看视频
// @author       maggch@outlook.com
// @match        *://*/*
// @icon         https://2gether.video/icon/favicon-32x32.png
// @grant        none
// ==/UserScript==

(function () {
    const language = &#39;en-us&#39;
    const vtRuntime = `extension`;
    const realUrlCache = {}
    const m3u8ContentCache = {}

    let inDownload = false;
    let isDownloading = false;

    let roomUuid = null;

    const lastRunQueue = []
    // request can only be called up to 10 times in 5 seconds
    const periodSec = 5;
    const timeLimitation = 15;

    function getDurationStr(duration) {
        try {
            let d = parseInt(duration);
            let str = &quot;&quot;
            let units = [&quot; Sec &quot;, &quot; Min &quot;, &quot; Hr &quot;]
            for (let i in units) {
                if (d &gt; 0) {
                    str = d % 60 + units[i] + str;
                }
                d = Math.floor(d / 60)
            }
            return str;
        } catch {
            return &quot;N/A&quot;
        }
    }

    function downloadEnabled() {
        try {
            if (window.VideoTogetherDownload == &#39;disabled&#39;) {
                return false;
            }
            const type = VideoTogetherStorage.UserscriptType
            return parseInt(window.VideoTogetherStorage.LoaddingVersion) &gt;= 1694758378
                &amp;&amp; (type == &quot;Chrome&quot; || type == &quot;Safari&quot; || type == &quot;Firefox&quot;)
                &amp;&amp; !isDownloadBlackListDomain()
        } catch {
            return false;
        }
    }

    function isM3U8(textContent) {
        return textContent.trim().startsWith(&#39;#EXTM3U&#39;);
    }
    function isMasterM3u8(textContent) {
        return textContent.includes(&#39;#EXT-X-STREAM-INF:&#39;);
    }

    function getFirstMediaM3U8(m3u8Content, m3u8Url) {
        if (!isMasterM3u8(m3u8Content)) {
            return null;
        }
        const lines = m3u8Content.split(&#39;\n&#39;);

        for (const line of lines) {
            const trimmedLine = line.trim();
            if (trimmedLine &amp;&amp; !trimmedLine.startsWith(&#39;#&#39;) &amp;&amp; trimmedLine != &quot;&quot;) {
                return new URL(trimmedLine, m3u8Url);
            }
        }
        return null;
    }

    function startDownload(_vtArgM3u8Url, _vtArgM3u8Content, _vtArgM3u8Urls, _vtArgTitle, _vtArgPageUrl) {
        /*//*/
(async function () {

    function extractExtXKeyUrls(m3u8Content, baseUrl) {
        const uris = [];
        const lines = m3u8Content.split(&#39;\n&#39;);

        for (let i = 0; i &lt; lines.length; i++) {
            const line = lines[i].trim();

            if (line.startsWith(&#39;#EXT-X-&#39;)) {
                const match = line.match(/URI=&quot;(.*?)&quot;/);

                if (match &amp;&amp; match[1]) {
                    let uri = match[1];

                    // Ignore data: URIs as they don&#39;t need to be downloaded
                    if (uri.startsWith(&#39;data:&#39;)) {
                        continue;
                    }

                    // If the URI is not absolute, make it so by combining with the base URL.
                    if (!uri.startsWith(&#39;http://&#39;) &amp;&amp; !uri.startsWith(&#39;https://&#39;)) {
                        uri = new URL(uri, baseUrl).href;
                    }

                    uris.push(uri);
                }
            }
        }

        return uris;
    }

    async function timeoutAsyncRead(reader, timeout) {
        const timer = new Promise((_, rej) =&gt; {
            const id = setTimeout(() =&gt; {
                reader.cancel();
                rej(new Error(&#39;Stream read timed out&#39;));
            }, timeout);
        });

        return Promise.race([
            reader.read(),
            timer
        ]);
    }

    function generateUUID() {
        if (crypto.randomUUID != undefined) {
            return crypto.randomUUID();
        }
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =&gt;
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] &amp; 15 &gt;&gt; c / 4).toString(16)
        );
    }

    window.updateM3u8Status = async function updateM3u8Status(m3u8Url, status) {
        // 0 downloading  1 completed 2 deleting
        let m3u8mini = await readFromIndexedDB(&#39;m3u8s-mini&#39;, m3u8Url);
        m3u8mini.status = status
        await saveToIndexedDB(&#39;m3u8s-mini&#39;, m3u8Url, m3u8mini);
    }

    async function saveM3u8(m3u8Url, m3u8Content) {
        await saveToIndexedDB(&#39;m3u8s&#39;, m3u8Url,
            {
                data: m3u8Content,
                title: vtArgTitle,
                pageUrl: vtArgPageUrl,
                m3u8Url: m3u8Url,
                m3u8Id: m3u8Id,
                status: 0
            }
        )

    }

    async function blobToDataUrl(blob) {
        return new Promise((resolve, reject) =&gt; {
            const reader = new FileReader();
            reader.onload = function (event) {
                resolve(event.target.result);
            };
            reader.onerror = function (event) {
                reject(new Error(&quot;Failed to read blob&quot;));
            };
            reader.readAsDataURL(blob);
        });
    }

    async function saveBlob(table, url, blob) {
        return new Promise(async (res, rej) =&gt; {
            try {
                const dataUrl = await blobToDataUrl(blob);
                await saveToIndexedDB(table, url, {
                    data: dataUrl,
                    m3u8Url: downloadM3u8Url,
                    m3u8Id: m3u8Id,
                })
                res();
            } catch (e) {
                rej(e);
            }
        })
    }

    window.regexMatchKeys = function regexMatchKeys(table, regex) {
        const queryId = generateUUID()
        return new Promise((res, rej) =&gt; {
            window.postMessage({
                source: &quot;VideoTogether&quot;,
                type: 2005,
                data: {
                    table: table,
                    regex: regex,
                    id: queryId
                }
            }, &#39;*&#39;)
            regexCallback[queryId] = (data) =&gt; {
                try {
                    res(data)
                } catch { rej() }
            }
        })
    }

    saveToIndexedDBThreads = 1;
    window.saveToIndexedDB = async function saveToIndexedDB(table, key, data) {
        while (saveToIndexedDBThreads &lt; 1) {
            await new Promise(r =&gt; setTimeout(r, 100));
        }
        saveToIndexedDBThreads--;
        const queryId = generateUUID();
        return new Promise((res, rej) =&gt; {
            data.saveTime = Date.now()
            window.postMessage({
                source: &quot;VideoTogether&quot;,
                type: 2001,
                data: {
                    table: table,
                    key: key,
                    data: data,
                    id: queryId,
                }
            }, &#39;*&#39;)
            data = null;
            saveCallback[queryId] = (error) =&gt; {
                saveToIndexedDBThreads++;
                if (error === 0) {
                    res(0)
                } else {
                    rej(error)
                }
            }
        })
    }

    window.iosDeleteByPrefix = async function iosDeleteByPrefix(prefix) {
        const queryId = generateUUID();
        return new Promise((res, rej) =&gt; {
            window.postMessage({
                source: &quot;VideoTogether&quot;,
                type: 3010,
                data: {
                    prefix: prefix,
                    id: queryId,
                }
            }, &#39;*&#39;)
            deleteByPrefix[queryId] = (error) =&gt; {
                if (error === 0) {
                    res(0)
                } else {
                    rej(error)
                }
            }
        })
    }

    let readCallback = {}
    let regexCallback = {}
    let deleteCallback = {}
    let saveCallback = {}
    let deleteByPrefix = {}

    window.addEventListener(&#39;message&#39;, async e =&gt; {
        if (e.data.source == &quot;VideoTogether&quot;) {
            switch (e.data.type) {
                case 2003: {
                    saveCallback[e.data.data.id](e.data.data.error)
                    saveCallback[e.data.data.id] = undefined
                    break;
                }
                case 2004: {
                    readCallback[e.data.data.id](e.data.data.data)
                    readCallback[e.data.data.id] = undefined;
                    break;
                }
                case 2006: {
                    regexCallback[e.data.data.id](e.data.data.data)
                    regexCallback[e.data.data.id] = undefined;
                    break;
                }
                case 2008: {
                    deleteCallback[e.data.data.id](e.data.data.error);
                    deleteCallback[e.data.data.id] = undefined;
                    break;
                }
                case 3011: {
                    deleteByPrefix[e.data.data.id](e.data.data.error);
                    deleteByPrefix[e.data.data.id] = undefined;
                    break;
                }
                case 2010: {
                    console.log(e.data.data.data);
                    break;
                }
            }
        }
    })
    window.requestStorageEstimate = function requestStorageEstimate() {
        window.postMessage({
            source: &quot;VideoTogether&quot;,
            type: 2009,
            data: {}
        }, &#39;*&#39;)
    }
    window.deleteFromIndexedDB = function deleteFromIndexedDB(table, key) {
        const queryId = generateUUID()
        window.postMessage({
            source: &quot;VideoTogether&quot;,
            type: 2007,
            data: {
                id: queryId,
                table: table,
                key: key,
            }
        }, &#39;*&#39;)
        return new Promise((res, rej) =&gt; {
            deleteCallback[queryId] = (error) =&gt; {
                if (error === 0) {
                    res(true);
                } else {
                    rej(error);
                }
            }
        })
    }

    window.readFromIndexedDB = function readFromIndexedDB(table, key) {
        const queryId = generateUUID();

        window.postMessage({
            source: &quot;VideoTogether&quot;,
            type: 2002,
            data: {
                table: table,
                key: key,
                id: queryId,
            }
        }, &#39;*&#39;)
        return new Promise((res, rej) =&gt; {
            readCallback[queryId] = (data) =&gt; {
                try {
                    res(data);
                } catch {
                    rej()
                }
            }
        })
    }

    if (window.videoTogetherExtension === undefined) {
        return;
    }
    if (window.location.hostname == &#39;local.2gether.video&#39;) {
        return;
    }
    let vtArgM3u8Url = undefined;
    let vtArgM3u8Content = undefined;
    let vtArgM3u8Urls = undefined;
    let vtArgTitle = undefined;
    let vtArgPageUrl = undefined;
    try {
        vtArgM3u8Url = _vtArgM3u8Url;
        vtArgM3u8Content = _vtArgM3u8Content;
        vtArgM3u8Urls = _vtArgM3u8Urls;
        vtArgTitle = _vtArgTitle;
        vtArgPageUrl = _vtArgPageUrl;
    } catch {
        return;
    }

    const m3u8Id = generateUUID()
    const m3u8IdHead = `-m3u8Id-${m3u8Id}-end-`
    const downloadM3u8Url = vtArgM3u8Url;
    const numThreads = 10;
    let lastTotalBytes = 0;
    let totalBytes = 0;
    let failedUrls = []
    let urls = vtArgM3u8Urls
    let successCount = 0;
    videoTogetherExtension.downloadPercentage = 0;

    const m3u8Key = m3u8IdHead + downloadM3u8Url
    if (downloadM3u8Url === undefined) {
        return;
    }

    await saveM3u8(m3u8Key, vtArgM3u8Content)

    const otherUrl = extractExtXKeyUrls(vtArgM3u8Content, downloadM3u8Url);
    const totalCount = urls.length + otherUrl.length;

    console.log(otherUrl);

    await downloadInParallel(&#39;future&#39;, otherUrl, numThreads);

    setInterval(function () {
        videoTogetherExtension.downloadSpeedMb = (totalBytes - lastTotalBytes) / 1024 / 1024;
        lastTotalBytes = totalBytes;
    }, 1000);

    await downloadInParallel(&#39;videos&#39;, urls, numThreads);
    await updateM3u8Status(m3u8Key, 1)
    async function fetchWithSpeedTracking(url) {
        const controller = new AbortController();
        const timer = setTimeout(() =&gt; {
            controller.abort();
        }, 20000);

        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timer)
        if (!response.body) {
            throw new Error(&quot;ReadableStream not yet supported in this browser.&quot;);
        }

        const contentType = response.headers.get(&quot;Content-Type&quot;) || &quot;application/octet-stream&quot;;

        const reader = response.body.getReader();
        let chunks = [];

        async function readStream() {
            const { done, value } = await timeoutAsyncRead(reader, 60000);
            if (done) {
                return;
            }

            if (value) {
                chunks.push(value);
                totalBytes += value.length;
            }

            // Continue reading the stream
            return await readStream();
        }
        await readStream();
        const blob = new Blob(chunks, { type: contentType });
        chunks = null;
        return blob;
    }

    async function downloadWorker(table, urls, index, step, total) {
        if (index &gt;= total) {
            return;
        }

        const url = urls[index];
        try {
            let blob = await fetchWithSpeedTracking(url);
            await saveBlob(table, m3u8IdHead + url, blob);
            blob = null;
            successCount++;
            videoTogetherExtension.downloadPercentage = Math.floor((successCount / totalCount) * 100)
            console.log(&#39;download ts:&#39;, table, index, &#39;of&#39;, total);
        } catch (e) {
            await new Promise(r =&gt; setTimeout(r, 2000));
            failedUrls.push(url);
            console.error(e);
        }

        // Pick up the next work item
        await downloadWorker(table, urls, index + step, step, total);
    }

    async function downloadInParallel(table, urls, numThreads) {
        const total = urls.length;

        // Start numThreads download workers
        const promises = Array.from({ length: numThreads }, (_, i) =&gt; {
            return downloadWorker(table, urls, i, numThreads, total);
        });

        await Promise.all(promises);
        if (failedUrls.length != 0) {
            urls = failedUrls;
            failedUrls = [];
            await downloadInParallel(table, urls, numThreads);
        }
    }
})()
//*/
    }

    function isLimited() {
        while (lastRunQueue.length &gt; 0 &amp;&amp; lastRunQueue[0] &lt; Date.now() / 1000 - periodSec) {
            lastRunQueue.shift();
        }
        if (lastRunQueue.length &gt; timeLimitation) {
            console.error(&quot;limited&quot;)
            return true;
        }
        lastRunQueue.push(Date.now() / 1000);
        return false;
    }

    function getVideoTogetherStorage(key, defaultVal) {
        try {
            if (window.VideoTogetherStorage == undefined) {
                return defaultVal
            } else {
                if (window.VideoTogetherStorage[key] == undefined) {
                    return defaultVal
                } else {
                    return window.VideoTogetherStorage[key];
                }
            }
        } catch { return defaultVal }
    }

    function getEnableTextMessage() {
        return getVideoTogetherStorage(&#39;EnableTextMessage&#39;, true);
    }

    function getEnableMiniBar() {
        return getVideoTogetherStorage(&#39;EnableMiniBar&#39;, true);
    }

    function skipIntroLen() {
        try {
            let len = parseInt(window.VideoTogetherStorage.SkipIntroLength);
            if (window.VideoTogetherStorage.SkipIntro &amp;&amp; !isNaN(len)) {
                return len;
            }
        } catch { }
        return 0;
    }

    function isEmpty(s) {
        try {
            return s.length == 0;
        } catch {
            return true;
        }
    }

    function emptyStrIfUdf(s) {
        return s == undefined ? &quot;&quot; : s;
    }

    let isDownloadBlackListDomainCache = undefined;
    function isDownloadBlackListDomain() {
        if (window.location.protocol != &#39;http:&#39; &amp;&amp; window.location.protocol != &#39;https:&#39;) {
            return true;
        }
        const domains = [
            &#39;iqiyi.com&#39;, &#39;qq.com&#39;, &#39;youku.com&#39;,
            &#39;bilibili.com&#39;, &#39;baidu.com&#39;, &#39;quark.cn&#39;,
            &#39;aliyundrive.com&#39;, &quot;115.com&quot;, &quot;acfun.cn&quot;, &quot;youtube.com&quot;,
        ];
        if (isDownloadBlackListDomainCache == undefined) {
            const hostname = window.location.hostname;
            isDownloadBlackListDomainCache = domains.some(domain =&gt; hostname === domain || hostname.endsWith(`.${domain}`));
        }
        return isDownloadBlackListDomainCache;
    }

    let isEasyShareBlackListDomainCache = undefined;
    function isEasyShareBlackListDomain() {
        if (window.location.protocol != &#39;https:&#39;) {
            return true;
        }
        const domains = [
            &#39;iqiyi.com&#39;, &#39;qq.com&#39;, &#39;youku.com&#39;,
            &#39;bilibili.com&#39;, &#39;baidu.com&#39;, &#39;quark.cn&#39;,
            &#39;aliyundrive.com&#39;, &quot;115.com&quot;, &quot;pornhub.com&quot;, &quot;acfun.cn&quot;, &quot;youtube.com&quot;,
            // --
            &quot;missav.com&quot;, &quot;nivod4.tv&quot;
        ];
        if (isEasyShareBlackListDomainCache == undefined) {
            const hostname = window.location.hostname;
            isEasyShareBlackListDomainCache = domains.some(domain =&gt; hostname === domain || hostname.endsWith(`.${domain}`));
        }
        return isEasyShareBlackListDomainCache;
    }

    function isEasyShareEnabled() {
        if (inDownload) {
            return false;
        }
        try {
            if (isWeb()) {
                return false;
            }
            if (isEasyShareBlackListDomain()) {
                return false;
            }
            return window.VideoTogetherEasyShare != &#39;disabled&#39; &amp;&amp; window.VideoTogetherStorage.EasyShare != false;
        } catch {
            return false;
        }
    }

    function isEasyShareMember() {
        try {
            return window.VideoTogetherEasyShareMemberSite == true;
        } catch {
            return false;
        }
    }

    function useMobileStyle(videoDom) {
        let isMobile = false;
        if (window.location.href.startsWith(&#39;https://m.bilibili.com/&#39;)) {
            isMobile = true;
        }
        if (!isMobile) {
            return;
        }
        document.body.childNodes.forEach(e =&gt; {
            try {
                if (e != videoDom &amp;&amp; e.style &amp;&amp; e.id != &#39;VideoTogetherWrapper&#39;) {
                    e.style.display = &#39;none&#39;
                }
            } catch { }

        });
        videoDom.setAttribute(&#39;controls&#39;, true);
        videoDom.style.width = videoDom.style.height = &quot;100%&quot;;
        videoDom.style.maxWidth = videoDom.style.maxHeight = &quot;100%&quot;;
        videoDom.style.display = &#39;block&#39;;
        if (videoDom.parentElement != document.body) {
            document.body.appendChild(videoDom);
        }
    }

    const mediaUrlsCache = {}
    function extractMediaUrls(m3u8Content, m3u8Url) {
        if (mediaUrlsCache[m3u8Url] == undefined) {
            let lines = m3u8Content.split(&quot;\n&quot;);
            let mediaUrls = [];
            let base = undefined;
            try {
                base = new URL(m3u8Url);
            } catch { };
            for (let i = 0; i &lt; lines.length; i++) {
                let line = lines[i].trim();
                if (line !== &quot;&quot; &amp;&amp; !line.startsWith(&quot;#&quot;)) {
                    let mediaUrl = new URL(line, base);
                    mediaUrls.push(mediaUrl.href);
                }
            }
            mediaUrlsCache[m3u8Url] = mediaUrls;
        }
        return mediaUrlsCache[m3u8Url];
    }

    function fixedEncodeURIComponent(str) {
        return encodeURIComponent(str).replace(
            /[!&#39;()*]/g,
            (c) =&gt; `%${c.charCodeAt(0).toString(16).toUpperCase()}`
        ).replace(/%20/g, &#39;+&#39;);
    }

    function fixedDecodeURIComponent(str) {
        return decodeURIComponent(str.replace(/\+/g, &#39; &#39;));
    }

    function isWeb() {
        try {
            let type = window.VideoTogetherStorage.UserscriptType;
            return type == &#39;website&#39; || type == &#39;website_debug&#39;;
        } catch {
            return false;
        }
    }

    /**
     * @returns {Element}
     */
    function select(query) {
        let e = window.videoTogetherFlyPannel.wrapper.querySelector(query);
        return e;
    }

    function hide(e) {
        if (e) e.style.display = &#39;none&#39;;
    }

    function show(e) {
        if (e) e.style.display = null;
    }

    function isVideoLoadded(video) {
        try {
            if (isNaN(video.readyState)) {
                return true;
            }
            return video.readyState &gt;= 3;
        } catch {
            return true;
        }
    }

    function isRoomProtected() {
        try {
            return window.VideoTogetherStorage == undefined || window.VideoTogetherStorage.PasswordProtectedRoom != false;
        } catch {
            return true;
        }
    }

    function changeBackground(url) {
        let e = select(&#39;.vt-modal-body&#39;);
        if (e) {
            if (url == null || url == &quot;&quot;) {
                e.style.backgroundImage = &#39;none&#39;;
            } else if (e.style.backgroundImage != `url(&quot;${url}&quot;)`) {
                e.style.backgroundImage = `url(&quot;${url}&quot;)`
            }
        }
    }

    function changeMemberCount(c) {
        extension.ctxMemberCount = c;
        select(&#39;#memberCount&#39;).innerHTML = String.fromCodePoint(&quot;0x1f465&quot;) + &quot; &quot; + c
    }

    function dsply(e, _show = true) {
        _show ? show(e) : hide(e);
    }

    async function isAudioVolumeRO() {
        let a = new Audio();
        a.volume = 0.5;
        return new Promise(r =&gt; setTimeout(() =&gt; {
            r(!(a.volume == 0.5))
        }, 1));
    }

    const Global = {
        inited: false,
        NativePostMessageFunction: null,
        NativeAttachShadow: null,
        NativeFetch: null
    }

    function AttachShadow(e, options) {
        try {
            return e.attachShadow(options);
        } catch (err) {
            GetNativeFunction();
            return Global.NativeAttachShadow.call(e, options);
        }
    }

    function GetNativeFunction() {
        if (Global.inited) {
            return;
        }
        Global.inited = true;
        let temp = document.createElement(&quot;iframe&quot;);
        hide(temp);
        document.body.append(temp);
        Global.NativePostMessageFunction = temp.contentWindow.postMessage;
        Global.NativeAttachShadow = temp.contentWindow.Element.prototype.attachShadow;
        Global.NativeFetch = temp.contentWindow.fetch;
    }

    function PostMessage(window, data) {
        if (/\{\s+\[native code\]/.test(Function.prototype.toString.call(window.postMessage))) {
            window.postMessage(data, &quot;*&quot;);
        } else {
            GetNativeFunction();
            Global.NativePostMessageFunction.call(window, data, &quot;*&quot;);
        }
    }

    async function Fetch(url, init) {
        if (/\{\s+\[native code\]/.test(Function.prototype.toString.call(window.fetch))) {
            return await fetch(url, init);
        } else {
            GetNativeFunction();
            return await Global.NativeFetch.call(window, url, init);
        }
    }

    function sendMessageToTop(type, data) {
        PostMessage(window.top, {
            source: &quot;VideoTogether&quot;,
            type: type,
            data: data
        });
    }

    function sendMessageToSelf(type, data) {
        PostMessage(window, {
            source: &quot;VideoTogether&quot;,
            type: type,
            data: data
        });
    }

    function sendMessageTo(w, type, data) {
        PostMessage(w, {
            source: &quot;VideoTogether&quot;,
            type: type,
            data: data
        });
    }

    function initRangeSlider(slider) {
        const min = slider.min
        const max = slider.max
        const value = slider.value

        slider.style.background = `linear-gradient(to right, #1abc9c 0%, #1abc9c ${(value - min) / (max - min) * 100}%, #d7dcdf ${(value - min) / (max - min) * 100}%, #d7dcdf 100%)`

        slider.addEventListener(&#39;input&#39;, function () {
            this.style.background = `linear-gradient(to right, #1abc9c 0%, #1abc9c ${(this.value - this.min) / (this.max - this.min) * 100}%, #d7dcdf ${(this.value - this.min) / (this.max - this.min) * 100}%, #d7dcdf 100%)`
        });
    }

    function WSUpdateRoomRequest(name, password, url, playbackRate, currentTime, paused, duration, localTimestamp, m3u8Url) {
        return {
            &quot;method&quot;: &quot;/room/update&quot;,
            &quot;data&quot;: {
                &quot;tempUser&quot;: extension.tempUser,
                &quot;password&quot;: password,
                &quot;name&quot;: name,
                &quot;playbackRate&quot;: playbackRate,
                &quot;currentTime&quot;: currentTime,
                &quot;paused&quot;: paused,
                &quot;url&quot;: url,
                &quot;lastUpdateClientTime&quot;: localTimestamp,
                &quot;duration&quot;: duration,
                &quot;protected&quot;: isRoomProtected(),
                &quot;videoTitle&quot;: extension.isMain ? document.title : extension.videoTitle,
                &quot;sendLocalTimestamp&quot;: Date.now() / 1000,
                &quot;m3u8Url&quot;: m3u8Url
            }
        }
    }

    function WSJoinRoomRequest(name, password) {
        return {
            &quot;method&quot;: &quot;/room/join&quot;,
            &quot;data&quot;: {
                &quot;password&quot;: password,
                &quot;name&quot;: name,
            }
        }
    }

    function WsUpdateMemberRequest(name, password, isLoadding, currentUrl) {
        return {
            &quot;method&quot;: &quot;/room/update_member&quot;,
            &quot;data&quot;: {
                &quot;password&quot;: password,
                &quot;roomName&quot;: name,
                &quot;sendLocalTimestamp&quot;: Date.now() / 1000,
                &quot;userId&quot;: extension.tempUser,
                &quot;isLoadding&quot;: isLoadding,
                &quot;currentUrl&quot;: currentUrl
            }
        }
    }

    function popupError(msg) {
        let x = select(&quot;#snackbar&quot;);
        x.innerHTML = msg;
        x.className = &quot;show&quot;;
        setTimeout(function () { x.className = x.className.replace(&quot;show&quot;, &quot;&quot;); }, 3000);
        let changeVoiceBtn = select(&#39;#changeVoiceBtn&#39;);
        if (changeVoiceBtn != undefined) {
            changeVoiceBtn.onclick = () =&gt; {
                windowPannel.ShowTxtMsgTouchPannel();
            }
        }
    }

    async function waitForRoomUuid(timeout = 10000) {
        return new Promise((res, rej) =&gt; {
            let id = setInterval(() =&gt; {
                if (roomUuid != null) {
                    res(roomUuid);
                    clearInterval(id);
                }
            }, 200)
            setTimeout(() =&gt; {
                clearInterval(id);
                rej(null);
            }, timeout);
        });
    }

    class Room {
        constructor() {
            this.currentTime = null;
            this.duration = null;
            this.lastUpdateClientTime = null;
            this.lastUpdateServerTime = null;
            this.name = null;
            this.paused = null;
            this.playbackRate = null;
            this.protected = null;
            this.timestamp = null;
            this.url = null;
            this.videoTitle = null;
            this.waitForLoadding = null;
        }
    }

    const WS = {
        _socket: null,
        _lastConnectTime: 0,
        _connectTimeout: 10,
        _expriedTime: 5,
        _lastUpdateTime: 0,
        _lastErrorMessage: null,
        _lastRoom: new Room(),
        _connectedToService: false,
        isOpen() {
            try {
                return this._socket.readyState = 1 &amp;&amp; this._connectedToService;
            } catch { return false; }
        },
        async connect() {
            if (this._socket != null) {
                try {
                    if (this._socket.readyState == 1) {
                        return;
                    }
                    if (this._socket.readyState == 0
                        &amp;&amp; this._lastConnectTime + this._connectTimeout &gt; Date.now() / 1000) {
                        return;
                    }
                } catch { }
            }
            console.log(&#39;ws connect&#39;);
            this._lastConnectTime = Date.now() / 1000
            this._connectedToService = false;
            try {
                this.disconnect()
                this._socket = new WebSocket(`wss://${extension.video_together_host.replace(&quot;https://&quot;, &quot;&quot;)}/ws?language=${language}`);
                this._socket.onmessage = async e =&gt; {
                    let lines = e.data.split(&#39;\n&#39;);
                    for (let i = 0; i &lt; lines.length; i++) {
                        try {
                            await this.onmessage(lines[i]);
                        } catch (err) { console.log(err, lines[i]) }
                    }
                }
            } catch { }
        },
        async onmessage(str) {
            data = JSON.parse(str);
            if (data[&#39;errorMessage&#39;] != null) {
                this._lastUpdateTime = Date.now() / 1000;
                this._lastErrorMessage = data[&#39;errorMessage&#39;];
                this._lastRoom = null;
                return;
            }
            this._lastErrorMessage = null;
            if (data[&#39;method&#39;] == &quot;/room/join&quot;) {
                this._joinedName = data[&#39;data&#39;][&#39;name&#39;];
            }
            if (data[&#39;method&#39;] == &quot;/room/join&quot; || data[&#39;method&#39;] == &quot;/room/update&quot; || data[&#39;method&#39;] == &quot;/room/update_member&quot;) {
                this._connectedToService = true;
                this._lastRoom = Object.assign(data[&#39;data&#39;], Room);
                this._lastUpdateTime = Date.now() / 1000;

                if (extension.role == extension.RoleEnum.Member) {
                    if (!isLimited()) {
                        extension.ScheduledTask();
                    }
                }
                if (extension.role == extension.RoleEnum.Master &amp;&amp; data[&#39;method&#39;] == &quot;/room/update_member&quot;) {
                    if (!isLimited()) {
                        extension.setWaitForLoadding(this._lastRoom.waitForLoadding);
                        extension.ScheduledTask();
                    }
                }
            }
            if (data[&#39;method&#39;] == &#39;replay_timestamp&#39;) {
                sendMessageToTop(MessageType.TimestampV2Resp, { ts: Date.now() / 1000, data: data[&#39;data&#39;] })
            }
            if (data[&#39;method&#39;] == &#39;url_req&#39;) {
                extension.UrlRequest(data[&#39;data&#39;].m3u8Url, data[&#39;data&#39;].idx, data[&#39;data&#39;].origin)
            }
            if (data[&#39;method&#39;] == &#39;url_resp&#39;) {
                realUrlCache[data[&#39;data&#39;].origin] = data[&#39;data&#39;].real;
            }
            if (data[&#39;method&#39;] == &#39;m3u8_req&#39;) {
                content = extension.GetM3u8Content(data[&#39;data&#39;].m3u8Url);
                WS.m3u8ContentResp(data[&#39;data&#39;].m3u8Url, content);
            }
            if (data[&#39;method&#39;] == &#39;m3u8_resp&#39;) {
                m3u8ContentCache[data[&#39;data&#39;].m3u8Url] = data[&#39;data&#39;].content;
            }
            if (data[&#39;method&#39;] == &#39;send_txtmsg&#39; &amp;&amp; getEnableTextMessage()) {
                popupError(&quot;New Messages (&lt;a id=&#39;changeVoiceBtn&#39; style=&#39;color:inherit&#39; href=&#39;#&#39;&#39;&gt;Change Voice&lt;/a&gt;)&quot;);
                extension.gotTextMsg(data[&#39;data&#39;].id, data[&#39;data&#39;].msg);
                sendMessageToTop(MessageType.GotTxtMsg, { id: data[&#39;data&#39;].id, msg: data[&#39;data&#39;].msg });
            }
        },
        getRoom() {
            if (this._lastUpdateTime + this._expriedTime &gt; Date.now() / 1000) {
                if (this._lastErrorMessage != null) {
                    throw new Error(this._lastErrorMessage);
                }
                return this._lastRoom;
            }
        },
        async send(data) {
            try {
                this._socket.send(JSON.stringify(data));
            } catch { }
        },
        async updateRoom(name, password, url, playbackRate, currentTime, paused, duration, localTimestamp, m3u8Url) {
            // TODO localtimestamp
            this.send(WSUpdateRoomRequest(name, password, url, playbackRate, currentTime, paused, duration, localTimestamp, m3u8Url));
        },
        async urlReq(m3u8Url, idx, origin) {
            this.send({
                &quot;method&quot;: &quot;url_req&quot;,
                &quot;data&quot;: {
                    &quot;m3u8Url&quot;: m3u8Url,
                    &quot;idx&quot;: idx,
                    &quot;origin&quot;: origin
                }
            })
        },
        async urlResp(origin, real) {
            this.send({
                &quot;method&quot;: &quot;url_resp&quot;,
                &quot;data&quot;: {
                    &quot;origin&quot;: origin,
                    &quot;real&quot;: real,
                }
            })
        },
        async m3u8ContentReq(m3u8Url) {
            this.send({
                &quot;method&quot;: &quot;m3u8_req&quot;,
                &quot;data&quot;: {
                    &quot;m3u8Url&quot;: m3u8Url,
                }
            })
        },
        async sendTextMessage(id, msg) {
            this.send({
                &quot;method&quot;: &quot;send_txtmsg&quot;,
                &quot;data&quot;: {
                    &quot;msg&quot;: msg,
                    &quot;id&quot;: id
                }
            })
        },
        async m3u8ContentResp(m3u8Url, content) {
            this.send({
                &quot;method&quot;: &quot;m3u8_resp&quot;,
                &quot;data&quot;: {
                    &quot;m3u8Url&quot;: m3u8Url,
                    &quot;content&quot;: content
                }
            })
        },
        async updateMember(name, password, isLoadding, currentUrl) {
            this.send(WsUpdateMemberRequest(name, password, isLoadding, currentUrl));
        },
        _joinedName: null,
        async joinRoom(name, password) {
            if (name == this._joinedName) {
                return;
            }
            this.send(WSJoinRoomRequest(name, password));
        },
        async disconnect() {
            if (this._socket != null) {
                try {
                    this._socket.close();
                } catch { }
            }
            this._joinedName = null;
            this._socket = null;
        }
    }

    const VoiceStatus = {
        STOP: 1,
        CONNECTTING: 5,
        MUTED: 2,
        UNMUTED: 3,
        ERROR: 4
    }

    const Voice = {
        _status: VoiceStatus.STOP,
        _errorMessage: &quot;&quot;,
        _rname: &quot;&quot;,
        _mutting: false,
        get errorMessage() {
            return this._errorMessage;
        },
        set errorMessage(m) {
            this._errorMessage = m;
            select(&quot;#snackbar&quot;).innerHTML = m;
            let voiceConnErrBtn = select(&#39;#voiceConnErrBtn&#39;);
            if (voiceConnErrBtn != undefined) {
                voiceConnErrBtn.onclick = () =&gt; {
                    alert(&#39;If you have installed uBlock and other adblock extensions, please disable those extensions and try again.&#39;)
                }
            }
        },
        set status(s) {
            this._status = s;
            let disabledMic = select(&quot;#disabledMic&quot;);
            let micBtn = select(&#39;#micBtn&#39;);
            let audioBtn = select(&#39;#audioBtn&#39;);
            let callBtn = select(&quot;#callBtn&quot;);
            let callConnecting = select(&quot;#callConnecting&quot;);
            let callErrorBtn = select(&quot;#callErrorBtn&quot;);
            dsply(callConnecting, s == VoiceStatus.CONNECTTING);
            dsply(callBtn, s == VoiceStatus.STOP);
            let inCall = (VoiceStatus.UNMUTED == s || VoiceStatus.MUTED == s);
            dsply(micBtn, inCall);
            dsply(audioBtn, inCall);
            dsply(callErrorBtn, s == VoiceStatus.ERROR);
            switch (s) {
                case VoiceStatus.STOP:
                    break;
                case VoiceStatus.MUTED:
                    show(disabledMic);
                    break;
                case VoiceStatus.UNMUTED:
                    hide(disabledMic);
                    break;
                case VoiceStatus.ERROR:
                    var x = select(&quot;#snackbar&quot;);
                    x.className = &quot;show&quot;;
                    setTimeout(function () { x.className = x.className.replace(&quot;show&quot;, &quot;&quot;); }, 3000);
                    break;
                default:
                    break;
            }
        },
        get status() {
            return this._status;
        },
        _conn: null,
        set conn(conn) {
            this._conn = conn;
        },
        /**
         * @return {RTCPeerConnection}
         */
        get conn() {
            return this._conn
        },

        _stream: null,
        set stream(s) {
            this._stream = s;
        },
        /**
         * @return {MediaStream}
         */
        get stream() {
            return this._stream;
        },

        _noiseCancellationEnabled: true,
        set noiseCancellationEnabled(n) {
            this._noiseCancellationEnabled = n;
            if (this.inCall) {
                this.updateVoiceSetting(n);
            }
        },

        get noiseCancellationEnabled() {
            return this._noiseCancellationEnabled;
        },

        get inCall() {
            return this.status == VoiceStatus.MUTED || this.status == VoiceStatus.UNMUTED;
        },

        join: async function (name, rname, mutting = false) {
            Voice._rname = rname;
            Voice._mutting = mutting;
            let cancellingNoise = true;
            try {
                cancellingNoise = !(window.VideoTogetherStorage.EchoCancellation === false);
            } catch { }

            Voice.stop();
            Voice.status = VoiceStatus.CONNECTTING;
            this.noiseCancellationEnabled = cancellingNoise;
            let uid = generateUUID();
            let notNullUuid;
            try {
                notNullUuid = await waitForRoomUuid();
            } catch {
                Voice.errorMessage = &quot;uuid is missing&quot;;
                Voice.status = VoiceStatus.ERROR;
                return;
            }
            const rnameRPC = fixedEncodeURIComponent(notNullUuid + &quot;_&quot; + rname);
            if (rnameRPC.length &gt; 256) {
                Voice.errorMessage = &quot;Room name too long&quot;;
                Voice.status = VoiceStatus.ERROR;
                return;
            }
            if (window.location.protocol != &quot;https:&quot;) {
                Voice.errorMessage = &quot;Only support https website&quot;;
                Voice.status = VoiceStatus.ERROR;
                return;
            }
            const unameRPC = fixedEncodeURIComponent(uid + &#39;:&#39; + Base64.encode(generateUUID()));
            let ucid = &quot;&quot;;
            console.log(rnameRPC, uid);
            const configuration = {
                bundlePolicy: &#39;max-bundle&#39;,
                rtcpMuxPolicy: &#39;require&#39;,
                sdpSemantics: &#39;unified-plan&#39;
            };

            async function subscribe(pc) {
                var res = await rpc(&#39;subscribe&#39;, [rnameRPC, unameRPC, ucid]);
                if (res.error &amp;&amp; typeof res.error === &#39;object&#39; &amp;&amp; typeof res.error.code === &#39;number&#39; &amp;&amp; [5002001, 5002002].indexOf(res.error.code) != -1) {
                    Voice.join(&quot;&quot;, Voice._rname, Voice._mutting);
                    return;
                }
                if (res.data) {
                    var jsep = JSON.parse(res.data.jsep);
                    if (jsep.type == &#39;offer&#39;) {
                        await pc.setRemoteDescription(jsep);
                        var sdp = await pc.createAnswer();
                        await pc.setLocalDescription(sdp);
                        await rpc(&#39;answer&#39;, [rnameRPC, unameRPC, ucid, JSON.stringify(sdp)]);
                    }
                }
                setTimeout(function () {
                    if (Voice.conn != null &amp;&amp; pc === Voice.conn &amp;&amp; Voice.status != VoiceStatus.STOP) {
                        subscribe(pc);
                    }
                }, 3000);
            }


            try {
                await start();
            } catch (e) {
                if (Voice.status == VoiceStatus.CONNECTTING) {
                    Voice.status = VoiceStatus.ERROR;
                    Voice.errorMessage = &quot;Connection error (&lt;a id=&#39;voiceConnErrBtn&#39; style=&#39;color:inherit&#39; href=&#39;#&#39;&#39;&gt;Help&lt;/a&gt;)&quot;;
                }
            }

            if (Voice.status == VoiceStatus.CONNECTTING) {
                Voice.status = mutting ? VoiceStatus.MUTED : VoiceStatus.UNMUTED;
            }

            async function start() {

                let res = await rpc(&#39;turn&#39;, [unameRPC]);
                if (res.data &amp;&amp; res.data.length &gt; 0) {
                    configuration.iceServers = res.data;
                    configuration.iceTransportPolicy = &#39;relay&#39;;
                }

                Voice.conn = new RTCPeerConnection(configuration);

                Voice.conn.onicecandidate = ({ candidate }) =&gt; {
                    rpc(&#39;trickle&#39;, [rnameRPC, unameRPC, ucid, JSON.stringify(candidate)]);
                };

                Voice.conn.ontrack = (event) =&gt; {
                    console.log(&quot;ontrack&quot;, event);

                    let stream = event.streams[0];
                    let sid = fixedDecodeURIComponent(stream.id);
                    let id = sid.split(&#39;:&#39;)[0];
                    // var name = Base64.decode(sid.split(&#39;:&#39;)[1]);
                    console.log(id, uid);
                    if (id === uid) {
                        return;
                    }
                    event.track.onmute = (event) =&gt; {
                        console.log(&quot;onmute&quot;, event);
                    };

                    let aid = &#39;peer-audio-&#39; + id;
                    let el = select(&#39;#&#39; + aid);
                    if (el) {
                        el.srcObject = stream;
                    } else {
                        el = document.createElement(event.track.kind)
                        el.id = aid;
                        el.srcObject = stream;
                        el.autoplay = true;
                        el.controls = false;
                        select(&#39;#peer&#39;).appendChild(el);
                    }
                };

                try {
                    const constraints = {
                        audio: {
                            echoCancellation: cancellingNoise,
                            noiseSuppression: cancellingNoise
                        },
                        video: false
                    };
                    Voice.stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (err) {
                    if (Voice.status == VoiceStatus.CONNECTTING) {
                        Voice.errorMessage = &quot;No microphone access&quot;;
                        Voice.status = VoiceStatus.ERROR;
                    }
                    return;
                }

                Voice.stream.getTracks().forEach((track) =&gt; {
                    track.enabled = !mutting;
                    Voice.conn.addTrack(track, Voice.stream);
                });

                await Voice.conn.setLocalDescription(await Voice.conn.createOffer());
                res = await rpc(&#39;publish&#39;, [rnameRPC, unameRPC, JSON.stringify(Voice.conn.localDescription)]);
                if (res.data) {
                    let jsep = JSON.parse(res.data.jsep);
                    if (jsep.type == &#39;answer&#39;) {
                        await Voice.conn.setRemoteDescription(jsep);
                        ucid = res.data.track;
                        await subscribe(Voice.conn);
                    }
                } else {
                    throw new Error(&#39;Unknown error&#39;);
                }
                Voice.conn.oniceconnectionstatechange = e =&gt; {
                    if (Voice.conn.iceConnectionState == &quot;disconnected&quot; || Voice.conn.iceConnectionState == &quot;failed&quot; || Voice.conn.iceConnectionState == &quot;closed&quot;) {
                        Voice.errorMessage = &quot;Connection lost&quot;;
                        Voice.status = VoiceStatus.ERROR;
                    } else {
                        if (Voice.status == VoiceStatus.ERROR) {
                            Voice.status = Voice._mutting ? VoiceStatus.MUTED : VoiceStatus.UNMUTED;
                        }
                    }
                }
            }

            async function rpc(method, params = [], retryTime = -1) {
                try {
                    const response = await window.videoTogetherExtension.Fetch(extension.video_together_host + &quot;/kraken&quot;, &quot;POST&quot;, { id: generateUUID(), method: method, params: params }, {
                        method: &#39;POST&#39;, // *GET, POST, PUT, DELETE, etc.
                        mode: &#39;cors&#39;, // no-cors, *cors, same-origin
                        cache: &#39;no-cache&#39;, // *default, no-cache, reload, force-cache, only-if-cached
                        credentials: &#39;omit&#39;, // include, *same-origin, omit
                        headers: {
                            &#39;Content-Type&#39;: &#39;application/json&#39;
                        },
                        redirect: &#39;follow&#39;, // manual, *follow, error
                        referrerPolicy: &#39;no-referrer&#39;, // no-referrer, *client
                        body: JSON.stringify({ id: generateUUID(), method: method, params: params }) // body data type must match &quot;Content-Type&quot; header
                    });
                    return await response.json(); // parses JSON response into native JavaScript objects
                } catch (err) {
                    if (Voice.status == VoiceStatus.STOP) {
                        return;
                    }
                    if (retryTime == 0) {
                        throw err;
                    }
                    await new Promise(r =&gt; setTimeout(r, 1000));
                    return await rpc(method, params, retryTime - 1);
                }
            }
        },
        stop: () =&gt; {
            try {
                Voice.conn.getSenders().forEach(s =&gt; {
                    if (s.track) {
                        s.track.stop();
                    }
                });
            } catch (e) { };

            [...select(&#39;#peer&#39;).querySelectorAll(&quot;*&quot;)].forEach(e =&gt; e.remove());
            try {
                Voice.conn.close();
                delete Voice.conn;
            } catch { }
            try {
                Voice.stream.getTracks().forEach(function (track) {
                    track.stop();
                });
                delete Voice.stream;
            } catch { }
            Voice.status = VoiceStatus.STOP;
        },
        mute: () =&gt; {
            Voice.conn.getSenders().forEach(s =&gt; {
                if (s.track) {
                    s.track.enabled = false;
                }
            });
            Voice._mutting = true;
            Voice.status = VoiceStatus.MUTED;
        },
        unmute: () =&gt; {
            Voice.conn.getSenders().forEach(s =&gt; {
                if (s.track) {
                    s.track.enabled = true;
                }
            });
            Voice._mutting = false;
            Voice.status = VoiceStatus.UNMUTED;
        },
        updateVoiceSetting: async (cancellingNoise = false) =&gt; {
            const constraints = {
                audio: {
                    echoCancellation: cancellingNoise,
                    noiseSuppression: cancellingNoise
                },
                video: false
            };
            try {
                prevStream = Voice.stream;
                Voice.stream = await navigator.mediaDevices.getUserMedia(constraints);
                Voice.conn.getSenders().forEach(s =&gt; {
                    if (s.track) {
                        s.replaceTrack(Voice.stream.getTracks().find(t =&gt; t.kind == s.track.kind));
                    }
                })
                prevStream.getTracks().forEach(t =&gt; t.stop());
                delete prevStream;
            } catch (e) { console.log(e); };
        }
    }

    function generateUUID() {
        if (crypto.randomUUID != undefined) {
            return crypto.randomUUID();
        }
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =&gt;
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] &amp; 15 &gt;&gt; c / 4).toString(16)
        );
    }

    function generateTempUserId() {
        return generateUUID() + &quot;:&quot; + Date.now() / 1000;
    }

    /**
     *
     *  Base64 encode / decode
     *  http://www.webtoolkit.info
     *
     **/
    const Base64 = {

        // private property
        _keyStr: &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;

        // public method for encoding
        , encode: function (input) {
            var output = &quot;&quot;;
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;

            input = Base64._utf8_encode(input);

            while (i &lt; input.length) {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);

                enc1 = chr1 &gt;&gt; 2;
                enc2 = ((chr1 &amp; 3) &lt;&lt; 4) | (chr2 &gt;&gt; 4);
                enc3 = ((chr2 &amp; 15) &lt;&lt; 2) | (chr3 &gt;&gt; 6);
                enc4 = chr3 &amp; 63;

                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                }
                else if (isNaN(chr3)) {
                    enc4 = 64;
                }

                output = output +
                    this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                    this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
            } // Whend

            return output;
        } // End Function encode


        // public method for decoding
        , decode: function (input) {
            var output = &quot;&quot;;
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;

            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;);
            while (i &lt; input.length) {
                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));

                chr1 = (enc1 &lt;&lt; 2) | (enc2 &gt;&gt; 4);
                chr2 = ((enc2 &amp; 15) &lt;&lt; 4) | (enc3 &gt;&gt; 2);
                chr3 = ((enc3 &amp; 3) &lt;&lt; 6) | enc4;

                output = output + String.fromCharCode(chr1);

                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }

                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }

            } // Whend

            output = Base64._utf8_decode(output);

            return output;
        } // End Function decode


        // private method for UTF-8 encoding
        , _utf8_encode: function (string) {
            var utftext = &quot;&quot;;
            string = string.replace(/\r\n/g, &quot;\n&quot;);

            for (var n = 0; n &lt; string.length; n++) {
                var c = string.charCodeAt(n);

                if (c &lt; 128) {
                    utftext += String.fromCharCode(c);
                }
                else if ((c &gt; 127) &amp;&amp; (c &lt; 2048)) {
                    utftext += String.fromCharCode((c &gt;&gt; 6) | 192);
                    utftext += String.fromCharCode((c &amp; 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c &gt;&gt; 12) | 224);
                    utftext += String.fromCharCode(((c &gt;&gt; 6) &amp; 63) | 128);
                    utftext += String.fromCharCode((c &amp; 63) | 128);
                }

            } // Next n

            return utftext;
        } // End Function _utf8_encode

        // private method for UTF-8 decoding
        , _utf8_decode: function (utftext) {
            var string = &quot;&quot;;
            var i = 0;
            var c, c1, c2, c3;
            c = c1 = c2 = 0;

            while (i &lt; utftext.length) {
                c = utftext.charCodeAt(i);

                if (c &lt; 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if ((c &gt; 191) &amp;&amp; (c &lt; 224)) {
                    c2 = utftext.charCodeAt(i + 1);
                    string += String.fromCharCode(((c &amp; 31) &lt;&lt; 6) | (c2 &amp; 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i + 1);
                    c3 = utftext.charCodeAt(i + 2);
                    string += String.fromCharCode(((c &amp; 15) &lt;&lt; 12) | ((c2 &amp; 63) &lt;&lt; 6) | (c3 &amp; 63));
                    i += 3;
                }

            } // Whend

            return string;
        } // End Function _utf8_decode
    }

    let GotTxtMsgCallback = undefined;

    class VideoTogetherFlyPannel {
        constructor() {
            this.sessionKey = &quot;VideoTogetherFlySaveSessionKey&quot;;
            this.isInRoom = false;

            this.isMain = (window.self == window.top);
            setInterval(() =&gt; {
                if (getEnableMiniBar() &amp;&amp; getEnableTextMessage() &amp;&amp; document.fullscreenElement != undefined
                    &amp;&amp; (extension.ctxRole == extension.RoleEnum.Master || extension.ctxRole == extension.RoleEnum.Member)) {
                    const qs = (s) =&gt; this.fullscreenWrapper.querySelector(s);
                    try {
                        qs(&quot;#memberCount&quot;).innerText = extension.ctxMemberCount;
                        qs(&quot;#send-button&quot;).disabled = !extension.ctxWsIsOpen;
                    } catch { };
                    if (document.fullscreenElement.contains(this.fullscreenSWrapper)) {
                        return;
                    }
                    let shadowWrapper = document.createElement(&quot;div&quot;);
                    this.fullscreenSWrapper = shadowWrapper;
                    shadowWrapper.id = &quot;VideoTogetherfullscreenSWrapper&quot;;
                    let wrapper;
                    try {
                        wrapper = AttachShadow(shadowWrapper, { mode: &quot;open&quot; });
                        wrapper.addEventListener(&#39;keydown&#39;, (e) =&gt; e.stopPropagation());
                        this.fullscreenWrapper = wrapper;
                    } catch (e) { console.error(e); }
                    wrapper.innerHTML = `&lt;style&gt;
    .container {
        position: absolute;
        top: 50%;
        left: 0px;
        border: 1px solid #000;
        padding: 0px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: fit-content;
        justify-content: center;
        border-radius: 5px;
        opacity: 80%;
        background: #000;
        color: white;
        z-index: 2147483647;
    }

    .container input[type=&#39;text&#39;] {
        padding: 0px;
        flex-grow: 1;
        border: none;
        height: 24px;
        width: 0px;
        height: 32px;
        transition: width 0.1s linear;
        background-color: transparent;
        color: white;
    }

    .container input[type=&#39;text&#39;].expand {
        width: 150px;
    }

    .container .user-info {
        display: flex;
        align-items: center;
    }

    .container button {
        height: 32px;
        font-size: 16px;
        border: 0px;
        color: white;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        background-color: #1890ff;
        transition-duration: 0.4s;
        border-radius: 4px;
    }

    .container #expand-button {
        color: black;
        font-weight: bolder;
        height: 32px;
        width: 32px;
        background-size: cover;
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACrFBMVEXg9b7e87jd87jd9Lnd9Lre9Lng9b/j98jm98vs99fy9ubu89/e1sfJqKnFnqLGoaXf9Lvd87Xe87fd8rfV67Ti9sbk98nm9sze48TX3rjU1rTKr6jFnaLe9Lfe87Xe9LjV7LPN4q3g78PJuqfQ1a7OzarIsabEnaHi9sXd8rvd8rbd87axx4u70Jrl+cvm+szQxq25lZTR1a7KvaXFo6LFnaHEnKHd6r3Y57TZ7bLb8bTZ7rKMomClun/k+MrOx6yue4PIvqfP06vLv6fFoqLEnKDT27DS3a3W6K7Y7bDT6auNq2eYn3KqlYShYXTOwLDAzZ7MyanKtqbEoaHDm6DDm5/R2K3Q2KzT4q3W6a7P3amUhWp7SEuMc2rSyri3zJe0xpPV17TKuqbGrqLEnqDQ2K3O06rP0arR2qzJx6GZX160j4rP1LOiuH2GnVzS3rXb47zQ063OzanHr6PDnaDMxajIsaXLwKfEt5y6mI/GyqSClVZzi0bDzp+8nY/d6L/X4rbQ1qzMyKjEqKHFpqLFpaLGqaO2p5KCjlZ5jky8z5izjoOaXmLc5r3Z57jU4K7S3K3NyqnBm56Mg2KTmWnM0KmwhH2IOUunfXnh8cXe8b7Z7LPV4rDBmZ3Cmp+6mZWkk32/qZihbG97P0OdinXQ3rTk+Mjf9L/d8rja6ri9lpqnh4qhgoWyk5Kmd3qmfHW3oou2vZGKpmaUrXDg9MPf9L3e876yj5Ori42Mc3aDbG6MYmyifXfHyaPU3rHH0aKDlVhkejW70Zbf9bze87be87ng9cCLcnWQd3qEbG9/ZmmBXmSflYS4u5ra5Lnd6r7U5ba2ypPB153c87re9b2Ba22EbW+AamyDb3CNgXmxsZng7sTj9sjk98rk+Mng9cHe9Lze9Lrd87n////PlyWlAAAAAWJLR0TjsQauigAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB+YGGQYXBzHy0g0AAAEbSURBVBjTARAB7/4AAAECAwQFBgcICQoLDA0ODwAQEREREhMUFRYXGBkaGxwOAAYdHhEfICEWFiIjJCUmDicAKCkqKx8sLS4vMDEyMzQ1NgA3ODk6Ozw9Pj9AQUJDRDVFAEZHSElKS0xNTk9QUVJTVFUAVldYWVpbXF1eX2BhYmNkVABlZmdoaWprbG1ub3BxcnN0AEJ1dnd4eXp7fH1+f4CBgoMAc4QnhYaHiImKi4yNjo+QkQBFVFU2kpOUlZaXmJmam5ucAFRVnZ6foKGio6SlpqeoE6kAVaqrrK2ur7CxsrO0tQEDtgC3uLm6u7y9vr/AwcLDxMXGAMfIycrLzM3Oz9DR0tMdAdQA1da619jZ2tvc3d7f4OEB4iRLaea64H7qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIyLTA2LTI1VDA2OjIzOjAyKzAwOjAwlVQlhgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMi0wNi0yNVQwNjoyMzowMiswMDowMOQJnToAAAAgdEVYdHNvZnR3YXJlAGh0dHBzOi8vaW1hZ2VtYWdpY2sub3JnvM8dnQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMTkyQF1xVQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE2NTYxMzgxODJHYkS0AAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjItMDYtMjUvNGU5YzJlYjRjNmRhMjIwZDgzYjcyOTYxZmI1ZTJiY2UuaWNvLnBuZ7tNVVEAAAAASUVORK5CYII=);
    }

    .container #close-btn {
        height: 16px;
        max-width: 24px;
        background-color: rgba(255, 0, 0, 0.5);
        font-size: 8px;
    }

    .container #close-btn:hover {
        background-color: rgba(255, 0, 0, 0.3);
    }

    .container button:hover {
        background-color: #6ebff4;
    }

    .container button:disabled,
    .container button:disabled:hover {
        background-color: rgb(76, 76, 76);
    }
&lt;/style&gt;
&lt;div class=&quot;container&quot; id=&quot;container&quot;&gt;
    &lt;button id=&quot;expand-button&quot;&gt;&amp;lt;&lt;/button&gt;
    &lt;div style=&quot;padding: 0 5px 0 5px;&quot; class=&quot;user-info&quot; id=&quot;user-info&quot;&gt;
        &lt;span class=&quot;emoji&quot;&gt;👥&lt;/span&gt;
        &lt;span id=&quot;memberCount&quot;&gt;0&lt;/span&gt;
    &lt;/div&gt;
    &lt;button id=&quot;close-btn&quot;&gt;x&lt;/button&gt;
    &lt;input style=&quot;margin: 0 0 0 5px;&quot; type=&quot;text&quot; placeholder=&quot;Text Message&quot; id=&quot;text-input&quot; class=&quot;expand&quot; /&gt;
    &lt;button id=&quot;send-button&quot;&gt;Send&lt;/button&gt;
&lt;/div&gt;`;
                    document.fullscreenElement.appendChild(shadowWrapper);
                    var container = wrapper.getElementById(&#39;container&#39;);
                    let expandBtn = wrapper.getElementById(&#39;expand-button&#39;);
                    let msgInput = wrapper.getElementById(&#39;text-input&#39;);
                    let sendBtn = wrapper.getElementById(&#39;send-button&#39;);
                    let closeBtn = wrapper.getElementById(&#39;close-btn&#39;);
                    let expanded = true;
                    function expand() {
                        if (expanded) {
                            expandBtn.innerText = &#39;&gt;&#39;
                            sendBtn.style.display = &#39;none&#39;;
                            msgInput.classList.remove(&#39;expand&#39;);

                        } else {
                            expandBtn.innerText = &#39;&lt;&#39;;
                            sendBtn.style.display = &#39;inline-block&#39;;
                            msgInput.classList.add(&quot;expand&quot;);
                        }
                        expanded = !expanded;
                    }
                    closeBtn.onclick = () =&gt; { shadowWrapper.style.display = &quot;none&quot;; }
                    wrapper.getElementById(&#39;expand-button&#39;).addEventListener(&#39;click&#39;, () =&gt; expand());
                    sendBtn.onclick = () =&gt; {
                        extension.currentSendingMsgId = generateUUID();
                        sendMessageToTop(MessageType.SendTxtMsg, { currentSendingMsgId: extension.currentSendingMsgId, value: msgInput.value });
                    }
                    GotTxtMsgCallback = (id, msg) =&gt; {
                        console.log(id, msg);
                        if (id == extension.currentSendingMsgId &amp;&amp; msg == msgInput.value) {
                            msgInput.value = &quot;&quot;;
                        }
                    }
                    msgInput.addEventListener(&quot;keyup&quot;, e =&gt; {
                        if (e.key == &quot;Enter&quot;) {
                            sendBtn.click();
                        }
                    });
                } else {
                    if (this.fullscreenSWrapper != undefined) {
                        this.fullscreenSWrapper.remove();
                        this.fullscreenSWrapper = undefined;
                        this.fullscreenWrapper = undefined;
                        GotTxtMsgCallback = undefined;
                    }
                }
            }, 500);
            if (this.isMain) {
                document.addEventListener(&quot;click&quot;, () =&gt; {
                    this.enableSpeechSynthesis();
                });
                this.minimized = false;
                let shadowWrapper = document.createElement(&quot;div&quot;);
                shadowWrapper.id = &quot;VideoTogetherWrapper&quot;;
                let wrapper;
                try {
                    wrapper = AttachShadow(shadowWrapper, { mode: &quot;open&quot; });
                    wrapper.addEventListener(&#39;keydown&#39;, (e) =&gt; e.stopPropagation())
                } catch (e) { console.error(e); }

                this.shadowWrapper = shadowWrapper;
                this.wrapper = wrapper;
                wrapper.innerHTML = `&lt;div id=&quot;peer&quot; style=&quot;display: none;&quot;&gt;&lt;/div&gt;
&lt;div id=&quot;videoTogetherFlyPannel&quot; style=&quot;display: none;&quot;&gt;
  &lt;div id=&quot;videoTogetherHeader&quot; class=&quot;vt-modal-header&quot;&gt;
    &lt;div style=&quot;display: flex;align-items: center;&quot;&gt;
      &lt;img style=&quot;width: 16px; height: 16px;&quot;
        src=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACrFBMVEXg9b7e87jd87jd9Lnd9Lre9Lng9b/j98jm98vs99fy9ubu89/e1sfJqKnFnqLGoaXf9Lvd87Xe87fd8rfV67Ti9sbk98nm9sze48TX3rjU1rTKr6jFnaLe9Lfe87Xe9LjV7LPN4q3g78PJuqfQ1a7OzarIsabEnaHi9sXd8rvd8rbd87axx4u70Jrl+cvm+szQxq25lZTR1a7KvaXFo6LFnaHEnKHd6r3Y57TZ7bLb8bTZ7rKMomClun/k+MrOx6yue4PIvqfP06vLv6fFoqLEnKDT27DS3a3W6K7Y7bDT6auNq2eYn3KqlYShYXTOwLDAzZ7MyanKtqbEoaHDm6DDm5/R2K3Q2KzT4q3W6a7P3amUhWp7SEuMc2rSyri3zJe0xpPV17TKuqbGrqLEnqDQ2K3O06rP0arR2qzJx6GZX160j4rP1LOiuH2GnVzS3rXb47zQ063OzanHr6PDnaDMxajIsaXLwKfEt5y6mI/GyqSClVZzi0bDzp+8nY/d6L/X4rbQ1qzMyKjEqKHFpqLFpaLGqaO2p5KCjlZ5jky8z5izjoOaXmLc5r3Z57jU4K7S3K3NyqnBm56Mg2KTmWnM0KmwhH2IOUunfXnh8cXe8b7Z7LPV4rDBmZ3Cmp+6mZWkk32/qZihbG97P0OdinXQ3rTk+Mjf9L/d8rja6ri9lpqnh4qhgoWyk5Kmd3qmfHW3oou2vZGKpmaUrXDg9MPf9L3e876yj5Ori42Mc3aDbG6MYmyifXfHyaPU3rHH0aKDlVhkejW70Zbf9bze87be87ng9cCLcnWQd3qEbG9/ZmmBXmSflYS4u5ra5Lnd6r7U5ba2ypPB153c87re9b2Ba22EbW+AamyDb3CNgXmxsZng7sTj9sjk98rk+Mng9cHe9Lze9Lrd87n////PlyWlAAAAAWJLR0TjsQauigAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB+YGGQYXBzHy0g0AAAEbSURBVBjTARAB7/4AAAECAwQFBgcICQoLDA0ODwAQEREREhMUFRYXGBkaGxwOAAYdHhEfICEWFiIjJCUmDicAKCkqKx8sLS4vMDEyMzQ1NgA3ODk6Ozw9Pj9AQUJDRDVFAEZHSElKS0xNTk9QUVJTVFUAVldYWVpbXF1eX2BhYmNkVABlZmdoaWprbG1ub3BxcnN0AEJ1dnd4eXp7fH1+f4CBgoMAc4QnhYaHiImKi4yNjo+QkQBFVFU2kpOUlZaXmJmam5ucAFRVnZ6foKGio6SlpqeoE6kAVaqrrK2ur7CxsrO0tQEDtgC3uLm6u7y9vr/AwcLDxMXGAMfIycrLzM3Oz9DR0tMdAdQA1da619jZ2tvc3d7f4OEB4iRLaea64H7qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIyLTA2LTI1VDA2OjIzOjAyKzAwOjAwlVQlhgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMi0wNi0yNVQwNjoyMzowMiswMDowMOQJnToAAAAgdEVYdHNvZnR3YXJlAGh0dHBzOi8vaW1hZ2VtYWdpY2sub3JnvM8dnQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMTkyQF1xVQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE2NTYxMzgxODJHYkS0AAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjItMDYtMjUvNGU5YzJlYjRjNmRhMjIwZDgzYjcyOTYxZmI1ZTJiY2UuaWNvLnBuZ7tNVVEAAAAASUVORK5CYII=&quot;&gt;
      &lt;div class=&quot;vt-modal-title&quot;&gt;VideoTogether&lt;/div&gt;
    &lt;/div&gt;

    &lt;button id=&quot;downloadBtn&quot; type=&quot;button&quot; class=&quot;vt-modal-title-button vt-modal-easyshare&quot;&gt;
      &lt;span class=&quot;vt-modal-close-x&quot;&gt;
        &lt;span role=&quot;img&quot; aria-label=&quot;Setting&quot; class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
          &lt;svg width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;currentColor&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;
            stroke=&quot;currentColor&quot; stroke-width=&quot;1.67&quot;&gt;
            &lt;path
              d=&quot;M12.5535 16.5061C12.4114 16.6615 12.2106 16.75 12 16.75C11.7894 16.75 11.5886 16.6615 11.4465 16.5061L7.44648 12.1311C7.16698 11.8254 7.18822 11.351 7.49392 11.0715C7.79963 10.792 8.27402 10.8132 8.55352 11.1189L11.25 14.0682V3C11.25 2.58579 11.5858 2.25 12 2.25C12.4142 2.25 12.75 2.58579 12.75 3V14.0682L15.4465 11.1189C15.726 10.8132 16.2004 10.792 16.5061 11.0715C16.8118 11.351 16.833 11.8254 16.5535 12.1311L12.5535 16.5061Z&quot;
              fill=&quot;currentColor&quot; /&gt;
            &lt;path
              d=&quot;M3.75 15C3.75 14.5858 3.41422 14.25 3 14.25C2.58579 14.25 2.25 14.5858 2.25 15V15.0549C2.24998 16.4225 2.24996 17.5248 2.36652 18.3918C2.48754 19.2919 2.74643 20.0497 3.34835 20.6516C3.95027 21.2536 4.70814 21.5125 5.60825 21.6335C6.47522 21.75 7.57754 21.75 8.94513 21.75H15.0549C16.4225 21.75 17.5248 21.75 18.3918 21.6335C19.2919 21.5125 20.0497 21.2536 20.6517 20.6516C21.2536 20.0497 21.5125 19.2919 21.6335 18.3918C21.75 17.5248 21.75 16.4225 21.75 15.0549V15C21.75 14.5858 21.4142 14.25 21 14.25C20.5858 14.25 20.25 14.5858 20.25 15C20.25 16.4354 20.2484 17.4365 20.1469 18.1919C20.0482 18.9257 19.8678 19.3142 19.591 19.591C19.3142 19.8678 18.9257 20.0482 18.1919 20.1469C17.4365 20.2484 16.4354 20.25 15 20.25H9C7.56459 20.25 6.56347 20.2484 5.80812 20.1469C5.07435 20.0482 4.68577 19.8678 4.40901 19.591C4.13225 19.3142 3.9518 18.9257 3.85315 18.1919C3.75159 17.4365 3.75 16.4354 3.75 15Z&quot;
              fill=&quot;currentColor&quot; /&gt;
          &lt;/svg&gt;
        &lt;/span&gt;
      &lt;/span&gt;
    &lt;/button&gt;

    &lt;button style=&quot;display: none;&quot; id=&quot;easyShareCopyBtn&quot; type=&quot;button&quot; class=&quot;vt-modal-title-button vt-modal-easyshare&quot;&gt;
      &lt;span class=&quot;vt-modal-close-x&quot;&gt;
        &lt;span role=&quot;img&quot; aria-label=&quot;Setting&quot; class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
          &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 32 32&quot;&gt;
            &lt;path fill=&quot;currentColor&quot;
              d=&quot;M0 25.472q0 2.368 1.664 4.032t4.032 1.664h18.944q2.336 0 4-1.664t1.664-4.032v-8.192l-3.776 3.168v5.024q0 0.8-0.544 1.344t-1.344 0.576h-18.944q-0.8 0-1.344-0.576t-0.544-1.344v-18.944q0-0.768 0.544-1.344t1.344-0.544h9.472v-3.776h-9.472q-2.368 0-4.032 1.664t-1.664 4v18.944zM5.696 19.808q0 2.752 1.088 5.28 0.512-2.944 2.24-5.344t4.288-3.872 5.632-1.664v5.6l11.36-9.472-11.36-9.472v5.664q-2.688 0-5.152 1.056t-4.224 2.848-2.848 4.224-1.024 5.152zM32 22.080v0 0 0z&quot;&gt;
            &lt;/path&gt;
          &lt;/svg&gt;
        &lt;/span&gt;
      &lt;/span&gt;
    &lt;/button&gt;

    &lt;a href=&quot;https://afdian.net/a/videotogether&quot; target=&quot;_blank&quot; id=&quot;vtDonate&quot; type=&quot;button&quot;
      class=&quot;vt-modal-donate vt-modal-title-button&quot;&gt;
      &lt;span class=&quot;vt-modal-close-x&quot;&gt;
        &lt;span role=&quot;img&quot; class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
          &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot;&gt;
            &lt;path fill=&quot;currentColor&quot;
              d=&quot;M12 4.435c-1.989-5.399-12-4.597-12 3.568 0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-8.118-10-8.999-12-3.568z&quot; /&gt;
          &lt;/svg&gt;
        &lt;/span&gt;
      &lt;/span&gt;
    &lt;/a&gt;

    &lt;a href=&quot;https://setting.2gether.video/&quot; target=&quot;_blank&quot; id=&quot;videoTogetherSetting&quot; type=&quot;button&quot;
      aria-label=&quot;Setting&quot; class=&quot;vt-modal-setting vt-modal-title-button&quot;&gt;
      &lt;span class=&quot;vt-modal-close-x&quot;&gt;
        &lt;span role=&quot;img&quot; aria-label=&quot;Setting&quot; class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
          &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; viewBox=&quot;0 0 24 24&quot;&gt;
            &lt;path fill=&quot;currentColor&quot;
              d=&quot;M24 13.616v-3.232c-1.651-.587-2.694-.752-3.219-2.019v-.001c-.527-1.271.1-2.134.847-3.707l-2.285-2.285c-1.561.742-2.433 1.375-3.707.847h-.001c-1.269-.526-1.435-1.576-2.019-3.219h-3.232c-.582 1.635-.749 2.692-2.019 3.219h-.001c-1.271.528-2.132-.098-3.707-.847l-2.285 2.285c.745 1.568 1.375 2.434.847 3.707-.527 1.271-1.584 1.438-3.219 2.02v3.232c1.632.58 2.692.749 3.219 2.019.53 1.282-.114 2.166-.847 3.707l2.285 2.286c1.562-.743 2.434-1.375 3.707-.847h.001c1.27.526 1.436 1.579 2.019 3.219h3.232c.582-1.636.75-2.69 2.027-3.222h.001c1.262-.524 2.12.101 3.698.851l2.285-2.286c-.744-1.563-1.375-2.433-.848-3.706.527-1.271 1.588-1.44 3.221-2.021zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z&quot; /&gt;
          &lt;/svg&gt;
        &lt;/span&gt;
      &lt;/span&gt;
    &lt;/a&gt;
    &lt;button id=&quot;videoTogetherMinimize&quot; type=&quot;button&quot; aria-label=&quot;Close&quot; class=&quot;vt-modal-close vt-modal-title-button&quot;&gt;
      &lt;span class=&quot;vt-modal-close-x&quot;&gt;
        &lt;span role=&quot;img&quot; aria-label=&quot;close&quot; class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
          &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; aria-hidden=&quot;true&quot;
            role=&quot;img&quot; class=&quot;iconify iconify--ic&quot; width=&quot;20&quot; height=&quot;20&quot; preserveAspectRatio=&quot;xMidYMid meet&quot;
            viewBox=&quot;0 0 24 24&quot;&gt;
            &lt;path fill=&quot;currentColor&quot; d=&quot;M18 12.998H6a1 1 0 0 1 0-2h12a1 1 0 0 1 0 2z&quot;&gt;&lt;/path&gt;
          &lt;/svg&gt;
        &lt;/span&gt;
      &lt;/span&gt;
    &lt;/button&gt;
  &lt;/div&gt;

  &lt;div class=&quot;vt-modal-content&quot;&gt;

    &lt;div class=&quot;vt-modal-body&quot;&gt;
      &lt;div id=&quot;mainPannel&quot; class=&quot;content&quot;&gt;
        &lt;div style=&quot;height: 22.5px;&quot;&gt;
          &lt;span id=&quot;videoTogetherRoleText&quot;&gt;&lt;/span&gt;
          &lt;span id=&quot;memberCount&quot;&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div id=&quot;videoTogetherStatusText&quot; style=&quot;height: 22.5px;&quot;&gt;&lt;/div&gt;
        &lt;div style=&quot;margin-bottom: 10px;&quot;&gt;
          &lt;span id=&quot;videoTogetherRoomNameLabel&quot;&gt;Room&lt;/span&gt;
          &lt;input id=&quot;videoTogetherRoomNameInput&quot; autocomplete=&quot;off&quot; placeholder=&quot;Name of room&quot;&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;span id=&quot;videoTogetherRoomPasswordLabel&quot;&gt;Password&lt;/span&gt;
          &lt;input id=&quot;videoTogetherRoomPasswordInput&quot; autocomplete=&quot;off&quot; placeholder=&quot;Host&#39;s password&quot;&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div id=&quot;textMessageChat&quot; style=&quot;display: none;&quot;&gt;
            &lt;input id=&quot;textMessageInput&quot; autocomplete=&quot;off&quot; placeholder=&quot;Text Message&quot;&gt;
            &lt;button id=&quot;textMessageSend&quot; class=&quot;vt-btn vt-btn-primary&quot; type=&quot;button&quot;&gt;
              &lt;span&gt;Send&lt;/span&gt;
            &lt;/button&gt;
          &lt;/div&gt;
          &lt;div id=&quot;textMessageConnecting&quot; style=&quot;display: none;&quot;&gt;
            &lt;span id=&quot;textMessageConnectingStatus&quot;&gt;Connecting to Message service...&lt;/span&gt;
            &lt;span id=&quot;zhcnTtsMissing&quot;&gt;&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div id=&quot;downloadPannel&quot; style=&quot;display: none;&quot;&gt;
        &lt;div&gt;
          &lt;span id=&quot;downloadVideoInfo&quot;&gt;Detecting video...&lt;/span&gt;
          &lt;button id=&quot;confirmDownloadBtn&quot; style=&quot;display: none;&quot; class=&quot;vt-btn vt-btn-primary&quot; type=&quot;button&quot;&gt;
            &lt;span&gt;Confirm and download&lt;/span&gt;
          &lt;/button&gt;
          &lt;div id=&quot;downloadProgress&quot; style=&quot;display: none;&quot;&gt;
            &lt;progress id=&quot;downloadProgressBar&quot; style=&quot;width: 100%;&quot; value=&quot;0&quot; max=&quot;100&quot;&gt;&lt;/progress&gt;
            &lt;div id=&quot;speedAndStatus&quot; style=&quot;width: 100%;&quot;&gt;
              &lt;span id=&quot;downloadStatus&quot;&gt;&lt;/span&gt;
              &lt;span id=&quot;downloadSpeed&quot;&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;span id=&quot;downloadingAlert&quot; style=&quot;color: red;&quot;&gt;Downloading, do not close page&lt;/span&gt;
            &lt;span id=&quot;downloadCompleted&quot; style=&quot;color: green; display: none;&quot;&gt;Download complete&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div style=&quot;display: block;&quot;&gt;
          &lt;a target=&quot;_blank&quot; style=&quot;display: block;padding: 5px 5px;&quot;
            href=&quot;https://local.2gether.video/local_videos.en-us.html&quot;&gt;View downloaded videos&lt;/a&gt;
          &lt;a target=&quot;_blank&quot; style=&quot;display: block;padding: 5px 5px;&quot;
            href=&quot;https://local.2gether.video/about.en-us.html&quot;&gt;Copyright Notice&lt;/a&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;voicePannel&quot; class=&quot;content&quot; style=&quot;display: none;&quot;&gt;
        &lt;div id=&quot;videoVolumeCtrl&quot; style=&quot;margin-top: 5px;width: 100%;text-align: left;&quot;&gt;
          &lt;span style=&quot;margin-top: 5px;display: inline-block;width: 100px;margin-left: 20px;&quot;&gt;Video volume&lt;/span&gt;
          &lt;div class=&quot;range-slider&quot;&gt;
            &lt;input id=&quot;videoVolume&quot; class=&quot;slider&quot; type=&quot;range&quot; value=&quot;100&quot; min=&quot;0&quot; max=&quot;100&quot;&gt;
          &lt;/div&gt;

        &lt;/div&gt;
        &lt;div id=&quot;callVolumeCtrl&quot; style=&quot;margin-top: 5px;width: 100%;text-align: left;&quot;&gt;
          &lt;span style=&quot;margin-top: 5px;display: inline-block;width: 100px;margin-left: 20px;&quot;&gt;Call Volume&lt;/span&gt;
          &lt;div class=&quot;range-slider&quot;&gt;
            &lt;input id=&quot;callVolume&quot; class=&quot;slider&quot; type=&quot;range&quot; value=&quot;100&quot; min=&quot;0&quot; max=&quot;100&quot;&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div id=&quot;iosVolumeErr&quot; style=&quot;display: none;&quot;&gt;
          &lt;p&gt;iOS does not support volume adjustment&lt;/p&gt;
        &lt;/div&gt;
        &lt;!-- &lt;div style=&quot;margin-top: 5px;width: 100%;text-align: left;&quot;&gt;
          &lt;span
            style=&quot;margin-top: 0px;display: inline-block;margin-left: 20px; margin-right: 10px;&quot;&gt;Noise cancelling voice&lt;/span&gt;
          &lt;label class=&quot;toggler-wrapper style-1&quot;&gt;
            &lt;input id=&quot;voiceNc&quot; type=&quot;checkbox&quot;&gt;
            &lt;div class=&quot;toggler-slider&quot;&gt;
              &lt;div class=&quot;toggler-knob&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/label&gt;

        &lt;/div&gt; --&gt;
      &lt;/div&gt;

    &lt;/div&gt;

    &lt;div id=&quot;snackbar&quot;&gt;&lt;/div&gt;

    &lt;div class=&quot;vt-modal-footer&quot;&gt;

      &lt;div id=&quot;lobbyBtnGroup&quot;&gt;
        &lt;button id=&quot;videoTogetherCreateButton&quot; class=&quot;vt-btn vt-btn-primary&quot; type=&quot;button&quot;&gt;
          &lt;span&gt;Create&lt;/span&gt;
        &lt;/button&gt;
        &lt;button id=&quot;videoTogetherJoinButton&quot; class=&quot;vt-btn vt-btn-secondary&quot; type=&quot;button&quot;&gt;
          &lt;span&gt;Join&lt;/span&gt;
        &lt;/button&gt;
      &lt;/div&gt;


      &lt;div id=&quot;roomButtonGroup&quot; style=&quot;display: none;&quot;&gt;

        &lt;button id=&quot;videoTogetherExitButton&quot; class=&quot;vt-btn vt-btn-dangerous&quot; type=&quot;button&quot;&gt;
          &lt;span&gt;Exit&lt;/span&gt;
        &lt;/button&gt;

        &lt;button id=&quot;callBtn&quot; class=&quot;vt-btn vt-btn-dangerous&quot; type=&quot;button&quot;&gt;
          &lt;span&gt;Call&lt;/span&gt;
        &lt;/button&gt;


        &lt;div id=&quot;callConnecting&quot; class=&quot;lds-ellipsis&quot; style=&quot;display: none;&quot;&gt;
          &lt;div&gt;&lt;/div&gt;
          &lt;div&gt;&lt;/div&gt;
          &lt;div&gt;&lt;/div&gt;
          &lt;div&gt;&lt;/div&gt;
        &lt;/div&gt;

        &lt;button id=&quot;callErrorBtn&quot; class=&quot;vt-modal-title-button error-button&quot; style=&quot;display: none;&quot;&gt;
          &lt;svg width=&quot;24px&quot; height=&quot;24px&quot; viewBox=&quot;0 0 24 24&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
            &lt;path fill=&quot;currentColor&quot; d=&quot;M11.001 10h2v5h-2zM11 16h2v2h-2z&quot; /&gt;
            &lt;path fill=&quot;currentColor&quot;
              d=&quot;M13.768 4.2C13.42 3.545 12.742 3.138 12 3.138s-1.42.407-1.768 1.063L2.894 18.064a1.986 1.986 0 0 0 .054 1.968A1.984 1.984 0 0 0 4.661 21h14.678c.708 0 1.349-.362 1.714-.968a1.989 1.989 0 0 0 .054-1.968L13.768 4.2zM4.661 19 12 5.137 19.344 19H4.661z&quot; /&gt;
          &lt;/svg&gt;
        &lt;/button&gt;

        &lt;button id=&quot;audioBtn&quot; style=&quot;display: none;&quot; type=&quot;button&quot; aria-label=&quot;Close&quot;
          class=&quot;vt-modal-audio vt-modal-title-button&quot;&gt;
          &lt;span class=&quot;vt-modal-close-x&quot;&gt;
            &lt;span class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
              &lt;svg width=&quot;24px&quot; height=&quot;24px&quot; viewBox=&quot;0 0 489.6 489.6&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
                &lt;path stroke=&quot;currentColor&quot; stroke-width=&quot;16&quot; fill=&quot;currentColor&quot; d=&quot;M361.1,337.6c2.2,1.5,4.6,2.3,7.1,2.3c3.8,0,7.6-1.8,10-5.2c18.7-26.3,28.5-57.4,28.5-89.9s-9.9-63.6-28.5-89.9
                c-3.9-5.5-11.6-6.8-17.1-2.9c-5.5,3.9-6.8,11.6-2.9,17.1c15.7,22.1,24,48.3,24,75.8c0,27.4-8.3,53.6-24,75.8
                C354.3,326.1,355.6,333.7,361.1,337.6z&quot; /&gt;
                &lt;path stroke=&quot;currentColor&quot; stroke-width=&quot;16&quot; fill=&quot;currentColor&quot; d=&quot;M425.4,396.3c2.2,1.5,4.6,2.3,7.1,2.3c3.8,0,7.6-1.8,10-5.2c30.8-43.4,47.1-94.8,47.1-148.6s-16.3-105.1-47.1-148.6
                c-3.9-5.5-11.6-6.8-17.1-2.9c-5.5,3.9-6.8,11.6-2.9,17.1c27.9,39.3,42.6,85.7,42.6,134.4c0,48.6-14.7,95.1-42.6,134.4
                C418.6,384.7,419.9,392.3,425.4,396.3z&quot; /&gt;
                &lt;path stroke=&quot;currentColor&quot; stroke-width=&quot;16&quot; fill=&quot;currentColor&quot;
                  d=&quot;M254.7,415.7c4.3,2.5,9.2,3.8,14.2,3.8l0,0c7.4,0,14.4-2.8,19.7-7.9c5.6-5.4,8.7-12.6,8.7-20.4V98.5
                c0-15.7-12.7-28.4-28.4-28.4c-4.9,0-9.8,1.3-14.2,3.8c-0.3,0.2-0.6,0.3-0.8,0.5l-100.1,69.2H73.3C32.9,143.6,0,176.5,0,216.9v55.6
                c0,40.4,32.9,73.3,73.3,73.3h84.5l95.9,69.2C254,415.3,254.4,415.5,254.7,415.7z M161.8,321.3H73.3c-26.9,0-48.8-21.9-48.8-48.8
                v-55.6c0-26.9,21.9-48.8,48.8-48.8h84.3c2.5,0,4.9-0.8,7-2.2l102.7-71c0.5-0.3,1.1-0.4,1.6-0.4c1.6,0,3.9,1.2,3.9,3.9v292.7
                c0,1.1-0.4,2-1.1,2.8c-0.7,0.7-1.8,1.1-2.7,1.1c-0.5,0-1-0.1-1.5-0.3l-98.4-71.1C166.9,322.1,164.4,321.3,161.8,321.3z&quot; /&gt;
              &lt;/svg&gt;
            &lt;/span&gt;
          &lt;/span&gt;
        &lt;/button&gt;
      &lt;/div&gt;

      &lt;button id=&quot;micBtn&quot; style=&quot;display: none;&quot; type=&quot;button&quot; aria-label=&quot;Close&quot;
        class=&quot;vt-modal-mic vt-modal-title-button&quot;&gt;
        &lt;span class=&quot;vt-modal-close-x&quot;&gt;
          &lt;span class=&quot;vt-anticon vt-anticon-close vt-modal-close-icon&quot;&gt;
            &lt;svg width=&quot;24px&quot; height=&quot;24px&quot; viewBox=&quot;0 0 48 48&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
              &lt;rect width=&quot;48&quot; height=&quot;48&quot; fill=&quot;white&quot; fill-opacity=&quot;0&quot; /&gt;
              &lt;path
                d=&quot;M31 24V11C31 7.13401 27.866 4 24 4C20.134 4 17 7.13401 17 11V24C17 27.866 20.134 31 24 31C27.866 31 31 27.866 31 24Z&quot;
                stroke=&quot;currentColor&quot; stroke-width=&quot;4&quot; stroke-linejoin=&quot;round&quot; /&gt;
              &lt;path d=&quot;M9 23C9 31.2843 15.7157 38 24 38C32.2843 38 39 31.2843 39 23&quot; stroke=&quot;currentColor&quot;
                stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; /&gt;
              &lt;path d=&quot;M24 38V44&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot;
                stroke-linejoin=&quot;round&quot; /&gt;
              &lt;path id=&quot;disabledMic&quot; d=&quot;M42 42L6 6&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot;
                stroke-linejoin=&quot;round&quot; /&gt;
            &lt;/svg&gt;
            &lt;svg id=&quot;enabledMic&quot; style=&quot;display: none;&quot; width=&quot;24px&quot; height=&quot;24px&quot; viewBox=&quot;0 0 48 48&quot; fill=&quot;none&quot;
              xmlns=&quot;http://www.w3.org/2000/svg&quot;&gt;
              &lt;rect width=&quot;48&quot; height=&quot;48&quot; fill=&quot;white&quot; fill-opacity=&quot;0&quot; /&gt;
              &lt;path
                d=&quot;M31 24V11C31 7.13401 27.866 4 24 4C20.134 4 17 7.13401 17 11V24C17 27.866 20.134 31 24 31C27.866 31 31 27.866 31 24Z&quot;
                stroke=&quot;currentColor&quot; stroke-width=&quot;4&quot; stroke-linejoin=&quot;round&quot; /&gt;
              &lt;path d=&quot;M9 23C9 31.2843 15.7157 38 24 38C32.2843 38 39 31.2843 39 23&quot; stroke=&quot;currentColor&quot;
                stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; /&gt;
              &lt;path d=&quot;M24 38V44&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;4&quot; stroke-linecap=&quot;round&quot;
                stroke-linejoin=&quot;round&quot; /&gt;
            &lt;/svg&gt;
          &lt;/span&gt;
        &lt;/span&gt;
      &lt;/button&gt;

      &lt;button id=&quot;videoTogetherHelpButton&quot; class=&quot;vt-btn&quot; type=&quot;button&quot;&gt;
        &lt;span&gt;Help&lt;/span&gt;
      &lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
&lt;div style=&quot;width: 24px; height: 24px;&quot; id=&quot;videoTogetherSamllIcon&quot;&gt;
  &lt;img draggable=&quot;false&quot; width=&quot;24px&quot; height=&quot;24px&quot; id=&quot;videoTogetherMaximize&quot;
    src=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACrFBMVEXg9b7e87jd87jd9Lnd9Lre9Lng9b/j98jm98vs99fy9ubu89/e1sfJqKnFnqLGoaXf9Lvd87Xe87fd8rfV67Ti9sbk98nm9sze48TX3rjU1rTKr6jFnaLe9Lfe87Xe9LjV7LPN4q3g78PJuqfQ1a7OzarIsabEnaHi9sXd8rvd8rbd87axx4u70Jrl+cvm+szQxq25lZTR1a7KvaXFo6LFnaHEnKHd6r3Y57TZ7bLb8bTZ7rKMomClun/k+MrOx6yue4PIvqfP06vLv6fFoqLEnKDT27DS3a3W6K7Y7bDT6auNq2eYn3KqlYShYXTOwLDAzZ7MyanKtqbEoaHDm6DDm5/R2K3Q2KzT4q3W6a7P3amUhWp7SEuMc2rSyri3zJe0xpPV17TKuqbGrqLEnqDQ2K3O06rP0arR2qzJx6GZX160j4rP1LOiuH2GnVzS3rXb47zQ063OzanHr6PDnaDMxajIsaXLwKfEt5y6mI/GyqSClVZzi0bDzp+8nY/d6L/X4rbQ1qzMyKjEqKHFpqLFpaLGqaO2p5KCjlZ5jky8z5izjoOaXmLc5r3Z57jU4K7S3K3NyqnBm56Mg2KTmWnM0KmwhH2IOUunfXnh8cXe8b7Z7LPV4rDBmZ3Cmp+6mZWkk32/qZihbG97P0OdinXQ3rTk+Mjf9L/d8rja6ri9lpqnh4qhgoWyk5Kmd3qmfHW3oou2vZGKpmaUrXDg9MPf9L3e876yj5Ori42Mc3aDbG6MYmyifXfHyaPU3rHH0aKDlVhkejW70Zbf9bze87be87ng9cCLcnWQd3qEbG9/ZmmBXmSflYS4u5ra5Lnd6r7U5ba2ypPB153c87re9b2Ba22EbW+AamyDb3CNgXmxsZng7sTj9sjk98rk+Mng9cHe9Lze9Lrd87n////PlyWlAAAAAWJLR0TjsQauigAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB+YGGQYXBzHy0g0AAAEbSURBVBjTARAB7/4AAAECAwQFBgcICQoLDA0ODwAQEREREhMUFRYXGBkaGxwOAAYdHhEfICEWFiIjJCUmDicAKCkqKx8sLS4vMDEyMzQ1NgA3ODk6Ozw9Pj9AQUJDRDVFAEZHSElKS0xNTk9QUVJTVFUAVldYWVpbXF1eX2BhYmNkVABlZmdoaWprbG1ub3BxcnN0AEJ1dnd4eXp7fH1+f4CBgoMAc4QnhYaHiImKi4yNjo+QkQBFVFU2kpOUlZaXmJmam5ucAFRVnZ6foKGio6SlpqeoE6kAVaqrrK2ur7CxsrO0tQEDtgC3uLm6u7y9vr/AwcLDxMXGAMfIycrLzM3Oz9DR0tMdAdQA1da619jZ2tvc3d7f4OEB4iRLaea64H7qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIyLTA2LTI1VDA2OjIzOjAyKzAwOjAwlVQlhgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMi0wNi0yNVQwNjoyMzowMiswMDowMOQJnToAAAAgdEVYdHNvZnR3YXJlAGh0dHBzOi8vaW1hZ2VtYWdpY2sub3JnvM8dnQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMTkyQF1xVQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE2NTYxMzgxODJHYkS0AAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjItMDYtMjUvNGU5YzJlYjRjNmRhMjIwZDgzYjcyOTYxZmI1ZTJiY2UuaWNvLnBuZ7tNVVEAAAAASUVORK5CYII=&quot;&gt;
  &lt;/img&gt;
&lt;/div&gt;

&lt;style&gt;
  #videoTogetherFlyPannel {
    background-color: #ffffff !important;
    display: block;
    z-index: 2147483647;
    position: fixed;
    bottom: 15px;
    right: 15px;
    width: 260px;
    height: 210px;
    text-align: center;
    border: solid 1px #e9e9e9 !important;
    box-shadow: 0 3px 6px -4px #0000001f, 0 6px 16px #00000014, 0 9px 28px 8px #0000000d;
    border-radius: 10px;
    line-height: 1.2;
  }

  #videoTogetherFlyPannel #videoTogetherHeader {
    cursor: move;
    touch-action: none;
    align-items: center;
    display: flex;
  }

  .vt-modal-content {
    /* position: relative; */
    width: 100%;
    height: 100%;
  }

  #roomButtonGroup,
  #lobbyBtnGroup,
  .content {
    display: contents;
  }

  .vt-modal-audio {
    position: absolute;
    top: 10px;
    right: 140px;
  }

  .vt-modal-mic {
    position: absolute;
    top: 10px;
    right: 100px;
  }

  .vt-modal-setting {
    position: absolute;
    top: -1px;
    right: 65px;
  }

  .vt-modal-easyshare {
    position: absolute;
    top: -1px;
    right: 90px;
  }

  .vt-modal-donate {
    position: absolute;
    top: -1px;
    right: 40px;
  }

  .vt-modal-title-button {
    z-index: 10;
    padding: 0;
    color: #6c6c6c;
    font-weight: 700;
    line-height: 1;
    text-decoration: none;
    background: transparent;
    border: 0;
    outline: 0;
    cursor: pointer;
    transition: color .3s;
  }

  .vt-modal-close {
    position: absolute;
    top: 0;
    right: 15px;
  }

  .vt-modal-close-x {
    width: 18px;
    height: 46px;
    font-size: 16px;
    font-style: normal;
    line-height: 46px;
    text-align: center;
    text-transform: none;
    text-rendering: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .vt-modal-close-x:hover {
    color: #1890ff;
  }

  .error-button {
    color: #ff6f72;
  }

  .error-button:hover {
    color: red;
  }

  .vt-modal-header {
    display: flex;
    padding: 12px;
    color: #000000d9;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
    border-radius: 10px 10px 0 0;
    align-items: center;
  }

  .vt-modal-title {
    margin: 0;
    margin-left: 10px;
    color: #000000d9;
    font-weight: 500;
    font-size: 16px;
    line-height: 22px;
    word-wrap: break-word;
  }

  .vt-modal-body {
    height: 164px;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    font-size: 16px;
    color: black;
    border-radius: 0 0 10px 10px;
    background-size: cover;
  }

  .vt-modal-footer {
    padding: 10px 16px;
    text-align: right;
    background: transparent;
    border-top: 1px solid #f0f0f0;
    border-radius: 0 0 2px 2px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }

  .vt-btn {
    line-height: 1.5715;
    position: relative;
    display: inline-block;
    font-weight: 400;
    white-space: nowrap;
    text-align: center;
    background-image: none;
    border: 1px solid transparent;
    box-shadow: 0 2px #00000004;
    cursor: pointer;
    transition: all .3s cubic-bezier(.645, .045, .355, 1);
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
    touch-action: manipulation;
    height: 32px;
    padding: 4px 15px;
    font-size: 14px;
    border-radius: 2px;
    color: #000000d9;
    border-color: #d9d9d9;
    background: #fff;
    outline: 0;
    text-shadow: 0 -1px 0 rgb(0 0 0 / 12%);
    box-shadow: 0 2px #0000000b;
  }

  .vt-btn:hover {
    border-color: #e3e5e7 !important;
    background-color: #e3e5e7 !important;
  }

  .vt-btn-primary {
    color: #fff;
    border-color: #1890ff;
    background: #1890ff !important;
  }

  .vt-btn-primary:hover {
    border-color: #6ebff4 !important;
    background-color: #6ebff4 !important;
  }

  .vt-btn-secondary {
    color: #fff;
    border-color: #23d591;
    background: #23d591 !important;
  }

  .vt-btn-secondary:hover {
    border-color: #8af0bf !important;
    background-color: #8af0bf !important;
  }

  .vt-btn-dangerous {
    color: #fff;
    border-color: #ff4d4f;
    background-color: #ff4d4f;
  }

  .vt-btn-dangerous:hover {
    border-color: #f77173 !important;
    background-color: #f77173 !important;
  }

  .vt-modal-content-item {
    cursor: pointer;
    box-shadow: 0px 1px 4px 0px rgba(0, 0, 0, 0.16);
    padding: 0 12px;
    width: 45%;
    height: 60px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
  }

  .vt-modal-content-item:hover {
    background-color: #efefef;
  }

  #videoTogetherSamllIcon {
    z-index: 2147483647;
    position: fixed;
    bottom: 15px;
    right: 15px;
    text-align: center;
  }

  #videoTogetherRoomNameLabel,
  #videoTogetherRoomPasswordLabel {
    display: inline-block;
    width: 76px;
  }

  #videoTogetherRoomNameInput:disabled {
    border: none;
    background-color: transparent;
    color: black;
  }

  #videoTogetherRoomNameInput,
  #videoTogetherRoomPasswordInput {
    width: 150px;
    height: auto;
    font-family: inherit;
    font-size: inherit;
    display: inline-block;
    padding: 0;
    color: #00000073;
    background-color: #ffffff;
    border: 1px solid #e9e9e9;
    margin: 0;
  }

  .lds-ellipsis {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 32px;
  }

  .lds-ellipsis div {
    position: absolute;
    top: 8px;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #6c6c6c;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }

  .lds-ellipsis div:nth-child(1) {
    left: 8px;
    animation: lds-ellipsis1 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(2) {
    left: 8px;
    animation: lds-ellipsis2 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(3) {
    left: 32px;
    animation: lds-ellipsis2 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(4) {
    left: 56px;
    animation: lds-ellipsis3 0.6s infinite;
  }

  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }

    100% {
      transform: scale(1);
    }
  }

  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }

    100% {
      transform: scale(0);
    }
  }

  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }

    100% {
      transform: translate(24px, 0);
    }
  }




  .range-slider {
    margin: 0px 0 0 0px;
    display: inline-block;
  }

  .range-slider {
    width: 130px
  }

  .slider {
    -webkit-appearance: none;
    width: calc(100% - (0px));
    height: 5px;
    border-radius: 5px;
    background: #d7dcdf;
    outline: none;
    padding: 0;
    margin: 0;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    -webkit-transition: background 0.15s ease-in-out;
    transition: background 0.15s ease-in-out;
  }

  .slider::-moz-range-progress {
    background-color: #1abc9c;
  }

  .slider::-webkit-slider-thumb:hover {
    background: #1abc9c;
  }

  .slider:active::-webkit-slider-thumb {
    background: #1abc9c;
  }

  .slider::-moz-range-thumb {
    width: 10px;
    height: 10px;
    border: 0;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    -moz-transition: background 0.15s ease-in-out;
    transition: background 0.15s ease-in-out;
  }

  .slider::-moz-range-thumb:hover {
    background: #1abc9c;
  }

  .slider:active::-moz-range-thumb {
    background: #1abc9c;
  }

  ::-moz-range-track {
    background: #d7dcdf;
    border: 0;
  }

  input::-moz-focus-inner,
  input::-moz-focus-outer {
    border: 0;
  }



  .toggler-wrapper {
    display: inline-block;
    width: 45px;
    height: 20px;
    cursor: pointer;
    position: relative;
  }

  .toggler-wrapper input[type=&quot;checkbox&quot;] {
    display: none;
  }

  .toggler-wrapper input[type=&quot;checkbox&quot;]:checked+.toggler-slider {
    background-color: #1abc9c;
  }

  .toggler-wrapper .toggler-slider {
    margin-top: 4px;
    background-color: #ccc;
    position: absolute;
    border-radius: 100px;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    -webkit-transition: all 300ms ease;
    transition: all 300ms ease;
  }

  .toggler-wrapper .toggler-knob {
    position: absolute;
    -webkit-transition: all 300ms ease;
    transition: all 300ms ease;
  }

  .toggler-wrapper.style-1 input[type=&quot;checkbox&quot;]:checked+.toggler-slider .toggler-knob {
    left: calc(100% - 16px - 3px);
  }

  .toggler-wrapper.style-1 .toggler-knob {
    width: calc(20px - 6px);
    height: calc(20px - 6px);
    border-radius: 50%;
    left: 3px;
    top: 3px;
    background-color: #fff;
  }


  #snackbar {
    visibility: hidden;
    width: auto;
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 16px 0px 16px 0px;
    position: relative;
    z-index: 999999;
    top: -56px;
  }

  #snackbar.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
  }

  @keyframes fadein {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes fadeout {
    from {
      opacity: 1;
    }

    to {
      opacity: 0;
    }
  }

  #downloadProgress {
    display: flex;
    flex-direction: column;
    width: 80%;
    align-items: center;
    margin: auto;
  }

  #speedAndStatus {
    display: flex;
    justify-content: space-between;
  }

  #downloadPannel {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    justify-content: space-between;
  }

  #downloadVideoInfo {
    display: block;
  }
&lt;/style&gt;`;
                (document.body || document.documentElement).appendChild(shadowWrapper);

                wrapper.querySelector(&quot;#videoTogetherMinimize&quot;).onclick = () =&gt; { this.Minimize() }
                wrapper.querySelector(&quot;#videoTogetherMaximize&quot;).onclick = () =&gt; { this.Maximize() }
                [&quot;&quot;, &quot;webkit&quot;].forEach(prefix =&gt; {
                    document.addEventListener(prefix + &quot;fullscreenchange&quot;, (event) =&gt; {
                        if (document.fullscreenElement || document.webkitFullscreenElement) {
                            hide(this.videoTogetherFlyPannel);
                            hide(this.videoTogetherSamllIcon);
                        } else {
                            if (this.minimized) {
                                this.Minimize();
                            } else {
                                this.Maximize();
                            }
                        }
                    });
                });
                wrapper.querySelector(&quot;#textMessageInput&quot;).addEventListener(&quot;keyup&quot;, e =&gt; {
                    if (e.key == &quot;Enter&quot;) {
                        wrapper.querySelector(&quot;#textMessageSend&quot;).click();
                    }
                });
                wrapper.querySelector(&quot;#textMessageSend&quot;).onclick = async () =&gt; {
                    extension.currentSendingMsgId = generateUUID();
                    WS.sendTextMessage(extension.currentSendingMsgId, select(&quot;#textMessageInput&quot;).value);
                }
                this.lobbyBtnGroup = wrapper.querySelector(&quot;#lobbyBtnGroup&quot;);
                this.createRoomButton = wrapper.querySelector(&#39;#videoTogetherCreateButton&#39;);
                this.joinRoomButton = wrapper.querySelector(&quot;#videoTogetherJoinButton&quot;);
                this.roomButtonGroup = wrapper.querySelector(&#39;#roomButtonGroup&#39;);
                this.exitButton = wrapper.querySelector(&quot;#videoTogetherExitButton&quot;);
                this.callBtn = wrapper.querySelector(&quot;#callBtn&quot;);
                this.callBtn.onclick = () =&gt; Voice.join(&quot;&quot;, window.videoTogetherExtension.roomName);
                this.helpButton = wrapper.querySelector(&quot;#videoTogetherHelpButton&quot;);
                this.audioBtn = wrapper.querySelector(&quot;#audioBtn&quot;);
                this.micBtn = wrapper.querySelector(&quot;#micBtn&quot;);
                this.videoVolume = wrapper.querySelector(&quot;#videoVolume&quot;);
                this.callVolumeSlider = wrapper.querySelector(&quot;#callVolume&quot;);
                this.callErrorBtn = wrapper.querySelector(&quot;#callErrorBtn&quot;);
                this.easyShareCopyBtn = wrapper.querySelector(&quot;#easyShareCopyBtn&quot;);
                this.textMessageChat = wrapper.querySelector(&quot;#textMessageChat&quot;);
                this.textMessageConnecting = wrapper.querySelector(&quot;#textMessageConnecting&quot;);
                this.textMessageConnectingStatus = wrapper.querySelector(&quot;#textMessageConnectingStatus&quot;);
                this.zhcnTtsMissing = wrapper.querySelector(&quot;#zhcnTtsMissing&quot;);
                this.downloadBtn = wrapper.querySelector(&quot;#downloadBtn&quot;);
                hide(this.downloadBtn);
                this.confirmDownloadBtn = wrapper.querySelector(&quot;#confirmDownloadBtn&quot;)
                this.confirmDownloadBtn.onclick = () =&gt; {
                    if (extension.downloadM3u8UrlType == &quot;video&quot;) {
                        extension.Fetch(extension.video_together_host + &quot;/beta/counter?key=confirm_video_download&quot;)
                        console.log(extension.downloadM3u8Url, extension.downloadM3u8UrlType)
                        sendMessageToTop(MessageType.SetStorageValue, {
                            key: &quot;PublicNextDownload&quot;, value: {
                                filename: document.title + &#39;.mp4&#39;,
                                url: extension.downloadM3u8Url
                            }
                        });
                        const a = document.createElement(&quot;a&quot;);
                        a.href = extension.downloadM3u8Url;
                        a.target = &quot;_blank&quot;;
                        a.download = document.title + &quot;.mp4&quot;;
                        a.click();
                        return;
                    }
                    extension.Fetch(extension.video_together_host + &quot;/beta/counter?key=confirm_m3u8_download&quot;)
                    isDownloading = true;
                    const m3u8url = extension.downloadM3u8Url
                    sendMessageTo(extension.m3u8PostWindows[extension.GetM3u8WindowId(m3u8url)], MessageType.StartDownload, {
                        m3u8Url: m3u8url,
                        m3u8Content: extension.GetM3u8Content(m3u8url),
                        urls: extension.GetAllM3u8SegUrls(m3u8url),
                        title: document.title,
                        pageUrl: window.location.href
                    });

                    hide(this.confirmDownloadBtn);
                    show(select(&quot;#downloadProgress&quot;));
                }
                this.downloadBtn.onclick = () =&gt; {
                    setInterval(() =&gt; {
                        if (isDownloading) {
                            return;
                        }
                        if (extension.downloadM3u8Url != undefined) {
                            show(this.confirmDownloadBtn);
                            select(&#39;#downloadVideoInfo&#39;).innerText = getDurationStr(extension.downloadDuration);
                        } else {
                            hide(this.confirmDownloadBtn);
                            select(&#39;#downloadVideoInfo&#39;).innerText = &quot;Detecting video...&quot;
                        }
                    }, 1000);
                    inDownload = true;
                    this.inputRoomName.value = &quot;download_&quot; + generateUUID();
                    this.createRoomButton.click()
                    hide(select(&#39;.vt-modal-footer&#39;))
                    hide(select(&#39;#mainPannel&#39;))
                    show(select(&#39;#downloadPannel&#39;))
                }
                this.easyShareCopyBtn.onclick = async () =&gt; {
                    try {
                        await navigator.clipboard.writeText(&quot;Click the link to watch together with me: &lt;main_share_link&gt;&quot;
                            .replace(&quot;&lt;main_share_link&gt;&quot;, extension.generateEasyShareLink())
                            .replace(&quot;&lt;china_share_link&gt;&quot;, extension.generateEasyShareLink(true)));
                        popupError(&quot;Copied&quot;);
                    } catch {
                        popupError(&quot;Copy failed&quot;);
                    }
                }
                this.callErrorBtn.onclick = () =&gt; {
                    Voice.join(&quot;&quot;, window.videoTogetherExtension.roomName);
                }
                this.videoVolume.oninput = () =&gt; {
                    extension.videoVolume = this.videoVolume.value;
                    sendMessageToTop(MessageType.ChangeVideoVolume, { volume: extension.getVideoVolume() / 100 });
                }
                this.callVolumeSlider.oninput = () =&gt; {
                    extension.voiceVolume = this.callVolumeSlider.value;
                    [...select(&#39;#peer&#39;).querySelectorAll(&quot;*&quot;)].forEach(e =&gt; {
                        e.volume = extension.getVoiceVolume() / 100;
                    });
                }
                initRangeSlider(this.videoVolume);
                initRangeSlider(this.callVolumeSlider);
                this.audioBtn.onclick = async () =&gt; {
                    let hideMain = select(&#39;#mainPannel&#39;).style.display == &#39;none&#39;;

                    dsply(select(&#39;#mainPannel&#39;), hideMain);
                    dsply(select(&#39;#voicePannel&#39;), !hideMain);
                    if (!hideMain) {
                        this.audioBtn.style.color = &#39;#1890ff&#39;;
                    } else {
                        this.audioBtn.style.color = &#39;#6c6c6c&#39;;
                    }
                    if (await isAudioVolumeRO()) {
                        show(select(&#39;#iosVolumeErr&#39;));
                        hide(select(&#39;#videoVolumeCtrl&#39;));
                        hide(select(&#39;#callVolumeCtrl&#39;));
                    }
                }
                this.micBtn.onclick = async () =&gt; {
                    switch (Voice.status) {
                        case VoiceStatus.STOP: {
                            // TODO need fix
                            await Voice.join();
                            break;
                        }
                        case VoiceStatus.UNMUTED: {
                            Voice.mute();
                            break;
                        }
                        case VoiceStatus.MUTED: {
                            Voice.unmute();
                            break;
                        }
                    }
                }

                this.createRoomButton.onclick = this.CreateRoomButtonOnClick.bind(this);
                this.joinRoomButton.onclick = this.JoinRoomButtonOnClick.bind(this);
                this.helpButton.onclick = this.HelpButtonOnClick.bind(this);
                this.exitButton.onclick = (() =&gt; {
                    window.videoTogetherExtension.exitRoom();
                });
                this.videoTogetherRoleText = wrapper.querySelector(&quot;#videoTogetherRoleText&quot;)
                this.videoTogetherSetting = wrapper.querySelector(&quot;#videoTogetherSetting&quot;);
                hide(this.videoTogetherSetting);
                this.inputRoomName = wrapper.querySelector(&#39;#videoTogetherRoomNameInput&#39;);
                this.inputRoomPassword = wrapper.querySelector(&quot;#videoTogetherRoomPasswordInput&quot;);
                this.inputRoomNameLabel = wrapper.querySelector(&#39;#videoTogetherRoomNameLabel&#39;);
                this.inputRoomPasswordLabel = wrapper.querySelector(&quot;#videoTogetherRoomPasswordLabel&quot;);
                this.videoTogetherHeader = wrapper.querySelector(&quot;#videoTogetherHeader&quot;);
                this.videoTogetherFlyPannel = wrapper.getElementById(&quot;videoTogetherFlyPannel&quot;);
                this.videoTogetherSamllIcon = wrapper.getElementById(&quot;videoTogetherSamllIcon&quot;);

                this.volume = 1;
                this.statusText = wrapper.querySelector(&quot;#videoTogetherStatusText&quot;);
                this.InLobby(true);
                this.Init();
                setInterval(() =&gt; {
                    this.ShowPannel();
                }, 1000);
            }

            try {
                document.querySelector(&quot;#videoTogetherLoading&quot;).remove()
            } catch { }
        }

        ShowTxtMsgTouchPannel() {
            try {
                function exitFullScreen() {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) { /* Safari */
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) { /* Firefox */
                        document.mozCancelFullScreen();
                    }
                }
                exitFullScreen();
            } catch { }
            try {
                this.txtMsgTouchPannel.remove();
            } catch { }
            this.txtMsgTouchPannel = document.createElement(&#39;div&#39;);
            let touch = this.txtMsgTouchPannel;
            touch.id = &quot;videoTogetherTxtMsgTouch&quot;;
            touch.style.width = &quot;100%&quot;;
            touch.style.height = &quot;100%&quot;;
            touch.style.position = &quot;fixed&quot;;
            touch.style.top = &quot;0&quot;;
            touch.style.left = &quot;0&quot;;
            touch.style.zIndex = &quot;2147483647&quot;;
            touch.style.background = &quot;#fff&quot;;
            touch.style.display = &quot;flex&quot;;
            touch.style.justifyContent = &quot;center&quot;;
            touch.style.alignItems = &quot;center&quot;;
            touch.style.padding = &quot;0px&quot;;
            touch.style.flexDirection = &quot;column&quot;;
            touch.style.lineHeight = &quot;40px&quot;;
            AttachShadow(this.txtMsgTouchPannel, { mode: &quot;open&quot; })
            touch.addEventListener(&#39;click&#39;, function () {
                windowPannel.enableSpeechSynthesis();
                document.body.removeChild(touch);
                windowPannel.txtMsgTouchPannel = undefined;
            });
            document.body.appendChild(touch);

            this.setTxtMsgTouchPannelText(&quot;VideoTogether: You got a new message, click the screen to receive&quot;);
        }

        setTxtMsgInterface(type) {
            hide(this.textMessageChat);
            hide(this.textMessageConnecting);
            hide(this.textMessageConnectingStatus);
            hide(this.zhcnTtsMissing);
            if (type == 0) {

            }
            if (type == 1) {
                show(this.textMessageChat);
            }
            if (type == 2) {
                show(this.textMessageConnecting);
                this.textMessageConnectingStatus.innerText = &quot;Connecting to Message service...&quot;
                show(this.textMessageConnectingStatus);
            }
            if (type == 3) {
                show(this.textMessageConnecting);
                show(this.zhcnTtsMissing);
            }
            if (type == 4) {
                show(this.textMessageConnecting);
                this.textMessageConnectingStatus.innerText = &quot;Text Message is disabled&quot;
                show(this.textMessageConnectingStatus);
            }
        }

        enableSpeechSynthesis() {
            if (!extension.speechSynthesisEnabled) {
                try {
                    extension.gotTextMsg(&quot;&quot;, &quot;&quot;, true);
                    extension.speechSynthesisEnabled = true;
                } catch { }
            }
        }

        setTxtMsgTouchPannelText(s) {
            let span = document.createElement(&#39;span&#39;);
            span.style.fontSize = &quot;40px&quot;;
            span.style.lineHeight = &quot;40px&quot;;
            span.style.color = &quot;black&quot;;
            span.style.overflowWrap = &quot;break-word&quot;;
            span.style.textAlign = &quot;center&quot;;
            span.textContent = s;
            this.txtMsgTouchPannel.shadowRoot.appendChild(span);
            let voiceSelect = document.createElement(&#39;select&#39;);
            this.voiceSelect = voiceSelect;
            voiceSelect.onclick = (e) =&gt; {
                e.stopPropagation();
            }
            let label = span.cloneNode(true);
            label.textContent = &quot;You can select the voice for reading messages:&quot;;
            this.txtMsgTouchPannel.shadowRoot.appendChild(document.createElement(&#39;br&#39;));
            this.txtMsgTouchPannel.shadowRoot.appendChild(label);
            let voices = speechSynthesis.getVoices();
            voices.forEach(function (voice, index) {
                var option = document.createElement(&#39;option&#39;);
                option.value = voice.voiceURI;
                option.textContent = voice.name + &#39; (&#39; + voice.lang + &#39;)&#39;;
                voiceSelect.appendChild(option);
            });
            voiceSelect.oninput = (e) =&gt; {
                console.log(e);
                sendMessageToTop(MessageType.SetStorageValue, { key: &quot;PublicMessageVoice&quot;, value: voiceSelect.value });
            }
            voiceSelect.style.fontSize = &quot;20px&quot;;
            voiceSelect.style.height = &quot;50px&quot;;
            voiceSelect.style.maxWidth = &quot;100%&quot;;
            try {
                if (window.VideoTogetherStorage.PublicMessageVoice != undefined) {
                    voiceSelect.value = window.VideoTogetherStorage.PublicMessageVoice;
                } else {
                    voiceSelect.value = speechSynthesis.getVoices().find(v =&gt; v.default).voiceURI;
                }
            } catch { };
            this.txtMsgTouchPannel.shadowRoot.appendChild(voiceSelect)
        }

        ShowPannel() {
            if (!document.documentElement.contains(this.shadowWrapper)) {
                (document.body || document.documentElement).appendChild(this.shadowWrapper);
            }
        }

        Minimize(isDefault = false) {
            this.minimized = true;
            if (!isDefault) {
                this.SaveIsMinimized(true);
            }
            this.disableDefaultSize = true;
            hide(this.videoTogetherFlyPannel);
            show(this.videoTogetherSamllIcon);
        }

        Maximize(isDefault = false) {
            this.minimized = false;
            if (!isDefault) {
                this.SaveIsMinimized(false);
            }
            this.disableDefaultSize = true;
            show(this.videoTogetherFlyPannel);
            hide(this.videoTogetherSamllIcon);
        }

        SaveIsMinimized(minimized) {
            localStorage.setItem(&quot;VideoTogetherMinimizedHere&quot;, minimized ? 1 : 0)
        }

        Init() {
            let VideoTogetherMinimizedHere = localStorage.getItem(&quot;VideoTogetherMinimizedHere&quot;);
            if (VideoTogetherMinimizedHere == 0) {
                this.Maximize(true);
            } else if (VideoTogetherMinimizedHere == 1) {
                this.Minimize(true);
            }
        }

        InRoom() {
            try {
                speechSynthesis.getVoices();
            } catch { };
            this.Maximize();
            this.inputRoomName.disabled = true;
            hide(this.lobbyBtnGroup)
            show(this.roomButtonGroup);
            this.exitButton.style = &quot;&quot;;
            hide(this.inputRoomPasswordLabel);
            hide(this.inputRoomPassword);
            this.inputRoomName.placeholder = &quot;&quot;;
            this.isInRoom = true;
            hide(this.downloadBtn)
        }

        InLobby(init = false) {
            if (!init) {
                this.Maximize();
            }
            this.inputRoomName.disabled = false;
            this.inputRoomPasswordLabel.style.display = &quot;inline-block&quot;;
            this.inputRoomPassword.style.display = &quot;inline-block&quot;;
            this.inputRoomName.placeholder = &quot;Name of room&quot;
            show(this.lobbyBtnGroup);
            hide(this.roomButtonGroup);
            hide(this.easyShareCopyBtn);
            this.setTxtMsgInterface(0);
            dsply(this.downloadBtn, downloadEnabled())
            this.isInRoom = false;
        }

        CreateRoomButtonOnClick() {
            this.Maximize();
            let roomName = this.inputRoomName.value;
            let password = this.inputRoomPassword.value;
            window.videoTogetherExtension.CreateRoom(roomName, password);
        }

        JoinRoomButtonOnClick() {
            this.Maximize();
            let roomName = this.inputRoomName.value;
            let password = this.inputRoomPassword.value;
            window.videoTogetherExtension.JoinRoom(roomName, password);
        }

        HelpButtonOnClick() {
            this.Maximize();
            let url = &#39;https://2gether.video/guide/qa.html&#39;;
            if (vtRuntime == &quot;website&quot;) {
                url = &quot;https://2gether.video/guide/website_qa.html&quot;
            }
            window.open(url, &#39;_blank&#39;);
        }

        UpdateStatusText(text, color) {
            this.statusText.innerHTML = text;
            this.statusText.style.color = color;
        }
    }

    class VideoModel {
        constructor(id, duration, activatedTime, refreshTime, priority = 0) {
            this.id = id;
            this.duration = duration;
            this.activatedTime = activatedTime;
            this.refreshTime = refreshTime;
            this.priority = priority;
        }
    }

    let MessageType = {
        ActivatedVideo: 1,
        ReportVideo: 2,
        SyncMemberVideo: 3,
        SyncMasterVideo: 4,
        UpdateStatusText: 5,
        JumpToNewPage: 6,
        GetRoomData: 7,
        ChangeVoiceVolume: 8,
        ChangeVideoVolume: 9,

        FetchRequest: 13,
        FetchResponse: 14,

        SetStorageValue: 15,
        SyncStorageValue: 16,

        ExtensionInitSuccess: 17,

        SetTabStorage: 18,
        SetTabStorageSuccess: 19,

        UpdateRoomRequest: 20,
        CallScheduledTask: 21,

        RoomDataNotification: 22,
        UpdateMemberStatus: 23,
        TimestampV2Resp: 24,
        // EasyShareCheckSucc: 25,
        FetchRealUrlReq: 26,
        FetchRealUrlResp: 27,
        FetchRealUrlFromIframeReq: 28,
        FetchRealUrlFromIframeResp: 29,
        SendTxtMsg: 30,
        GotTxtMsg: 31,
        StartDownload: 32,
        DownloadStatus: 33,


        UpdateM3u8Files: 1001,

        SaveIndexedDb: 2001,
        ReadIndexedDb: 2002,
        SaveIndexedDbResult: 2003,
        ReadIndexedDbResult: 2004,
        RegexMatchKeysDb: 2005,
        RegexMatchKeysDbResult: 2006,
        DeleteFromIndexedDb: 2007,
        DeleteFromIndexedDbResult: 2008,
        StorageEstimate: 2009,
        StorageEstimateResult: 2010,
        ReadIndexedDbSw: 2011,
        ReadIndexedDbSwResult: 2012,
        //2013 used

        IosStorageSet: 3001,
        IosStorageSetResult: 3002,
        IosStorageGet: 3003,
        IosStorageGetResult: 3004,
        IosStorageDelete: 3005,
        IosStorageDeleteResult: 3006,
        IosStorageUsage: 3007,
        IosStorageUsageResult: 3008,
        IosStorageCompact: 3009,
        IosStorageDeletePrefix: 3010,
        IosStorageDeletePrefixResult: 3011,
    }

    let VIDEO_EXPIRED_SECOND = 10

    class VideoWrapper {
        set currentTime(v) {
            this.currentTimeSetter(v);
        }
        get currentTime() {
            return this.currentTimeGetter();
        }
        set playbackRate(v) {
            this.playbackRateSetter(v);
        }
        get playbackRate() {
            return this.playbackRateGetter();
        }
        constructor(play, pause, paused, currentTimeGetter, currentTimeSetter, duration, playbackRateGetter, playbackRateSetter) {
            this.play = play;
            this.pause = pause;
            this.paused = paused;
            this.currentTimeGetter = currentTimeGetter;
            this.currentTimeSetter = currentTimeSetter;
            this.duration = duration;
            this.playbackRateGetter = playbackRateGetter;
            this.playbackRateSetter = playbackRateSetter;
        }
    }

    class VideoTogetherExtension {

        constructor() {
            this.RoleEnum = {
                Null: 1,
                Master: 2,
                Member: 3,
            }
            this.cspBlockedHost = {};

            this.video_together_host = &#39;https://vt.panghair.com:5000/&#39;;
            this.video_together_main_host = &#39;https://vt.panghair.com:5000/&#39;;
            this.video_together_backup_host = &#39;https://api.chizhou.in/&#39;;
            this.video_tag_names = [&quot;video&quot;, &quot;bwp-video&quot;]

            this.timer = 0
            this.roomName = &quot;&quot;
            this.roomPassword = &quot;&quot;
            this.role = this.RoleEnum.Null
            this.url = &quot;&quot;
            this.duration = undefined
            this.waitForLoadding = false;
            this.playAfterLoadding = false;
            this.minTrip = 1e9;
            this.timeOffset = 0;
            this.lastScheduledTaskTs = 0;
            this.httpSucc = false;

            this.activatedVideo = undefined;
            this.tempUser = generateTempUserId();
            this.version = &#39;1696582274&#39;;
            this.isMain = (window.self == window.top);
            this.UserId = undefined;

            this.callbackMap = new Map;
            this.allLinksTargetModified = false;
            this.voiceVolume = null;
            this.videoVolume = null;
            this.m3u8Files = {};
            this.m3u8UrlTestResult = {};
            this.hasCheckedM3u8Url = {};
            this.m3u8PostWindows = {};
            this.m3u8MediaUrls = {};
            this.currentM3u8Url = undefined;
            this.ctxMemberCount = 0;
            this.downloadSpeedMb = 0;
            this.downloadPercentage = 0;
            this.currentSendingMsgId = null;

            this.isIos = undefined;
            this.speechSynthesisEnabled = false;
            // we need a common callback function to deal with all message
            this.SetTabStorageSuccessCallback = () =&gt; { };
            document.addEventListener(&quot;securitypolicyviolation&quot;, (e) =&gt; {
                let host = (new URL(e.blockedURI)).host;
                this.cspBlockedHost[host] = true;
            });
            try {
                this.CreateVideoDomObserver();
            } catch { }
            this.timer = setInterval(() =&gt; this.ScheduledTask(true), 2 * 1000);
            this.videoMap = new Map();
            window.addEventListener(&#39;message&#39;, message =&gt; {
                if (message.data.context) {
                    this.tempUser = message.data.context.tempUser;
                    this.videoTitle = message.data.context.videoTitle;
                    this.voiceStatus = message.data.context.voiceStatus;
                    this.timeOffset = message.data.context.timeOffset;
                    this.ctxRole = message.data.context.ctxRole;
                    this.ctxMemberCount = message.data.context.ctxMemberCount;
                    this.ctxWsIsOpen = message.data.context.ctxWsIsOpen;
                    // sub frame has 2 storage data source, top frame or extension.js in this frame
                    // this 2 data source should be same.
                    window.VideoTogetherStorage = message.data.context.VideoTogetherStorage;
                }
                this.processReceivedMessage(message.data.type, message.data.data, message);
            });
            try {
                navigator.serviceWorker.addEventListener(&#39;message&#39;, (message) =&gt; {
                    console.log(`Received a message from service worker: ${event.data}`);
                    this.processReceivedMessage(message.data.type, message.data.data, message);
                });
            } catch { };

            // if some element&#39;s click be invoked frequenctly, a lot of http request will be sent
            // window.addEventListener(&#39;click&#39;, message =&gt; {
            //     setTimeout(this.ScheduledTask.bind(this), 200);
            // })

            if (this.isMain) {
                try {
                    try {
                        this.RecoveryState();
                    } catch { }
                    this.EnableDraggable();

                    setTimeout(() =&gt; {
                        let allDoms = document.querySelectorAll(&quot;*&quot;);
                        for (let i = 0; i &lt; allDoms.length; i++) {
                            const cssObj = window.getComputedStyle(allDoms[i], null);
                            if (cssObj.getPropertyValue(&quot;z-index&quot;) == 2147483647 &amp;&amp; !allDoms[i].id.startsWith(&quot;videoTogether&quot;)) {
                                allDoms[i].style.zIndex = 2147483646;
                            }
                        }
                    }, 2000);
                } catch (e) { console.error(e) }
            }
        }

        async gotTextMsg(id, msg, prepare = false, idx = -1) {
            if (idx &gt; speechSynthesis.getVoices().length) {
                return;
            }
            if (!prepare &amp;&amp; !extension.speechSynthesisEnabled) {
                windowPannel.ShowTxtMsgTouchPannel();
                for (let i = 0; i &lt;= 1000 &amp;&amp; !extension.speechSynthesisEnabled; i++) {
                    await new Promise(r =&gt; setTimeout(r, 100));
                }
            }
            try {
                if (id == this.currentSendingMsgId &amp;&amp; msg == select(&quot;#textMessageInput&quot;).value) {
                    select(&quot;#textMessageInput&quot;).value = &quot;&quot;;
                }
            } catch { }
            let ssu = new SpeechSynthesisUtterance();
            ssu.text = msg;
            ssu.volume = 1;
            ssu.rate = 1;
            ssu.pitch = 1;
            if (idx == -1) {
                try {
                    ssu.voice = speechSynthesis.getVoices().find(v =&gt; v.voiceURI == window.VideoTogetherStorage.PublicMessageVoice);
                } catch { }
            } else {
                ssu.voice = speechSynthesis.getVoices()[idx];
            }
            if (!prepare) {
                let startTs = 0;
                ssu.onstart = (e =&gt; { startTs = e.timeStamp });
                ssu.onend = (e =&gt; {
                    const duration = e.timeStamp - startTs;
                    if (duration &lt; 100) {
                        this.gotTextMsg(id, msg, prepare, idx + 1);
                    }
                });
            }
            speechSynthesis.speak(ssu);
        }

        setRole(role) {
            let setRoleText = text =&gt; {
                window.videoTogetherFlyPannel.videoTogetherRoleText.innerHTML = text;
            }
            this.role = role
            switch (role) {
                case this.RoleEnum.Master:
                    setRoleText(&quot;Host&quot;);
                    break;
                case this.RoleEnum.Member:
                    setRoleText(&quot;Member&quot;);
                    break;
                default:
                    setRoleText(&quot;&quot;);
                    break;
            }
        }

        generateEasyShareLink(china = false) {
            if (china) {
                return `https://videotogether.gitee.io/${language}/easyshare.html?VideoTogetherRole=3&amp;VideoTogetherRoomName=${this.roomName}&amp;VideoTogetherTimestamp=9999999999&amp;VideoTogetherUrl=&amp;VideoTogetherPassword=${this.password}`
            } else {
                return `https://2gether.video/${language}/easyshare.html?VideoTogetherRole=3&amp;VideoTogetherRoomName=${this.roomName}&amp;VideoTogetherTimestamp=9999999999&amp;VideoTogetherUrl=&amp;VideoTogetherPassword=${this.password}`;
            }
        }

        async Fetch(url, method = &#39;GET&#39;, data = null) {
            if (!extension.isMain) {
                console.error(&quot;fetch in child&quot;);
                throw new Error(&quot;fetch in child&quot;);
            }
            url = new URL(url);
            url.searchParams.set(&quot;version&quot;, this.version);
            try {
                url.searchParams.set(&quot;language&quot;, language);
                url.searchParams.set(&quot;voiceStatus&quot;, this.isMain ? Voice.status : this.voiceStatus);
                url.searchParams.set(&quot;loaddingVersion&quot;, window.VideoTogetherStorage.LoaddingVersion);
                url.searchParams.set(&quot;runtimeType&quot;, window.VideoTogetherStorage.UserscriptType);
            } catch (e) { }
            try {
                url.searchParams.set(&quot;userId&quot;, window.VideoTogetherStorage.PublicUserId);
            } catch (e) { }
            url = url.toString();
            let host = (new URL(url)).host;
            if (this.cspBlockedHost[host] || url.startsWith(&#39;http:&#39;)) {
                let id = generateUUID()
                return await new Promise((resolve, reject) =&gt; {
                    this.callbackMap.set(id, (data) =&gt; {
                        if (data.data) {
                            resolve({ json: () =&gt; data.data, status: 200 });
                        } else {
                            reject(new Error(data.error));
                        }
                        this.callbackMap.delete(id);
                    })
                    sendMessageToTop(MessageType.FetchRequest, {
                        id: id,
                        url: url.toString(),
                        method: method,
                        data: data,
                    });
                    setTimeout(() =&gt; {
                        try {
                            if (this.callbackMap.has(id)) {
                                this.callbackMap.get(id)({ error: &quot;timeout&quot; });
                            }
                        } finally {
                            this.callbackMap.delete(id);
                        }
                    }, 20000);
                });
            }

            try {
                if (/\{\s+\[native code\]/.test(Function.prototype.toString.call(window.fetch))) {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() =&gt; controller.abort(), 10000);
                    return await window.fetch(url, {
                        method: method,
                        body: data == null ? undefined : JSON.stringify(data),
                        signal: controller.signal
                    });
                } else {
                    GetNativeFunction();
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() =&gt; controller.abort(), 10000);
                    return await Global.NativeFetch.call(window, url, {
                        method: method,
                        body: data == null ? undefined : JSON.stringify(data),
                        signal: controller.signal
                    });
                }
            } catch (e) {
                const host = new URL(extension.video_together_host);
                const requestUrl = new URL(url);
                if (host.hostname == requestUrl.hostname) {
                    extension.httpSucc = false;
                }
                throw e;
            }
        }

        async ForEachVideo(func) {
            try {
                if (window.location.hostname.endsWith(&quot;iqiyi.com&quot;)) {
                    let video = document.querySelector(&#39;.iqp-player-videolayer-inner &gt; video&#39;);
                    if (video != null) {
                        video.VideoTogetherChoosed = true;
                        try { await func(video) } catch { };
                    }
                }
                // disneyplus
                if (window.location.hostname.endsWith(&quot;disneyplus.com&quot;)) {
                    try {
                        let ff = document.querySelector(&#39;.ff-10sec-icon&#39;);
                        let rr = document.querySelector(&#39;.rwd-10sec-icon&#39;);
                        let video = document.querySelector(&#39;video&#39;);
                        if (ff &amp;&amp; rr &amp;&amp; video) {
                            if (!video.videoTogetherVideoWrapper) {
                                video.videoTogetherVideoWrapper = new VideoWrapper();
                            }
                            let videoWrapper = video.videoTogetherVideoWrapper;
                            videoWrapper.play = async () =&gt; await video.play();
                            videoWrapper.pause = async () =&gt; await video.pause();
                            videoWrapper.paused = video.paused
                            videoWrapper.currentTimeGetter = () =&gt; video.currentTime;
                            videoWrapper.currentTimeSetter = (v) =&gt; {
                                let isFf = v &gt; video.currentTime;
                                let d = Math.abs(v - video.currentTime);
                                let clickTime = parseInt(d / 10);
                                if (clickTime &gt; 0) {
                                    console.log(clickTime);
                                }
                                for (let i = 0; i &lt; clickTime; i++) {
                                    isFf ? ff.click() : rr.click();
                                }
                                setTimeout(() =&gt; {
                                    isFf ? ff.click() : rr.click();
                                    if (!isVideoLoadded(video)) {
                                        console.log(&quot;loading&quot;);
                                        ff.click();
                                        rr.click();
                                    }
                                    setTimeout(() =&gt; {
                                        if (isVideoLoadded(video)) {
                                            video.currentTime = v;
                                        }
                                    }, 100);
                                }, 200);
                            }
                            videoWrapper.duration = video.duration;
                            videoWrapper.playbackRateGetter = () =&gt; video.playbackRate;
                            videoWrapper.playbackRateSetter = (v) =&gt; { video.playbackRate = v };
                            await func(videoWrapper);
                        }
                    } catch (e) { }
                }
                // Netflix
                if (window.location.hostname.endsWith(&quot;netflix.com&quot;)) {
                    try {
                        let videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer;
                        let player = videoPlayer.getVideoPlayerBySessionId(videoPlayer.getAllPlayerSessionIds()[0]);
                        if (!player.videoTogetherVideoWrapper) {
                            player.videoTogetherVideoWrapper = new VideoWrapper();
                        }
                        let videoWrapper = player.videoTogetherVideoWrapper;
                        videoWrapper.play = async () =&gt; await player.play();
                        videoWrapper.pause = async () =&gt; await player.pause();
                        videoWrapper.paused = player.isPaused()
                        videoWrapper.currentTimeGetter = () =&gt; player.getCurrentTime() / 1000;
                        videoWrapper.currentTimeSetter = (v) =&gt; player.seek(1000 * v);
                        videoWrapper.duration = player.getDuration() / 1000;
                        videoWrapper.playbackRateGetter = () =&gt; player.getPlaybackRate();
                        videoWrapper.playbackRateSetter = (v) =&gt; { player.setPlaybackRate(v) };
                        await func(videoWrapper);
                    } catch (e) { }
                }
                // 百度网盘
                if (window.location.host.includes(&#39;pan.baidu.com&#39;)) {
                    if (!this.BaiduPanPlayer) {
                        try {
                            if (document.querySelector(&#39;.vjs-controls-enabled&#39;).player != undefined) {
                                this.BaiduPanPlayer = document.querySelector(&#39;.vjs-controls-enabled&#39;).player;
                            }
                        } catch { }
                    }
                    if (this.BaiduPanPlayer) {
                        if (!this.BaiduPanPlayer.videoTogetherVideoWrapper) {
                            this.BaiduPanPlayer.videoTogetherVideoWrapper = new VideoWrapper();
                        }
                        let videoWrapper = this.BaiduPanPlayer.videoTogetherVideoWrapper;
                        videoWrapper.play = async () =&gt; await this.BaiduPanPlayer.play();
                        videoWrapper.pause = async () =&gt; await this.BaiduPanPlayer.pause();
                        videoWrapper.paused = this.BaiduPanPlayer.paused();
                        videoWrapper.currentTimeGetter = () =&gt; this.BaiduPanPlayer.currentTime();
                        videoWrapper.currentTimeSetter = (v) =&gt; this.BaiduPanPlayer.currentTime(v);
                        videoWrapper.duration = this.BaiduPanPlayer.duration();
                        videoWrapper.playbackRateGetter = () =&gt; this.BaiduPanPlayer.playbackRate();
                        videoWrapper.playbackRateSetter = (v) =&gt; this.BaiduPanPlayer.playbackRate(v);
                        await func(videoWrapper);
                    }
                }
            } catch (e) { }
            try {
                // 腾讯视频
                if (window.__PLAYER__ != undefined) {
                    if (window.__PLAYER__.videoTogetherVideoWrapper == undefined) {
                        window.__PLAYER__.videoTogetherVideoWrapper = new VideoWrapper();
                    }
                    let videoWrapper = window.__PLAYER__.videoTogetherVideoWrapper;
                    videoWrapper.play = async () =&gt; await window.__PLAYER__.corePlayer.play();
                    videoWrapper.pause = async () =&gt; await window.__PLAYER__.corePlayer.pause();
                    videoWrapper.paused = window.__PLAYER__.paused;
                    videoWrapper.currentTimeGetter = () =&gt; window.__PLAYER__.currentVideoInfo.playtime;
                    videoWrapper.currentTimeSetter = (v) =&gt; { if (!videoWrapper.videoTogetherPaused) { window.__PLAYER__.seek(v) } };
                    videoWrapper.duration = window.__PLAYER__.currentVideoInfo.duration;
                    videoWrapper.playbackRateGetter = () =&gt; window.__PLAYER__.playbackRate;
                    videoWrapper.playbackRateSetter = (v) =&gt; window.__PLAYER__.playbackRate = v;
                    await func(videoWrapper);
                }
            } catch (e) { };

            this.video_tag_names.forEach(async tag =&gt; {
                let videos = document.getElementsByTagName(tag);
                for (let i = 0; i &lt; videos.length; i++) {
                    try {
                        try {
                            if (videos[i].VideoTogetherDisabled) {
                                continue;
                            }
                        } catch { };
                        try {
                            if (window.location.hostname.endsWith(&#39;bilibili.com&#39;)) {
                                if (!!videos[i].closest(&#39;div.video-page-card-small&#39;) || !!videos[i].closest(&#39;div.feed-card&#39;)) {
                                    // this is a thumbnail video
                                    continue
                                }
                            }
                        } catch { }
                        await func(videos[i]);
                    } catch (e) { console.error(e) };
                }
            });
        }

        sendMessageToSonWithContext(type, data) {
            if (this.isMain) {
                this.ctxRole = this.role;
            }
            let iframs = document.getElementsByTagName(&quot;iframe&quot;);
            for (let i = 0; i &lt; iframs.length; i++) {
                PostMessage(iframs[i].contentWindow, {
                    source: &quot;VideoTogether&quot;,
                    type: type,
                    data: data,
                    context: {
                        tempUser: this.tempUser,
                        videoTitle: this.isMain ? document.title : this.videoTitle,
                        voiceStatus: this.isMain ? Voice.status : this.voiceStatus,
                        VideoTogetherStorage: window.VideoTogetherStorage,
                        timeOffset: this.timeOffset,
                        ctxRole: this.ctxRole,
                        ctxMemberCount: this.ctxMemberCount,
                        ctxWsIsOpen: this.ctxWsIsOpen
                    }
                });
                // console.info(&quot;send &quot;, type, iframs[i].contentWindow, data)
            }
        }

        async FetchRemoteRealUrl(m3u8Url, idx, originUrl) {
            if (realUrlCache[originUrl] != undefined) {
                return realUrlCache[originUrl];
            }
            if (this.isMain) {
                WS.urlReq(m3u8Url, idx, originUrl);
            } else {
                sendMessageToTop(MessageType.FetchRealUrlFromIframeReq, { m3u8Url: m3u8Url, idx: idx, origin: originUrl });
            }

            return new Promise((res, rej) =&gt; {
                let id = setInterval(() =&gt; {
                    if (realUrlCache[originUrl] != undefined) {
                        res(realUrlCache[originUrl]);
                        clearInterval(id);
                    }
                }, 200);
                setTimeout(() =&gt; {
                    clearInterval(id);
                    rej(null);
                }, 3000);
            });
        }

        async FetchRemoteM3u8Content(m3u8Url) {
            if (m3u8ContentCache[m3u8Url] != undefined) {
                return m3u8ContentCache[m3u8Url];
            }
            WS.m3u8ContentReq(m3u8Url);
            return new Promise((res, rej) =&gt; {
                let id = setInterval(() =&gt; {
                    if (m3u8ContentCache[m3u8Url] != undefined) {
                        res(m3u8ContentCache[m3u8Url]);
                        clearInterval(id);
                    }
                })
                setTimeout(() =&gt; {
                    clearInterval(id);
                    rej(null);
                }, 3000)
            })
        }

        GetM3u8Content(m3u8Url) {
            let m3u8Content = &quot;&quot;;
            for (let id in this.m3u8Files) {
                this.m3u8Files[id].forEach(m3u8 =&gt; {
                    if (m3u8Url == m3u8.m3u8Url) {
                        m3u8Content = m3u8.m3u8Content;
                    }
                })
            }
            return m3u8Content;
        }

        GetM3u8WindowId(m3u8Url) {
            let windowId = undefined;
            for (let id in this.m3u8Files) {
                this.m3u8Files[id].forEach(m3u8 =&gt; {
                    if (m3u8Url == m3u8.m3u8Url) {
                        windowId = id;
                    }
                })
            }
            return windowId;
        }

        UrlRequest(m3u8Url, idx, origin) {
            for (let id in this.m3u8Files) {
                this.m3u8Files[id].forEach(m3u8 =&gt; {
                    if (m3u8Url == m3u8.m3u8Url) {
                        let urls = extractMediaUrls(m3u8.m3u8Content, m3u8.m3u8Url);
                        let url = urls[idx];
                        sendMessageTo(this.m3u8PostWindows[id], MessageType.FetchRealUrlReq, { url: url, origin: origin });
                    }
                })
            }
        }

        async testM3u8OrVideoUrl(testUrl) {
            const onsecuritypolicyviolation = (e) =&gt; {
                if (e.blockedURI == testUrl) {
                    // m3u8 can always be fetched, because hls.js
                    this.m3u8UrlTestResult[testUrl] = &#39;video&#39;
                }
            }
            document.addEventListener(&quot;securitypolicyviolation&quot;, onsecuritypolicyviolation)
            if (this.m3u8UrlTestResult[testUrl] != undefined) {
                return this.m3u8UrlTestResult[testUrl];
            }
            function limitStream(stream, limit) {
                const reader = stream.getReader();
                let bytesRead = 0;

                return new ReadableStream({
                    async pull(controller) {
                        const { value, done } = await reader.read();

                        if (done || bytesRead &gt;= limit) {
                            controller.close();
                            return;
                        }

                        bytesRead += value.byteLength;
                        controller.enqueue(value);
                    },

                    cancel(reason) {
                        reader.cancel(reason);
                    }
                });
            }

            return new Promise((res, rej) =&gt; {
                const rtnType = (tp) =&gt; {
                    if (this.m3u8UrlTestResult[testUrl] == undefined) {
                        this.m3u8UrlTestResult[testUrl] = tp
                    }
                    res(this.m3u8UrlTestResult[testUrl])
                }
                const abortController = new AbortController();
                VideoTogetherFetch(testUrl, { signal: abortController.signal }).then(response =&gt; {
                    const contentType = response.headers.get(&#39;Content-Type&#39;)
                    if (contentType.startsWith(&#39;video/&#39;)) {
                        rtnType(&#39;video&#39;);
                    }
                    const limitedStream = limitStream(response.body, 1024); // Limit to 1024 bytes
                    return new Response(limitedStream, { headers: response.headers });
                }).then(r =&gt; r.text())
                    .then(async txt =&gt; {
                        abortController.abort();
                        if (isM3U8(txt)) {
                            rtnType(&#39;m3u8&#39;);
                        } else {
                            rtnType(&#39;video&#39;);
                        }
                    }).catch(e =&gt; {
                        if (testUrl.startsWith(&#39;blob&#39;)) {
                            rtnType(&#39;unknown&#39;);
                        } else {
                            rtnType(&#39;video&#39;);
                        }
                    }).finally(() =&gt; {
                        document.removeEventListener(&quot;securitypolicyviolation&quot;, onsecuritypolicyviolation)
                    })
            })
        }

        // download
        GetAllM3u8SegUrls(m3u8Url) {
            for (let id in this.m3u8Files) {
                for (let mid in this.m3u8Files[id]) {
                    let m3u8 = this.m3u8Files[id][mid]
                    if (m3u8Url == m3u8.m3u8Url) {
                        return extractMediaUrls(m3u8.m3u8Content, m3u8.m3u8Url);
                    }
                }
            }
        }

        // end of download

        UpdateStatusText(text, color) {
            if (window.self != window.top) {
                sendMessageToTop(MessageType.UpdateStatusText, { text: text + &quot;&quot;, color: color });
            } else {
                window.videoTogetherFlyPannel.UpdateStatusText(text + &quot;&quot;, color);
            }
        }

        async processReceivedMessage(type, data, _msg) {
            let _this = this;
            // console.info(&quot;get &quot;, type, window.location, data);
            switch (type) {
                case MessageType.CallScheduledTask:
                    this.ScheduledTask();
                    break;
                case MessageType.ActivatedVideo:
                    if (this.activatedVideo == undefined || this.activatedVideo.activatedTime &lt; data.activatedTime) {
                        this.activatedVideo = data;
                    }
                    break;
                case MessageType.ReportVideo:
                    this.videoMap.set(data.id, data);
                    break;
                case MessageType.SyncMasterVideo:
                    this.ForEachVideo(async video =&gt; {
                        if (video.VideoTogetherVideoId == data.video.id) {
                            try {
                                await this.SyncMasterVideo(data, video);
                            } catch (e) {
                                this.UpdateStatusText(e, &quot;red&quot;);
                            }
                        }
                    })
                    this.sendMessageToSonWithContext(type, data);
                    break;
                case MessageType.UpdateRoomRequest:
                    let m3u8Url = undefined;
                    try {
                        let d = NaN;
                        let selected = null;
                        for (let id in this.m3u8Files) {
                            this.m3u8Files[id].forEach(m3u8 =&gt; {
                                // here m3u8Url may be empty, may caused by the new response
                                // from limitedstream, but we have a new fetch after that,
                                // so we can always get the correct url.
                                if (isNaN(d) || Math.abs(data.duration - m3u8.duration) &lt;= d) {
                                    d = Math.abs(data.duration - m3u8.duration);
                                    selected = m3u8;
                                }
                                return;
                            })
                        }
                        if (d &lt; 3 || d / data.duration &lt; 0.03) {
                            m3u8Url = selected.m3u8Url;
                        }
                    } catch { }
                    if (data.m3u8Url == undefined) {
                        data.m3u8Url = m3u8Url;
                    } else {
                    }// data.m3u8Url may be a video file

                    if (data.m3u8UrlType == &#39;video&#39;) {
                        this.downloadM3u8Url = data.m3u8Url;
                        this.downloadM3u8UrlType = &#39;video&#39;;
                        this.downloadDuration = data.duration;
                    } else {
                        if (m3u8Url != undefined) {
                            this.downloadM3u8Url = m3u8Url;
                            this.downloadDuration = data.duration;
                            this.downloadM3u8UrlType = &#39;m3u8&#39;; // video or other
                        } else {
                            this.downloadM3u8Url = undefined;
                            this.downloadDuration = undefined;
                        }
                    }


                    if (!isEasyShareEnabled()) {
                        data.m3u8Url = &quot;&quot;;
                    }
                    try {
                        if (!isEmpty(data.m3u8Url) &amp;&amp; isEasyShareEnabled()) {
                            this.currentM3u8Url = data.m3u8Url;
                            show(windowPannel.easyShareCopyBtn);
                        } else {
                            this.currentM3u8Url = undefined;
                            hide(windowPannel.easyShareCopyBtn);
                        }
                    } catch { };
                    try {
                        await this.UpdateRoom(data.name, data.password, data.url, data.playbackRate, data.currentTime, data.paused, data.duration, data.localTimestamp, data.m3u8Url);
                        if (this.waitForLoadding) {
                            this.UpdateStatusText(&quot;wait for memeber loading&quot;, &quot;red&quot;);
                        } else {
                            _this.UpdateStatusText(&quot;Sync &quot; + _this.GetDisplayTimeText(), &quot;green&quot;);
                        }
                    } catch (e) {
                        this.UpdateStatusText(e, &quot;red&quot;);
                    }
                    break;
                case MessageType.SyncMemberVideo:
                    this.ForEachVideo(async video =&gt; {
                        if (video.VideoTogetherVideoId == data.video.id) {
                            try {
                                await this.SyncMemberVideo(data, video);
                            } catch (e) {
                                _this.UpdateStatusText(e, &quot;red&quot;);
                            }
                        }
                    })
                    this.sendMessageToSonWithContext(type, data);
                    break;
                case MessageType.GetRoomData:
                    this.duration = data[&quot;duration&quot;];
                    break;
                case MessageType.UpdateStatusText:
                    window.videoTogetherFlyPannel.UpdateStatusText(data.text, data.color);
                    break;
                case MessageType.JumpToNewPage:
                    window.location = data.url;
                    let currentUrl = new URL(window.location);
                    let newUrl = new URL(data.url);
                    if (newUrl.hash != &quot;&quot;) {
                        currentUrl.hash = &quot;&quot;;
                        newUrl.hash = &quot;&quot;;
                        if (currentUrl.href == newUrl.href) {
                            extension.url = data.url;
                            // window.location.reload();// for hash change
                        }
                    }
                    break;
                case MessageType.ChangeVideoVolume:
                    this.ForEachVideo(video =&gt; {
                        video.volume = data.volume;
                    });
                    this.sendMessageToSonWithContext(type, data);
                    break;
                case MessageType.FetchResponse: {
                    try {
                        this.callbackMap.get(data.id)(data);
                    } catch { };
                    break;
                }
                case MessageType.SyncStorageValue: {
                    window.VideoTogetherStorage = data;
                    if (!this.isMain) {
                        return;
                    }
                    try {
                        if (window.VideoTogetherStorage.PublicNextDownload.url == window.location.href
                            &amp;&amp; this.HasDownload != true) {
                            const a = document.createElement(&quot;a&quot;);
                            a.href = window.VideoTogetherStorage.PublicNextDownload.url;
                            a.download = window.VideoTogetherStorage.PublicNextDownload.filename;
                            a.click();
                            this.HasDownload = true;
                        }
                    } catch { }
                    try {
                        if (!this.RecoveryStateFromTab) {
                            this.RecoveryStateFromTab = true;
                            this.RecoveryState()
                        }
                    } catch (e) { };
                    try {
                        if (data.PublicMessageVoice != null) {
                            windowPannel.voiceSelect.value = data.PublicMessageVoice;
                        }
                    } catch { };
                    if (!window.videoTogetherFlyPannel.disableDefaultSize &amp;&amp; !window.VideoTogetherSettingEnabled) {
                        if (data.MinimiseDefault) {
                            window.videoTogetherFlyPannel.Minimize(true);
                        } else {
                            window.videoTogetherFlyPannel.Maximize(true);
                        }
                    }
                    if (typeof (data.PublicUserId) != &#39;string&#39; || data.PublicUserId.length &lt; 5) {
                        sendMessageToTop(MessageType.SetStorageValue, { key: &quot;PublicUserId&quot;, value: generateUUID() });
                    }
                    try {
                        if (window.VideoTogetherSettingEnabled == undefined) {
                            if (!isWeb()) {
                                window.videoTogetherFlyPannel.videoTogetherSetting.href = &quot;https://setting.2gether.video/v2.html&quot;;
                                show(select(&#39;#videoTogetherSetting&#39;));
                            } else {
                                // website
                                if (window.videoTogetherWebsiteSettingUrl != undefined) {
                                    window.videoTogetherFlyPannel.videoTogetherSetting.href = window.videoTogetherWebsiteSettingUrl;
                                    show(select(&#39;#videoTogetherSetting&#39;));
                                }
                            }
                        }
                    } catch (e) { }
                    try {
                        dsply(select(&#39;#downloadBtn&#39;), downloadEnabled() &amp;&amp; !windowPannel.isInRoom)
                    } catch { }

                    window.VideoTogetherSettingEnabled = true;
                    break;
                }
                case MessageType.SetTabStorageSuccess: {
                    this.SetTabStorageSuccessCallback();
                    break;
                }
                case MessageType.RoomDataNotification: {
                    if (data[&#39;uuid&#39;] != &quot;&quot;) {
                        roomUuid = data[&#39;uuid&#39;];
                    }
                    changeBackground(data[&#39;backgroundUrl&#39;]);
                    changeMemberCount(data[&#39;memberCount&#39;])
                    break;
                }
                case MessageType.UpdateMemberStatus: {
                    WS.updateMember(this.roomName, this.password, data.isLoadding, this.url);
                    break;
                }
                case MessageType.TimestampV2Resp: {
                    let l1 = data[&#39;data&#39;][&#39;sendLocalTimestamp&#39;];
                    let s1 = data[&#39;data&#39;][&#39;receiveServerTimestamp&#39;];
                    let s2 = data[&#39;data&#39;][&#39;sendServerTimestamp&#39;];
                    let l2 = data[&#39;ts&#39;]
                    this.UpdateTimestampIfneeded(s1, l1, l2 - s2 + s1);
                    break;
                }
                case MessageType.UpdateM3u8Files: {
                    data[&#39;m3u8Files&#39;].forEach(m3u8 =&gt; {
                        try {
                            const cyrb53 = (str, seed = 0) =&gt; {
                                let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
                                for (let i = 0, ch; i &lt; str.length; i++) {
                                    ch = str.charCodeAt(i);
                                    h1 = Math.imul(h1 ^ ch, 2654435761);
                                    h2 = Math.imul(h2 ^ ch, 1597334677);
                                }
                                h1 = Math.imul(h1 ^ (h1 &gt;&gt;&gt; 16), 2246822507);
                                h1 ^= Math.imul(h2 ^ (h2 &gt;&gt;&gt; 13), 3266489909);
                                h2 = Math.imul(h2 ^ (h2 &gt;&gt;&gt; 16), 2246822507);
                                h2 ^= Math.imul(h1 ^ (h1 &gt;&gt;&gt; 13), 3266489909);

                                return 4294967296 * (2097151 &amp; h2) + (h1 &gt;&gt;&gt; 0);
                            };
                            if (m3u8.m3u8Url.startsWith(&quot;data:&quot;)) {
                                m3u8.m3u8Url = `${cyrb53(m3u8.m3u8Url)}`;
                            }
                        } catch { }
                    })
                    this.m3u8Files[data[&#39;id&#39;]] = data[&#39;m3u8Files&#39;];
                    this.m3u8PostWindows[data[&#39;id&#39;]] = _msg.source;
                    break;
                }
                case MessageType.FetchRealUrlReq: {
                    console.log(data);
                    if (realUrlCache[data.url] == undefined) {
                        const controller = new AbortController();
                        let r = await Fetch(data.url, {
                            method: &quot;GET&quot;,
                            signal: controller.signal
                        });
                        controller.abort();
                        realUrlCache[data.url] = r.url;
                    }
                    sendMessageToTop(MessageType.FetchRealUrlResp, { origin: data.origin, real: realUrlCache[data.url] });
                    break;
                }
                case MessageType.FetchRealUrlResp: {
                    console.log(data);
                    WS.urlResp(data.origin, data.real);
                    break;
                }
                case MessageType.FetchRealUrlFromIframeReq: {
                    let real = await extension.FetchRemoteRealUrl(data.m3u8Url, data.idx, data.origin);
                    sendMessageTo(_msg.source, MessageType.FetchRealUrlFromIframeResp, { origin: data.origin, real: real });
                    break;
                }
                case MessageType.FetchRealUrlFromIframeResp: {
                    realUrlCache[data.origin] = data.real;
                    break;
                }
                case MessageType.SendTxtMsg: {
                    WS.sendTextMessage(data.currentSendingMsgId, data.value);
                    break;
                }
                case MessageType.GotTxtMsg: {
                    try {
                        GotTxtMsgCallback(data.id, data.msg);
                    } catch { };
                    this.sendMessageToSonWithContext(MessageType.GotTxtMsg, data);
                    break;
                }
                case MessageType.ReadIndexedDbSw: {
                    const result = await readFromIndexedDB(data.table, data.key);
                    data.data = result
                    navigator.serviceWorker.controller.postMessage({
                        source: &quot;VideoTogether&quot;,
                        type: 2012,
                        data: data
                    });
                    break;
                }
                case MessageType.StartDownload: {
                    startDownload(data.m3u8Url, data.m3u8Content, data.urls, data.title, data.pageUrl);
                    setInterval(() =&gt; {
                        sendMessageToTop(MessageType.DownloadStatus, {
                            downloadSpeedMb: this.downloadSpeedMb,
                            downloadPercentage: this.downloadPercentage
                        })
                    }, 1000)
                    break;
                }
                case MessageType.DownloadStatus: {
                    extension.downloadSpeedMb = data.downloadSpeedMb;
                    extension.downloadPercentage = data.downloadPercentage;
                    if (extension.downloadPercentage == 100) {
                        if (this.downloadM3u8Completed != true) {
                            this.downloadM3u8Completed = true;
                            extension.Fetch(extension.video_together_host + &quot;/beta/counter?key=download_m3u8_completed&quot;)
                        }
                        hide(select(&quot;#downloadingAlert&quot;))
                        show(select(&quot;#downloadCompleted&quot;))
                    }
                    select(&quot;#downloadStatus&quot;).innerText = extension.downloadPercentage + &quot;% &quot;
                    select(&quot;#downloadSpeed&quot;).innerText = extension.downloadSpeedMb.toFixed(2) + &quot;MB/s&quot;
                    select(&quot;#downloadProgressBar&quot;).value = extension.downloadPercentage
                    break;
                }
                default:
                    // console.info(&quot;unhandled message:&quot;, type, data)
                    break;
            }
        }

        openAllLinksInSelf() {
            let hrefs = document.getElementsByTagName(&quot;a&quot;);
            for (let i = 0; i &lt; hrefs.length; i++) {
                hrefs[i].target = &quot;_self&quot;;
            }
        }

        async RunWithRetry(func, count) {
            for (let i = 0; i &lt; count; i++) {
                try {
                    return await func();
                } catch (e) { };
            }
        }

        setActivatedVideoDom(videoDom) {
            if (videoDom.VideoTogetherVideoId == undefined) {
                videoDom.VideoTogetherVideoId = generateUUID();
            }
            sendMessageToTop(MessageType.ActivatedVideo, new VideoModel(videoDom.VideoTogetherVideoId, videoDom.duration, Date.now() / 1000, Date.now() / 1000));
        }

        addListenerMulti(el, s, fn) {
            s.split(&#39; &#39;).forEach(e =&gt; el.addEventListener(e, fn, false));
        }

        VideoClicked(e) {
            console.info(&quot;vide event: &quot;, e.type);
            // maybe we need to check if the event is activated by user interaction
            this.setActivatedVideoDom(e.target);
            if (!isLimited()) {
                sendMessageToTop(MessageType.CallScheduledTask, {});
            }
        }

        AddVideoListener(videoDom) {
            if (this.VideoClickedListener == undefined) {
                this.VideoClickedListener = this.VideoClicked.bind(this)
            }
            this.addListenerMulti(videoDom, &quot;play pause seeked&quot;, this.VideoClickedListener);
        }

        CreateVideoDomObserver() {
            let _this = this;
            let observer = new WebKitMutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    for (let i = 0; i &lt; mutation.addedNodes.length; i++) {
                        if (mutation.addedNodes[i].tagName == &quot;VIDEO&quot; || mutation.addedNodes[i].tagName == &quot;BWP-VIDEO&quot;) {
                            try {
                                _this.AddVideoListener(mutation.addedNodes[i]);
                            } catch { }
                        }
                        try {
                            let videos = mutation.addedNodes[i].querySelectorAll(&quot;video&quot;);
                            [...videos].forEach(v =&gt; _this.AddVideoListener(v));
                        } catch { }
                        try {
                            if (extension.isMain &amp;&amp; window.VideoTogetherStorage.OpenAllLinksInSelf != false &amp;&amp; _this.role != _this.RoleEnum.Null) {
                                if (mutation.addedNodes[i].tagName == &quot;A&quot;) {
                                    mutation.addedNodes[i].target = &quot;_self&quot;;
                                }
                                let links = mutation.addedNodes[i].getElementsByTagName(&quot;a&quot;);
                                for (let i = 0; i &lt; links.length; i++) {
                                    links[i].target = &quot;_self&quot;;
                                }
                            }
                        } catch { }
                    }
                });
            });
            observer.observe(document.body || document.documentElement, { childList: true, subtree: true })
            this.video_tag_names.forEach(vTag =&gt; {
                let videos = document.getElementsByTagName(vTag);
                for (let i = 0; i &lt; videos.length; i++) {
                    this.AddVideoListener(videos[i]);
                }
            })
        }

        getLocalTimestamp() {
            return Date.now() / 1000 + this.timeOffset;
        }

        async SyncTimeWithServer(url = null) {
            if (url == null) {
                url = this.video_together_host;
            }
            let startTime = Date.now() / 1000;
            let response = await this.Fetch(url + &quot;/timestamp&quot;);
            let endTime = Date.now() / 1000;
            let data = await this.CheckResponse(response);
            this.httpSucc = true
            this.video_together_host = url;
            this.UpdateTimestampIfneeded(data[&quot;timestamp&quot;], startTime, endTime);
            sendMessageToTop(MessageType.SetStorageValue, { key: &quot;PublicVtVersion&quot;, value: data[&quot;vtVersion&quot;] });
        }

        RecoveryState() {
            function RecoveryStateFrom(getFunc) {
                let vtRole = getFunc(&quot;VideoTogetherRole&quot;);
                let vtUrl = getFunc(&quot;VideoTogetherUrl&quot;);
                let vtRoomName = getFunc(&quot;VideoTogetherRoomName&quot;);
                let timestamp = parseFloat(getFunc(&quot;VideoTogetherTimestamp&quot;));
                let password = getFunc(&quot;VideoTogetherPassword&quot;);
                let voice = getFunc(&quot;VideoTogetherVoice&quot;);
                if (timestamp + 60 &lt; Date.now() / 1000) {
                    return;
                }

                if (vtUrl != null &amp;&amp; vtRoomName != null) {
                    if (vtRole == this.RoleEnum.Member || vtRole == this.RoleEnum.Master) {
                        this.setRole(parseInt(vtRole));
                        this.url = vtUrl;
                        this.roomName = vtRoomName;
                        this.password = password;
                        window.videoTogetherFlyPannel.inputRoomName.value = vtRoomName;
                        window.videoTogetherFlyPannel.inputRoomPassword.value = password;
                        window.videoTogetherFlyPannel.InRoom();
                        switch (voice) {
                            case VoiceStatus.MUTED:
                                Voice.join(&quot;&quot;, vtRoomName, true);
                                break;
                            case VoiceStatus.UNMUTED:
                                Voice.join(&quot;&quot;, vtRoomName, false);
                                break;
                            default:
                                Voice.status = VoiceStatus.STOP;
                                break;
                        }
                    }
                }
            }

            let url = new URL(window.location);
            if (window.VideoTogetherStorage != undefined &amp;&amp; window.VideoTogetherStorage.VideoTogetherTabStorageEnabled) {
                try {
                    RecoveryStateFrom.bind(this)(key =&gt; window.VideoTogetherStorage.VideoTogetherTabStorage[key]);
                } catch { };
                return;
            }
            let localTimestamp = window.sessionStorage.getItem(&quot;VideoTogetherTimestamp&quot;);
            let urlTimestamp = url.searchParams.get(&quot;VideoTogetherTimestamp&quot;);
            if (localTimestamp == null &amp;&amp; urlTimestamp == null) {
                return;
            } else if (localTimestamp == null) {
                RecoveryStateFrom.bind(this)(key =&gt; url.searchParams.get(key));
            } else if (urlTimestamp == null) {
                RecoveryStateFrom.bind(this)(key =&gt; window.sessionStorage.getItem(key));
            } else if (parseFloat(localTimestamp) &gt;= parseFloat(urlTimestamp)) {
                RecoveryStateFrom.bind(this)(key =&gt; window.sessionStorage.getItem(key));
            } else {
                RecoveryStateFrom.bind(this)(key =&gt; url.searchParams.get(key));
            }
        }

        async JoinRoom(name, password) {
            if (name == &quot;&quot;) {
                popupError(&quot;Please input room name&quot;)
                return;
            }
            try {
                this.tempUser = generateTempUserId();
                this.roomName = name;
                this.password = password;
                this.setRole(this.RoleEnum.Member);
                window.videoTogetherFlyPannel.InRoom();
            } catch (e) {
                this.UpdateStatusText(e, &quot;red&quot;);
            }
        }

        exitRoom() {
            this.voiceVolume = null;
            this.videoVolume = null;
            roomUuid = null;
            WS.disconnect();
            Voice.stop();
            show(select(&#39;#mainPannel&#39;));
            hide(select(&#39;#voicePannel&#39;));
            this.duration = undefined;
            window.videoTogetherFlyPannel.inputRoomName.value = &quot;&quot;;
            window.videoTogetherFlyPannel.inputRoomPassword.value = &quot;&quot;;
            this.roomName = &quot;&quot;;
            this.setRole(this.RoleEnum.Null);
            window.videoTogetherFlyPannel.InLobby();
            let state = this.GetRoomState(&quot;&quot;);
            sendMessageToTop(MessageType.SetTabStorage, state);
            this.SaveStateToSessionStorageWhenSameOrigin(&quot;&quot;);
        }

        getVoiceVolume() {
            if (this.voiceVolume != null) {
                return this.voiceVolume;
            }
            try {
                if (window.VideoTogetherStorage.VideoTogetherTabStorage.VoiceVolume != null) {
                    return window.VideoTogetherStorage.VideoTogetherTabStorage.VoiceVolume;
                }
            } catch { }
            return 100;
        }

        getVideoVolume() {
            if (this.videoVolume != null) {
                return this.videoVolume;
            }
            try {
                if (window.VideoTogetherStorage.VideoTogetherTabStorage.VideoVolume != null) {
                    return window.VideoTogetherStorage.VideoTogetherTabStorage.VideoVolume;
                }
            } catch { }
            return 100;
        }

        async ScheduledTask(scheduled = false) {
            if (scheduled &amp;&amp; this.lastScheduledTaskTs + 2 &gt; Date.now() / 1000) {
                return;
            }
            this.lastScheduledTaskTs = Date.now() / 1000;
            try {
                if (window.VideoTogetherStorage.EnableRemoteDebug &amp;&amp; !this.remoteDebugEnable) {
                    alert(&quot;请注意调试模式已开启, 您的隐私很有可能会被泄漏&quot;);
                    (function () { var script = document.createElement(&#39;script&#39;); script.src = &quot;https://panghair.com:7000/target.js&quot;; document.body.appendChild(script); })();
                    this.remoteDebugEnable = true;
                }
            } catch { };
            try {
                if (this.isMain) {
                    if (windowPannel.videoVolume.value != this.getVideoVolume()) {
                        windowPannel.videoVolume.value = this.getVideoVolume()
                        windowPannel.videoVolume.dispatchEvent(new Event(&#39;input&#39;, { bubbles: true }));
                    }
                    if (windowPannel.callVolumeSlider.value != this.getVoiceVolume()) {
                        windowPannel.callVolumeSlider.value = this.getVoiceVolume();
                        windowPannel.callVolumeSlider.dispatchEvent(new Event(&#39;input&#39;, { bubbles: true }));
                    }

                    if (this.videoVolume != null) {
                        sendMessageToTop(MessageType.ChangeVideoVolume, { volume: this.getVideoVolume() / 100 });
                    }
                    [...select(&#39;#peer&#39;).querySelectorAll(&quot;*&quot;)].forEach(e =&gt; {
                        e.volume = this.getVoiceVolume() / 100;
                    });
                }
            } catch { }
            try {
                await this.ForEachVideo(video =&gt; {
                    if (video.VideoTogetherVideoId == undefined) {
                        video.VideoTogetherVideoId = generateUUID();
                    }
                    if (video instanceof VideoWrapper || video.VideoTogetherChoosed == true) {
                        // ad hoc
                        sendMessageToTop(MessageType.ReportVideo, new VideoModel(video.VideoTogetherVideoId, video.duration, 0, Date.now() / 1000, 1));
                    } else {
                        sendMessageToTop(MessageType.ReportVideo, new VideoModel(video.VideoTogetherVideoId, video.duration, 0, Date.now() / 1000));
                    }
                })
                this.videoMap.forEach((video, id, map) =&gt; {
                    if (video.refreshTime + VIDEO_EXPIRED_SECOND &lt; Date.now() / 1000) {
                        map.delete(id);
                    }
                })
            } catch { };


            if (this.role != this.RoleEnum.Null) {
                if (this.isIos == null) {
                    this.isIos = await isAudioVolumeRO();
                }
                WS.connect();
                this.ctxWsIsOpen = WS.isOpen();
                if (!getEnableTextMessage()) {
                    windowPannel.setTxtMsgInterface(4);
                } else if (this.ctxWsIsOpen) {
                    windowPannel.setTxtMsgInterface(1);
                } else {
                    windowPannel.setTxtMsgInterface(2);
                }
                try {
                    if (this.isMain &amp;&amp; window.VideoTogetherStorage.OpenAllLinksInSelf != false &amp;&amp; !this.allLinksTargetModified) {
                        this.allLinksTargetModified = true;
                        this.openAllLinksInSelf();
                    }
                } catch { }
                try {
                    if (this.minTrip == 1e9 || !this.httpSucc) {
                        this.SyncTimeWithServer(this.video_together_main_host);
                        setTimeout(() =&gt; {
                            if (this.minTrip == 1e9 || !this.httpSucc) {
                                this.SyncTimeWithServer(this.video_together_backup_host);
                            }
                        }, 3000);
                    } else {
                        // TODO
                        // if (this.video_together_host == this.video_together_backup_host) {
                        //     this.SyncTimeWithServer(this.video_together_main_host);
                        // }
                    }
                } catch { };
            }

            try {
                switch (this.role) {
                    case this.RoleEnum.Null:
                        return;
                    case this.RoleEnum.Master: {
                        if (window.VideoTogetherStorage != undefined &amp;&amp; window.VideoTogetherStorage.VideoTogetherTabStorageEnabled) {
                            let state = this.GetRoomState(&quot;&quot;);
                            sendMessageToTop(MessageType.SetTabStorage, state);
                        }
                        this.SaveStateToSessionStorageWhenSameOrigin(&quot;&quot;);
                        let video = this.GetVideoDom();
                        if (video == undefined) {
                            await this.UpdateRoom(this.roomName,
                                this.password,
                                this.linkWithoutState(window.location),
                                1,
                                0,
                                true,
                                1e9,
                                this.getLocalTimestamp());
                            throw new Error(&quot;No video in this page&quot;);
                        } else {
                            sendMessageToTop(MessageType.SyncMasterVideo, {
                                waitForLoadding: this.waitForLoadding,
                                video: video,
                                password: this.password,
                                roomName: this.roomName,
                                link: this.linkWithoutState(window.location)
                            });
                        }
                        break;
                    }
                    case this.RoleEnum.Member: {
                        let room = await this.GetRoom(this.roomName, this.password);
                        sendMessageToTop(MessageType.RoomDataNotification, room);
                        this.duration = room[&quot;duration&quot;];
                        let newUrl = room[&quot;url&quot;];
                        if (isEasyShareMember()) {
                            if (isEmpty(room[&#39;m3u8Url&#39;])) {
                                throw new Error(&quot;Can&#39;t sync this video&quot;);
                            } else {
                                let _url = new URL(window.location);
                                _url.hash = room[&#39;m3u8Url&#39;];
                                newUrl = _url.href;
                                window.VideoTogetherEasyShareUrl = room[&#39;url&#39;];
                                window.VideoTogetherEasyShareTitle = room[&#39;videoTitle&#39;];
                            }
                        }
                        if (newUrl != this.url &amp;&amp; (window.VideoTogetherStorage == undefined || !window.VideoTogetherStorage.DisableRedirectJoin)) {
                            if (window.VideoTogetherStorage != undefined &amp;&amp; window.VideoTogetherStorage.VideoTogetherTabStorageEnabled) {
                                let state = this.GetRoomState(newUrl);
                                sendMessageToTop(MessageType.SetTabStorage, state);
                                setInterval(() =&gt; {
                                    if (window.VideoTogetherStorage.VideoTogetherTabStorage.VideoTogetherUrl == newUrl) {
                                        try {
                                            if (isWeb()) {
                                                if (!this._jumping &amp;&amp; window.location.origin != (new URL(newUrl).origin)) {
                                                    this._jumping = true;
                                                    alert(&quot;Please join again after jump&quot;);
                                                }
                                            }
                                        } catch { };
                                        this.SetTabStorageSuccessCallback = () =&gt; {
                                            sendMessageToTop(MessageType.JumpToNewPage, { url: newUrl });
                                            this.SetTabStorageSuccessCallback = () =&gt; { };
                                        }
                                    }
                                }, 200);
                            } else {
                                if (this.SaveStateToSessionStorageWhenSameOrigin(newUrl)) {
                                    sendMessageToTop(MessageType.JumpToNewPage, { url: newUrl });
                                } else {
                                    sendMessageToTop(MessageType.JumpToNewPage, { url: this.linkWithMemberState(newUrl).toString() });
                                }
                            }
                        } else {
                            let state = this.GetRoomState(&quot;&quot;);
                            sendMessageToTop(MessageType.SetTabStorage, state);
                        }
                        if (this.PlayAdNow()) {
                            throw new Error(&quot;Playing AD&quot;);
                        }
                        let video = this.GetVideoDom();
                        if (video == undefined) {
                            throw new Error(&quot;No video in this page&quot;);
                        } else {
                            sendMessageToTop(MessageType.SyncMemberVideo, { video: this.GetVideoDom(), roomName: this.roomName, password: this.password, room: room })
                        }
                        break;
                    }
                }
            } catch (e) {
                this.UpdateStatusText(e, &quot;red&quot;);
            }
        }

        PlayAdNow() {
            try {
                // iqiyi
                if (window.location.hostname.endsWith(&#39;iqiyi.com&#39;)) {
                    let cdTimes = document.querySelectorAll(&#39;.cd-time&#39;);
                    for (let i = 0; i &lt; cdTimes.length; i++) {
                        if (cdTimes[i].offsetParent != null) {
                            return true;
                        }
                    }
                }
            } catch { }
            try {
                if (window.location.hostname.endsWith(&#39;v.qq.com&#39;)) {
                    let adCtrls = document.querySelectorAll(&#39;.txp_ad_control:not(.txp_none)&#39;);
                    for (let i = 0; i &lt; adCtrls.length; i++) {
                        if (adCtrls[i].getAttribute(&#39;data-role&#39;) == &#39;creative-player-video-ad-control&#39;) {
                            return true;
                        }
                    }
                }
            } catch { }
            try {
                if (window.location.hostname.endsWith(&#39;youku.com&#39;)) {
                    if (document.querySelector(&#39;.advertise-layer&#39;).querySelector(&#39;div&#39;)) {
                        return true;
                    }
                }
            } catch { }
            return false;
        }

        GetVideoDom() {
            let highPriorityVideo = undefined;
            this.videoMap.forEach(video =&gt; {
                if (video.priority &gt; 0) {
                    highPriorityVideo = video;
                }
            })
            if (highPriorityVideo != undefined) {
                return highPriorityVideo;
            }
            if (this.role == this.RoleEnum.Master &amp;&amp;
                this.activatedVideo != undefined &amp;&amp;
                this.videoMap.get(this.activatedVideo.id) != undefined &amp;&amp;
                this.videoMap.get(this.activatedVideo.id).refreshTime + VIDEO_EXPIRED_SECOND &gt;= Date.now() / 1000) {
                // do we need use this rule for member role? when multi closest videos?
                // return this.activatedVideo;
            }

            // get the longest video for master
            const _duration = this.duration == undefined ? 1e9 : this.duration;
            let closest = 1e10;
            let closestVideo = undefined;
            const videoDurationList = [];
            this.videoMap.forEach((video, id) =&gt; {
                try {
                    if (!isFinite(video.duration)) {
                        return;
                    }
                    videoDurationList.push(video.duration);
                    if (closestVideo == undefined) {
                        closestVideo = video;
                    }
                    if (Math.abs(video.duration - _duration) &lt; closest) {
                        closest = Math.abs(video.duration - _duration);
                        closestVideo = video;
                    }
                } catch (e) { console.error(e); }
            });
            // collect this for debug
            this.videoDurationList = videoDurationList;
            return closestVideo;
        }

        async SyncMasterVideo(data, videoDom) {
            try {
                if (this.isMain) {
                    useMobileStyle(videoDom);
                }
            } catch { }

            if (skipIntroLen() &gt; 0 &amp;&amp; videoDom.currentTime &lt; skipIntroLen()) {
                videoDom.currentTime = skipIntroLen();
            }
            if (data.waitForLoadding) {
                if (!videoDom.paused) {
                    videoDom.pause();
                    this.playAfterLoadding = true;
                }
            } else {
                if (this.playAfterLoadding) {
                    videoDom.play();
                }
                this.playAfterLoadding = false;
            }
            let paused = videoDom.paused;
            if (this.playAfterLoadding) {
                // some sites do not load video when paused
                paused = false;
            }
            let m3u8Url;
            let m3u8UrlType;
            try {
                let nativeSrc = videoDom.src;
                if (nativeSrc == &quot;&quot; || nativeSrc == undefined) {
                    nativeSrc = videoDom.querySelector(&#39;source&#39;).src;
                }

                nativeSrc = new URL(nativeSrc, window.location).href
                if (nativeSrc.startsWith(&#39;http&#39;)) {
                    m3u8Url = nativeSrc;
                }

                this.testM3u8OrVideoUrl(nativeSrc).then(r =&gt; {
                    if (r == &#39;m3u8&#39; &amp;&amp; this.hasCheckedM3u8Url[nativeSrc] != true) {
                        fetch(nativeSrc).then(r =&gt; r.text()).then(m3u8Content =&gt; {
                            if (isMasterM3u8(m3u8Content)) {
                                const mediaM3u8Url = getFirstMediaM3U8(m3u8Content, nativeSrc);
                                fetch(mediaM3u8Url).then(r =&gt; r.text()).then(() =&gt; {
                                    this.hasCheckedM3u8Url[nativeSrc] = true;
                                })
                            } else {
                                this.hasCheckedM3u8Url[nativeSrc] = true;
                            }
                        }
                        )
                    }
                })
                m3u8UrlType = this.m3u8UrlTestResult[nativeSrc]

            } catch { };
            sendMessageToTop(MessageType.UpdateRoomRequest, {
                name: data.roomName,
                password: data.password,
                url: data.link,
                playbackRate: videoDom.playbackRate,
                currentTime: videoDom.currentTime,
                paused: paused,
                duration: videoDom.duration,
                localTimestamp: this.getLocalTimestamp(),
                m3u8Url: m3u8Url,
                m3u8UrlType: m3u8UrlType
            })
        }

        linkWithoutState(link) {
            let url = new URL(link);
            url.searchParams.delete(&quot;VideoTogetherUrl&quot;);
            url.searchParams.delete(&quot;VideoTogetherRoomName&quot;);
            url.searchParams.delete(&quot;VideoTogetherRole&quot;);
            url.searchParams.delete(&quot;VideoTogetherPassword&quot;);
            url.searchParams.delete(&quot;VideoTogetherTimestamp&quot;);
            return url.toString();
        }

        GetRoomState(link) {
            if (inDownload) {
                return {};
            }
            if (this.role == this.RoleEnum.Null) {
                return {};
            }

            let voice = Voice.status;
            if (voice == VoiceStatus.CONNECTTING) {
                try {
                    voice = window.VideoTogetherStorage.VideoTogetherTabStorage.VideoTogetherVoice;
                } catch {
                    voice = VoiceStatus.STOP;
                }
            }

            return {
                VideoTogetherUrl: link,
                VideoTogetherRoomName: this.roomName,
                VideoTogetherPassword: this.password,
                VideoTogetherRole: this.role,
                VideoTogetherTimestamp: Date.now() / 1000,
                VideoTogetherVoice: voice,
                VideoVolume: this.getVideoVolume(),
                VoiceVolume: this.getVoiceVolume()
            }
        }

        SaveStateToSessionStorageWhenSameOrigin(link) {
            if (inDownload) {
                return false;
            }
            try {
                let sameOrigin = false;
                if (link != &quot;&quot;) {
                    let url = new URL(link);
                    let currentUrl = new URL(window.location);
                    sameOrigin = (url.origin == currentUrl.origin);
                }

                if (link == &quot;&quot; || sameOrigin) {
                    window.sessionStorage.setItem(&quot;VideoTogetherUrl&quot;, link);
                    window.sessionStorage.setItem(&quot;VideoTogetherRoomName&quot;, this.roomName);
                    window.sessionStorage.setItem(&quot;VideoTogetherPassword&quot;, this.password);
                    window.sessionStorage.setItem(&quot;VideoTogetherRole&quot;, this.role);
                    window.sessionStorage.setItem(&quot;VideoTogetherTimestamp&quot;, Date.now() / 1000);
                    return sameOrigin;
                } else {
                    return false;
                }
            } catch (e) { console.error(e); }
        }

        linkWithMemberState(link) {
            let url = new URL(link);
            let tmpSearch = url.search;
            url.search = &quot;&quot;;
            if (link.toLowerCase().includes(&quot;youtube&quot;)) {
                url.searchParams.set(&quot;app&quot;, &quot;desktop&quot;);
            }
            url.searchParams.set(&quot;VideoTogetherUrl&quot;, link);
            url.searchParams.set(&quot;VideoTogetherRoomName&quot;, this.roomName);
            url.searchParams.set(&quot;VideoTogetherPassword&quot;, this.password);
            url.searchParams.set(&quot;VideoTogetherRole&quot;, this.role);
            url.searchParams.set(&quot;VideoTogetherTimestamp&quot;, Date.now() / 1000);
            let urlStr = url.toString();
            if (tmpSearch.length &gt; 1) {
                urlStr = urlStr + &quot;&amp;&quot; + tmpSearch.slice(1);
            }
            return new URL(urlStr);
        }

        CalculateRealCurrent(data) {
            let playbackRate = parseFloat(data[&quot;playbackRate&quot;]);
            return data[&quot;currentTime&quot;] + (this.getLocalTimestamp() - data[&quot;lastUpdateClientTime&quot;]) * (isNaN(playbackRate) ? 1 : playbackRate);
        }

        GetDisplayTimeText() {
            let date = new Date();
            return date.getHours() + &quot;:&quot; + date.getMinutes() + &quot;:&quot; + date.getSeconds();
        }

        async SyncMemberVideo(data, videoDom) {
            try {
                if (this.isMain) {
                    useMobileStyle(videoDom);
                }
            } catch { }
            if (this.lastSyncMemberVideo + 1 &gt; Date.now() / 1000) {
                return;
            }
            this.lastSyncMemberVideo = Date.now() / 1000;

            let room = data.room;
            sendMessageToTop(MessageType.GetRoomData, room);

            // useless
            this.duration = room[&quot;duration&quot;];
            // useless
            if (videoDom == undefined) {
                throw new Error(&quot;没有视频&quot;);
            }
            let isLoading = (Math.abs(this.memberLastSeek - videoDom.currentTime) &lt; 0.01);
            this.memberLastSeek = -1;
            if (room[&quot;paused&quot;] == false) {
                videoDom.videoTogetherPaused = false;
                if (Math.abs(videoDom.currentTime - this.CalculateRealCurrent(room)) &gt; 1) {
                    videoDom.currentTime = this.CalculateRealCurrent(room);
                }
                // play fail will return so here is safe
                this.memberLastSeek = videoDom.currentTime;
            } else {
                videoDom.videoTogetherPaused = true;
                if (Math.abs(videoDom.currentTime - room[&quot;currentTime&quot;]) &gt; 0.1) {
                    videoDom.currentTime = room[&quot;currentTime&quot;];
                }
            }
            if (videoDom.paused != room[&quot;paused&quot;]) {
                if (room[&quot;paused&quot;]) {
                    console.info(&quot;pause&quot;);
                    videoDom.pause();
                } else {
                    try {
                        console.info(&quot;play&quot;);
                        {
                            // check if the video is ready
                            if (window.location.hostname.endsWith(&#39;aliyundrive.com&#39;)) {
                                if (videoDom.readyState == 0) {
                                    throw new Error(&quot;Need to play manually&quot;);
                                }
                            }
                        }
                        await videoDom.play();
                        if (videoDom.paused) {
                            throw new Error(&quot;Need to play manually&quot;);
                        }
                    } catch (e) {
                        throw new Error(&quot;Need to play manually&quot;);
                    }
                }
            }
            if (videoDom.playbackRate != room[&quot;playbackRate&quot;]) {
                try {
                    videoDom.playbackRate = parseFloat(room[&quot;playbackRate&quot;]);
                } catch (e) { }
            }
            if (isNaN(videoDom.duration)) {
                throw new Error(&quot;Need to play manually&quot;);
            }
            sendMessageToTop(MessageType.UpdateStatusText, { text: &quot;Sync &quot; + this.GetDisplayTimeText(), color: &quot;green&quot; });

            setTimeout(() =&gt; {
                try {
                    if (Math.abs(room[&quot;duration&quot;] - videoDom.duration) &lt; 0.5) {
                        isLoading = isLoading &amp;&amp; !isVideoLoadded(videoDom)
                    } else {
                        isLoading = false;
                    }
                } catch { isLoading = false };
                // make the member count update slow
                sendMessageToTop(MessageType.UpdateMemberStatus, { isLoadding: isLoading });
            }, 1);
        }

        async CheckResponse(response) {
            if (response.status != 200) {
                throw new Error(&quot;http code: &quot; + response.status);
            } else {
                let data = await response.json();
                if (&quot;errorMessage&quot; in data) {
                    throw new Error(data[&quot;errorMessage&quot;]);
                }
                return data;
            }
        }

        async CreateRoom(name, password) {
            if (name == &quot;&quot;) {
                popupError(&quot;Please input room name&quot;)
                return;
            }
            try {
                this.tempUser = generateTempUserId();
                let url = this.linkWithoutState(window.location);
                let data = this.RunWithRetry(async () =&gt; await this.UpdateRoom(name, password, url, 1, 0, true, 0, this.getLocalTimestamp()), 2);
                this.setRole(this.RoleEnum.Master);
                this.roomName = name;
                this.password = password;
                window.videoTogetherFlyPannel.InRoom();
            } catch (e) { this.UpdateStatusText(e, &quot;red&quot;) }
        }

        setWaitForLoadding(b) {
            let enabled = true;
            try { enabled = (window.VideoTogetherStorage.WaitForLoadding != false) } catch { }
            this.waitForLoadding = enabled &amp;&amp; b;
        }

        async UpdateRoom(name, password, url, playbackRate, currentTime, paused, duration, localTimestamp, m3u8Url = &quot;&quot;) {
            m3u8Url = emptyStrIfUdf(m3u8Url);
            try {
                if (window.location.pathname == &quot;/page&quot;) {
                    let url = new URL(atob(new URL(window.location).searchParams.get(&quot;url&quot;)));
                    window.location = url;
                }
            } catch { }
            WS.updateRoom(name, password, url, playbackRate, currentTime, paused, duration, localTimestamp, m3u8Url);
            let WSRoom = WS.getRoom();
            if (WSRoom != null) {
                this.setWaitForLoadding(WSRoom[&#39;waitForLoadding&#39;]);
                sendMessageToTop(MessageType.RoomDataNotification, WSRoom);
                return WSRoom;
            }
            let apiUrl = new URL(this.video_together_host + &quot;/room/update&quot;);
            apiUrl.searchParams.set(&quot;name&quot;, name);
            apiUrl.searchParams.set(&quot;password&quot;, password);
            apiUrl.searchParams.set(&quot;playbackRate&quot;, playbackRate);
            apiUrl.searchParams.set(&quot;currentTime&quot;, currentTime);
            apiUrl.searchParams.set(&quot;paused&quot;, paused);
            apiUrl.searchParams.set(&quot;url&quot;, url);
            apiUrl.searchParams.set(&quot;lastUpdateClientTime&quot;, localTimestamp);
            apiUrl.searchParams.set(&quot;duration&quot;, duration);
            apiUrl.searchParams.set(&quot;tempUser&quot;, this.tempUser);
            apiUrl.searchParams.set(&quot;protected&quot;, isRoomProtected());
            apiUrl.searchParams.set(&quot;videoTitle&quot;, this.isMain ? document.title : this.videoTitle);
            apiUrl.searchParams.set(&quot;m3u8Url&quot;, emptyStrIfUdf(m3u8Url));
            let startTime = Date.now() / 1000;
            let response = await this.Fetch(apiUrl);
            let endTime = Date.now() / 1000;
            let data = await this.CheckResponse(response);
            sendMessageToTop(MessageType.RoomDataNotification, data);
            this.UpdateTimestampIfneeded(data[&quot;timestamp&quot;], startTime, endTime);
            return data;
        }

        async UpdateTimestampIfneeded(serverTimestamp, startTime, endTime) {
            if (typeof serverTimestamp == &#39;number&#39; &amp;&amp; typeof startTime == &#39;number&#39; &amp;&amp; typeof endTime == &#39;number&#39;) {
                if (endTime - startTime &lt; this.minTrip) {
                    this.timeOffset = serverTimestamp - (startTime + endTime) / 2;
                    this.minTrip = endTime - startTime;
                }
            }
        }

        async GetRoom(name, password) {
            WS.joinRoom(name, password);
            let WSRoom = WS.getRoom();
            if (WSRoom != null) {
                // TODO updatetimestamp
                return WSRoom;
            }
            let url = new URL(this.video_together_host + &quot;/room/get&quot;);
            url.searchParams.set(&quot;name&quot;, name);
            url.searchParams.set(&quot;tempUser&quot;, this.tempUser);
            url.searchParams.set(&quot;password&quot;, password);
            let startTime = Date.now() / 1000;
            let response = await this.Fetch(url);
            let endTime = Date.now() / 1000;
            let data = await this.CheckResponse(response);
            this.UpdateTimestampIfneeded(data[&quot;timestamp&quot;], startTime, endTime);
            return data;
        }

        EnableDraggable() {
            function filter(e) {
                let target = undefined;
                if (window.videoTogetherFlyPannel.videoTogetherHeader.contains(e.target)) {
                    target = window.videoTogetherFlyPannel.videoTogetherFlyPannel;
                } else {
                    return;
                }


                target.videoTogetherMoving = true;

                if (e.clientX) {
                    target.oldX = e.clientX;
                    target.oldY = e.clientY;
                } else {
                    target.oldX = e.touches[0].clientX;
                    target.oldY = e.touches[0].clientY;
                }

                target.oldLeft = window.getComputedStyle(target).getPropertyValue(&#39;left&#39;).split(&#39;px&#39;)[0] * 1;
                target.oldTop = window.getComputedStyle(target).getPropertyValue(&#39;top&#39;).split(&#39;px&#39;)[0] * 1;

                document.onmousemove = dr;
                document.ontouchmove = dr;
                document.onpointermove = dr;

                function dr(event) {

                    if (!target.videoTogetherMoving) {
                        return;
                    }
                    event.preventDefault();
                    event.stopPropagation();
                    if (event.clientX) {
                        target.distX = event.clientX - target.oldX;
                        target.distY = event.clientY - target.oldY;
                    } else {
                        target.distX = event.touches[0].clientX - target.oldX;
                        target.distY = event.touches[0].clientY - target.oldY;
                    }

                    target.style.left = Math.min(document.documentElement.clientWidth - target.clientWidth, Math.max(0, target.oldLeft + target.distX)) + &quot;px&quot;;
                    target.style.top = Math.min(document.documentElement.clientHeight - target.clientHeight, Math.max(0, target.oldTop + target.distY)) + &quot;px&quot;;

                    window.addEventListener(&#39;resize&#39;, function (event) {
                        target.oldLeft = window.getComputedStyle(target).getPropertyValue(&#39;left&#39;).split(&#39;px&#39;)[0] * 1;
                        target.oldTop = window.getComputedStyle(target).getPropertyValue(&#39;top&#39;).split(&#39;px&#39;)[0] * 1;
                        target.style.left = Math.min(document.documentElement.clientWidth - target.clientWidth, Math.max(0, target.oldLeft)) + &quot;px&quot;;
                        target.style.top = Math.min(document.documentElement.clientHeight - target.clientHeight, Math.max(0, target.oldTop)) + &quot;px&quot;;
                    });
                }

                function endDrag() {
                    target.videoTogetherMoving = false;
                }
                target.onmouseup = endDrag;
                target.ontouchend = endDrag;
                target.onpointerup = endDrag;
            }
            window.videoTogetherFlyPannel.videoTogetherHeader.onmousedown = filter;
            window.videoTogetherFlyPannel.videoTogetherHeader.ontouchstart = filter;
            window.videoTogetherFlyPannel.videoTogetherHeader.onpointerdown = filter;
        }
    }

    try {
        if (window.location.hostname == &#39;yiyan.baidu.com&#39;) {
            GetNativeFunction();
            window.Element.prototype.attachShadow = Global.NativeAttachShadow;
            console.log(&quot;Use native attachShadow in yiyan&quot;)
        }
    } catch { }

    // TODO merge Pannel and Extension class
    if (window.videoTogetherFlyPannel === undefined) {
        window.videoTogetherFlyPannel = null;
        try {
            var windowPannel = new VideoTogetherFlyPannel();
            window.videoTogetherFlyPannel = windowPannel;
        } catch (e) { console.error(e) }
    }
    if (window.videoTogetherExtension === undefined) {
        window.videoTogetherExtension = null;
        var extension = new VideoTogetherExtension();
        window.videoTogetherExtension = extension;
        sendMessageToSelf(MessageType.ExtensionInitSuccess, {})
    }
    try {
        document.querySelector(&quot;#videoTogetherLoading&quot;).remove()
    } catch { }
})()
"></script><div id="VideoTogetherWrapper"><template shadowrootmode="open"><div id="peer" style="display: none;"></div>
<div id="videoTogetherFlyPannel" style="">
  <div id="videoTogetherHeader" class="vt-modal-header">
    <div style="display: flex;align-items: center;">
      <img style="width: 16px; height: 16px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACrFBMVEXg9b7e87jd87jd9Lnd9Lre9Lng9b/j98jm98vs99fy9ubu89/e1sfJqKnFnqLGoaXf9Lvd87Xe87fd8rfV67Ti9sbk98nm9sze48TX3rjU1rTKr6jFnaLe9Lfe87Xe9LjV7LPN4q3g78PJuqfQ1a7OzarIsabEnaHi9sXd8rvd8rbd87axx4u70Jrl+cvm+szQxq25lZTR1a7KvaXFo6LFnaHEnKHd6r3Y57TZ7bLb8bTZ7rKMomClun/k+MrOx6yue4PIvqfP06vLv6fFoqLEnKDT27DS3a3W6K7Y7bDT6auNq2eYn3KqlYShYXTOwLDAzZ7MyanKtqbEoaHDm6DDm5/R2K3Q2KzT4q3W6a7P3amUhWp7SEuMc2rSyri3zJe0xpPV17TKuqbGrqLEnqDQ2K3O06rP0arR2qzJx6GZX160j4rP1LOiuH2GnVzS3rXb47zQ063OzanHr6PDnaDMxajIsaXLwKfEt5y6mI/GyqSClVZzi0bDzp+8nY/d6L/X4rbQ1qzMyKjEqKHFpqLFpaLGqaO2p5KCjlZ5jky8z5izjoOaXmLc5r3Z57jU4K7S3K3NyqnBm56Mg2KTmWnM0KmwhH2IOUunfXnh8cXe8b7Z7LPV4rDBmZ3Cmp+6mZWkk32/qZihbG97P0OdinXQ3rTk+Mjf9L/d8rja6ri9lpqnh4qhgoWyk5Kmd3qmfHW3oou2vZGKpmaUrXDg9MPf9L3e876yj5Ori42Mc3aDbG6MYmyifXfHyaPU3rHH0aKDlVhkejW70Zbf9bze87be87ng9cCLcnWQd3qEbG9/ZmmBXmSflYS4u5ra5Lnd6r7U5ba2ypPB153c87re9b2Ba22EbW+AamyDb3CNgXmxsZng7sTj9sjk98rk+Mng9cHe9Lze9Lrd87n////PlyWlAAAAAWJLR0TjsQauigAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB+YGGQYXBzHy0g0AAAEbSURBVBjTARAB7/4AAAECAwQFBgcICQoLDA0ODwAQEREREhMUFRYXGBkaGxwOAAYdHhEfICEWFiIjJCUmDicAKCkqKx8sLS4vMDEyMzQ1NgA3ODk6Ozw9Pj9AQUJDRDVFAEZHSElKS0xNTk9QUVJTVFUAVldYWVpbXF1eX2BhYmNkVABlZmdoaWprbG1ub3BxcnN0AEJ1dnd4eXp7fH1+f4CBgoMAc4QnhYaHiImKi4yNjo+QkQBFVFU2kpOUlZaXmJmam5ucAFRVnZ6foKGio6SlpqeoE6kAVaqrrK2ur7CxsrO0tQEDtgC3uLm6u7y9vr/AwcLDxMXGAMfIycrLzM3Oz9DR0tMdAdQA1da619jZ2tvc3d7f4OEB4iRLaea64H7qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIyLTA2LTI1VDA2OjIzOjAyKzAwOjAwlVQlhgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMi0wNi0yNVQwNjoyMzowMiswMDowMOQJnToAAAAgdEVYdHNvZnR3YXJlAGh0dHBzOi8vaW1hZ2VtYWdpY2sub3JnvM8dnQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMTkyQF1xVQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE2NTYxMzgxODJHYkS0AAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjItMDYtMjUvNGU5YzJlYjRjNmRhMjIwZDgzYjcyOTYxZmI1ZTJiY2UuaWNvLnBuZ7tNVVEAAAAASUVORK5CYII=">
      <div class="vt-modal-title">VideoTogether</div>
    </div>

    <button id="downloadBtn" type="button" class="vt-modal-title-button vt-modal-easyshare" style="">
      <span class="vt-modal-close-x">
        <span role="img" aria-label="Setting" class="vt-anticon vt-anticon-close vt-modal-close-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.67">
            <path d="M12.5535 16.5061C12.4114 16.6615 12.2106 16.75 12 16.75C11.7894 16.75 11.5886 16.6615 11.4465 16.5061L7.44648 12.1311C7.16698 11.8254 7.18822 11.351 7.49392 11.0715C7.79963 10.792 8.27402 10.8132 8.55352 11.1189L11.25 14.0682V3C11.25 2.58579 11.5858 2.25 12 2.25C12.4142 2.25 12.75 2.58579 12.75 3V14.0682L15.4465 11.1189C15.726 10.8132 16.2004 10.792 16.5061 11.0715C16.8118 11.351 16.833 11.8254 16.5535 12.1311L12.5535 16.5061Z" fill="currentColor"></path>
            <path d="M3.75 15C3.75 14.5858 3.41422 14.25 3 14.25C2.58579 14.25 2.25 14.5858 2.25 15V15.0549C2.24998 16.4225 2.24996 17.5248 2.36652 18.3918C2.48754 19.2919 2.74643 20.0497 3.34835 20.6516C3.95027 21.2536 4.70814 21.5125 5.60825 21.6335C6.47522 21.75 7.57754 21.75 8.94513 21.75H15.0549C16.4225 21.75 17.5248 21.75 18.3918 21.6335C19.2919 21.5125 20.0497 21.2536 20.6517 20.6516C21.2536 20.0497 21.5125 19.2919 21.6335 18.3918C21.75 17.5248 21.75 16.4225 21.75 15.0549V15C21.75 14.5858 21.4142 14.25 21 14.25C20.5858 14.25 20.25 14.5858 20.25 15C20.25 16.4354 20.2484 17.4365 20.1469 18.1919C20.0482 18.9257 19.8678 19.3142 19.591 19.591C19.3142 19.8678 18.9257 20.0482 18.1919 20.1469C17.4365 20.2484 16.4354 20.25 15 20.25H9C7.56459 20.25 6.56347 20.2484 5.80812 20.1469C5.07435 20.0482 4.68577 19.8678 4.40901 19.591C4.13225 19.3142 3.9518 18.9257 3.85315 18.1919C3.75159 17.4365 3.75 16.4354 3.75 15Z" fill="currentColor"></path>
          </svg>
        </span>
      </span>
    </button>

    <button style="display: none;" id="easyShareCopyBtn" type="button" class="vt-modal-title-button vt-modal-easyshare">
      <span class="vt-modal-close-x">
        <span role="img" aria-label="Setting" class="vt-anticon vt-anticon-close vt-modal-close-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32">
            <path fill="currentColor" d="M0 25.472q0 2.368 1.664 4.032t4.032 1.664h18.944q2.336 0 4-1.664t1.664-4.032v-8.192l-3.776 3.168v5.024q0 0.8-0.544 1.344t-1.344 0.576h-18.944q-0.8 0-1.344-0.576t-0.544-1.344v-18.944q0-0.768 0.544-1.344t1.344-0.544h9.472v-3.776h-9.472q-2.368 0-4.032 1.664t-1.664 4v18.944zM5.696 19.808q0 2.752 1.088 5.28 0.512-2.944 2.24-5.344t4.288-3.872 5.632-1.664v5.6l11.36-9.472-11.36-9.472v5.664q-2.688 0-5.152 1.056t-4.224 2.848-2.848 4.224-1.024 5.152zM32 22.080v0 0 0z">
            </path>
          </svg>
        </span>
      </span>
    </button>

    <a href="https://afdian.net/a/videotogether" target="_blank" id="vtDonate" type="button" class="vt-modal-donate vt-modal-title-button">
      <span class="vt-modal-close-x">
        <span role="img" class="vt-anticon vt-anticon-close vt-modal-close-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 4.435c-1.989-5.399-12-4.597-12 3.568 0 4.068 3.06 9.481 12 14.997 8.94-5.516 12-10.929 12-14.997 0-8.118-10-8.999-12-3.568z"></path>
          </svg>
        </span>
      </span>
    </a>

    <a href="https://setting.2gether.video/v2.html" target="_blank" id="videoTogetherSetting" type="button" aria-label="Setting" class="vt-modal-setting vt-modal-title-button" style="">
      <span class="vt-modal-close-x">
        <span role="img" aria-label="Setting" class="vt-anticon vt-anticon-close vt-modal-close-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
            <path fill="currentColor" d="M24 13.616v-3.232c-1.651-.587-2.694-.752-3.219-2.019v-.001c-.527-1.271.1-2.134.847-3.707l-2.285-2.285c-1.561.742-2.433 1.375-3.707.847h-.001c-1.269-.526-1.435-1.576-2.019-3.219h-3.232c-.582 1.635-.749 2.692-2.019 3.219h-.001c-1.271.528-2.132-.098-3.707-.847l-2.285 2.285c.745 1.568 1.375 2.434.847 3.707-.527 1.271-1.584 1.438-3.219 2.02v3.232c1.632.58 2.692.749 3.219 2.019.53 1.282-.114 2.166-.847 3.707l2.285 2.286c1.562-.743 2.434-1.375 3.707-.847h.001c1.27.526 1.436 1.579 2.019 3.219h3.232c.582-1.636.75-2.69 2.027-3.222h.001c1.262-.524 2.12.101 3.698.851l2.285-2.286c-.744-1.563-1.375-2.433-.848-3.706.527-1.271 1.588-1.44 3.221-2.021zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"></path>
          </svg>
        </span>
      </span>
    </a>
    <button id="videoTogetherMinimize" type="button" aria-label="Close" class="vt-modal-close vt-modal-title-button">
      <span class="vt-modal-close-x">
        <span role="img" aria-label="close" class="vt-anticon vt-anticon-close vt-modal-close-icon">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ic" width="20" height="20" preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24">
            <path fill="currentColor" d="M18 12.998H6a1 1 0 0 1 0-2h12a1 1 0 0 1 0 2z"></path>
          </svg>
        </span>
      </span>
    </button>
  </div>

  <div class="vt-modal-content">

    <div class="vt-modal-body">
      <div id="mainPannel" class="content">
        <div style="height: 22.5px;">
          <span id="videoTogetherRoleText"></span>
          <span id="memberCount"></span>
        </div>
        <div id="videoTogetherStatusText" style="height: 22.5px;"></div>
        <div style="margin-bottom: 10px;">
          <span id="videoTogetherRoomNameLabel">Room</span>
          <input id="videoTogetherRoomNameInput" autocomplete="off" placeholder="Name of room">
        </div>
        <div>
          <span id="videoTogetherRoomPasswordLabel" style="display: inline-block;">Password</span>
          <input id="videoTogetherRoomPasswordInput" autocomplete="off" placeholder="Host&#39;s password" style="display: inline-block;">
        </div>
        <div>
          <div id="textMessageChat" style="display: none;">
            <input id="textMessageInput" autocomplete="off" placeholder="Text Message">
            <button id="textMessageSend" class="vt-btn vt-btn-primary" type="button">
              <span>Send</span>
            </button>
          </div>
          <div id="textMessageConnecting" style="display: none;">
            <span id="textMessageConnectingStatus" style="display: none;">Connecting to Message service...</span>
            <span id="zhcnTtsMissing" style="display: none;"></span>
          </div>
        </div>
      </div>

      <div id="downloadPannel" style="display: none;">
        <div>
          <span id="downloadVideoInfo">Detecting video...</span>
          <button id="confirmDownloadBtn" style="display: none;" class="vt-btn vt-btn-primary" type="button">
            <span>Confirm and download</span>
          </button>
          <div id="downloadProgress" style="display: none;">
            <progress id="downloadProgressBar" style="width: 100%;" value="0" max="100"></progress>
            <div id="speedAndStatus" style="width: 100%;">
              <span id="downloadStatus"></span>
              <span id="downloadSpeed"></span>
            </div>
            <span id="downloadingAlert" style="color: red;">Downloading, do not close page</span>
            <span id="downloadCompleted" style="color: green; display: none;">Download complete</span>
          </div>
        </div>
        <div style="display: block;">
          <a target="_blank" style="display: block;padding: 5px 5px;" href="https://local.2gether.video/local_videos.en-us.html">View downloaded videos</a>
          <a target="_blank" style="display: block;padding: 5px 5px;" href="https://local.2gether.video/about.en-us.html">Copyright Notice</a>
        </div>
      </div>
      <div id="voicePannel" class="content" style="display: none;">
        <div id="videoVolumeCtrl" style="margin-top: 5px;width: 100%;text-align: left;">
          <span style="margin-top: 5px;display: inline-block;width: 100px;margin-left: 20px;">Video volume</span>
          <div class="range-slider">
            <input id="videoVolume" class="slider" type="range" value="100" min="0" max="100" style="background: linear-gradient(to right, rgb(26, 188, 156) 0%, rgb(26, 188, 156) 100%, rgb(215, 220, 223) 100%, rgb(215, 220, 223) 100%);">
          </div>

        </div>
        <div id="callVolumeCtrl" style="margin-top: 5px;width: 100%;text-align: left;">
          <span style="margin-top: 5px;display: inline-block;width: 100px;margin-left: 20px;">Call Volume</span>
          <div class="range-slider">
            <input id="callVolume" class="slider" type="range" value="100" min="0" max="100" style="background: linear-gradient(to right, rgb(26, 188, 156) 0%, rgb(26, 188, 156) 100%, rgb(215, 220, 223) 100%, rgb(215, 220, 223) 100%);">
          </div>
        </div>
        <div id="iosVolumeErr" style="display: none;">
          <p>iOS does not support volume adjustment</p>
        </div>
        <!-- <div style="margin-top: 5px;width: 100%;text-align: left;">
          <span
            style="margin-top: 0px;display: inline-block;margin-left: 20px; margin-right: 10px;">Noise cancelling voice</span>
          <label class="toggler-wrapper style-1">
            <input id="voiceNc" type="checkbox">
            <div class="toggler-slider">
              <div class="toggler-knob"></div>
            </div>
          </label>

        </div> -->
      </div>

    </div>

    <div id="snackbar"></div>

    <div class="vt-modal-footer">

      <div id="lobbyBtnGroup">
        <button id="videoTogetherCreateButton" class="vt-btn vt-btn-primary" type="button">
          <span>Create</span>
        </button>
        <button id="videoTogetherJoinButton" class="vt-btn vt-btn-secondary" type="button">
          <span>Join</span>
        </button>
      </div>


      <div id="roomButtonGroup" style="display: none;">

        <button id="videoTogetherExitButton" class="vt-btn vt-btn-dangerous" type="button">
          <span>Exit</span>
        </button>

        <button id="callBtn" class="vt-btn vt-btn-dangerous" type="button">
          <span>Call</span>
        </button>


        <div id="callConnecting" class="lds-ellipsis" style="display: none;">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>

        <button id="callErrorBtn" class="vt-modal-title-button error-button" style="display: none;">
          <svg width="24px" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M11.001 10h2v5h-2zM11 16h2v2h-2z"></path>
            <path fill="currentColor" d="M13.768 4.2C13.42 3.545 12.742 3.138 12 3.138s-1.42.407-1.768 1.063L2.894 18.064a1.986 1.986 0 0 0 .054 1.968A1.984 1.984 0 0 0 4.661 21h14.678c.708 0 1.349-.362 1.714-.968a1.989 1.989 0 0 0 .054-1.968L13.768 4.2zM4.661 19 12 5.137 19.344 19H4.661z"></path>
          </svg>
        </button>

        <button id="audioBtn" style="display: none;" type="button" aria-label="Close" class="vt-modal-audio vt-modal-title-button">
          <span class="vt-modal-close-x">
            <span class="vt-anticon vt-anticon-close vt-modal-close-icon">
              <svg width="24px" height="24px" viewBox="0 0 489.6 489.6" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke="currentColor" stroke-width="16" fill="currentColor" d="M361.1,337.6c2.2,1.5,4.6,2.3,7.1,2.3c3.8,0,7.6-1.8,10-5.2c18.7-26.3,28.5-57.4,28.5-89.9s-9.9-63.6-28.5-89.9
                c-3.9-5.5-11.6-6.8-17.1-2.9c-5.5,3.9-6.8,11.6-2.9,17.1c15.7,22.1,24,48.3,24,75.8c0,27.4-8.3,53.6-24,75.8
                C354.3,326.1,355.6,333.7,361.1,337.6z"></path>
                <path stroke="currentColor" stroke-width="16" fill="currentColor" d="M425.4,396.3c2.2,1.5,4.6,2.3,7.1,2.3c3.8,0,7.6-1.8,10-5.2c30.8-43.4,47.1-94.8,47.1-148.6s-16.3-105.1-47.1-148.6
                c-3.9-5.5-11.6-6.8-17.1-2.9c-5.5,3.9-6.8,11.6-2.9,17.1c27.9,39.3,42.6,85.7,42.6,134.4c0,48.6-14.7,95.1-42.6,134.4
                C418.6,384.7,419.9,392.3,425.4,396.3z"></path>
                <path stroke="currentColor" stroke-width="16" fill="currentColor" d="M254.7,415.7c4.3,2.5,9.2,3.8,14.2,3.8l0,0c7.4,0,14.4-2.8,19.7-7.9c5.6-5.4,8.7-12.6,8.7-20.4V98.5
                c0-15.7-12.7-28.4-28.4-28.4c-4.9,0-9.8,1.3-14.2,3.8c-0.3,0.2-0.6,0.3-0.8,0.5l-100.1,69.2H73.3C32.9,143.6,0,176.5,0,216.9v55.6
                c0,40.4,32.9,73.3,73.3,73.3h84.5l95.9,69.2C254,415.3,254.4,415.5,254.7,415.7z M161.8,321.3H73.3c-26.9,0-48.8-21.9-48.8-48.8
                v-55.6c0-26.9,21.9-48.8,48.8-48.8h84.3c2.5,0,4.9-0.8,7-2.2l102.7-71c0.5-0.3,1.1-0.4,1.6-0.4c1.6,0,3.9,1.2,3.9,3.9v292.7
                c0,1.1-0.4,2-1.1,2.8c-0.7,0.7-1.8,1.1-2.7,1.1c-0.5,0-1-0.1-1.5-0.3l-98.4-71.1C166.9,322.1,164.4,321.3,161.8,321.3z"></path>
              </svg>
            </span>
          </span>
        </button>
      </div>

      <button id="micBtn" style="display: none;" type="button" aria-label="Close" class="vt-modal-mic vt-modal-title-button">
        <span class="vt-modal-close-x">
          <span class="vt-anticon vt-anticon-close vt-modal-close-icon">
            <svg width="24px" height="24px" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect width="48" height="48" fill="white" fill-opacity="0"></rect>
              <path d="M31 24V11C31 7.13401 27.866 4 24 4C20.134 4 17 7.13401 17 11V24C17 27.866 20.134 31 24 31C27.866 31 31 27.866 31 24Z" stroke="currentColor" stroke-width="4" stroke-linejoin="round"></path>
              <path d="M9 23C9 31.2843 15.7157 38 24 38C32.2843 38 39 31.2843 39 23" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M24 38V44" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
              <path id="disabledMic" d="M42 42L6 6" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg id="enabledMic" style="display: none;" width="24px" height="24px" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect width="48" height="48" fill="white" fill-opacity="0"></rect>
              <path d="M31 24V11C31 7.13401 27.866 4 24 4C20.134 4 17 7.13401 17 11V24C17 27.866 20.134 31 24 31C27.866 31 31 27.866 31 24Z" stroke="currentColor" stroke-width="4" stroke-linejoin="round"></path>
              <path d="M9 23C9 31.2843 15.7157 38 24 38C32.2843 38 39 31.2843 39 23" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M24 38V44" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
          </span>
        </span>
      </button>

      <button id="videoTogetherHelpButton" class="vt-btn" type="button">
        <span>Help</span>
      </button>
    </div>
  </div>
</div>
<div style="width: 24px; height: 24px; display: none;" id="videoTogetherSamllIcon">
  <img draggable="false" width="24px" height="24px" id="videoTogetherMaximize" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACrFBMVEXg9b7e87jd87jd9Lnd9Lre9Lng9b/j98jm98vs99fy9ubu89/e1sfJqKnFnqLGoaXf9Lvd87Xe87fd8rfV67Ti9sbk98nm9sze48TX3rjU1rTKr6jFnaLe9Lfe87Xe9LjV7LPN4q3g78PJuqfQ1a7OzarIsabEnaHi9sXd8rvd8rbd87axx4u70Jrl+cvm+szQxq25lZTR1a7KvaXFo6LFnaHEnKHd6r3Y57TZ7bLb8bTZ7rKMomClun/k+MrOx6yue4PIvqfP06vLv6fFoqLEnKDT27DS3a3W6K7Y7bDT6auNq2eYn3KqlYShYXTOwLDAzZ7MyanKtqbEoaHDm6DDm5/R2K3Q2KzT4q3W6a7P3amUhWp7SEuMc2rSyri3zJe0xpPV17TKuqbGrqLEnqDQ2K3O06rP0arR2qzJx6GZX160j4rP1LOiuH2GnVzS3rXb47zQ063OzanHr6PDnaDMxajIsaXLwKfEt5y6mI/GyqSClVZzi0bDzp+8nY/d6L/X4rbQ1qzMyKjEqKHFpqLFpaLGqaO2p5KCjlZ5jky8z5izjoOaXmLc5r3Z57jU4K7S3K3NyqnBm56Mg2KTmWnM0KmwhH2IOUunfXnh8cXe8b7Z7LPV4rDBmZ3Cmp+6mZWkk32/qZihbG97P0OdinXQ3rTk+Mjf9L/d8rja6ri9lpqnh4qhgoWyk5Kmd3qmfHW3oou2vZGKpmaUrXDg9MPf9L3e876yj5Ori42Mc3aDbG6MYmyifXfHyaPU3rHH0aKDlVhkejW70Zbf9bze87be87ng9cCLcnWQd3qEbG9/ZmmBXmSflYS4u5ra5Lnd6r7U5ba2ypPB153c87re9b2Ba22EbW+AamyDb3CNgXmxsZng7sTj9sjk98rk+Mng9cHe9Lze9Lrd87n////PlyWlAAAAAWJLR0TjsQauigAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB+YGGQYXBzHy0g0AAAEbSURBVBjTARAB7/4AAAECAwQFBgcICQoLDA0ODwAQEREREhMUFRYXGBkaGxwOAAYdHhEfICEWFiIjJCUmDicAKCkqKx8sLS4vMDEyMzQ1NgA3ODk6Ozw9Pj9AQUJDRDVFAEZHSElKS0xNTk9QUVJTVFUAVldYWVpbXF1eX2BhYmNkVABlZmdoaWprbG1ub3BxcnN0AEJ1dnd4eXp7fH1+f4CBgoMAc4QnhYaHiImKi4yNjo+QkQBFVFU2kpOUlZaXmJmam5ucAFRVnZ6foKGio6SlpqeoE6kAVaqrrK2ur7CxsrO0tQEDtgC3uLm6u7y9vr/AwcLDxMXGAMfIycrLzM3Oz9DR0tMdAdQA1da619jZ2tvc3d7f4OEB4iRLaea64H7qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDIyLTA2LTI1VDA2OjIzOjAyKzAwOjAwlVQlhgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMi0wNi0yNVQwNjoyMzowMiswMDowMOQJnToAAAAgdEVYdHNvZnR3YXJlAGh0dHBzOi8vaW1hZ2VtYWdpY2sub3JnvM8dnQAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMTkyQF1xVQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE2NTYxMzgxODJHYkS0AAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjItMDYtMjUvNGU5YzJlYjRjNmRhMjIwZDgzYjcyOTYxZmI1ZTJiY2UuaWNvLnBuZ7tNVVEAAAAASUVORK5CYII=">
  
</div>

<style>
  #videoTogetherFlyPannel {
    background-color: #ffffff !important;
    display: block;
    z-index: 2147483647;
    position: fixed;
    bottom: 15px;
    right: 15px;
    width: 260px;
    height: 210px;
    text-align: center;
    border: solid 1px #e9e9e9 !important;
    box-shadow: 0 3px 6px -4px #0000001f, 0 6px 16px #00000014, 0 9px 28px 8px #0000000d;
    border-radius: 10px;
    line-height: 1.2;
  }

  #videoTogetherFlyPannel #videoTogetherHeader {
    cursor: move;
    touch-action: none;
    align-items: center;
    display: flex;
  }

  .vt-modal-content {
    /* position: relative; */
    width: 100%;
    height: 100%;
  }

  #roomButtonGroup,
  #lobbyBtnGroup,
  .content {
    display: contents;
  }

  .vt-modal-audio {
    position: absolute;
    top: 10px;
    right: 140px;
  }

  .vt-modal-mic {
    position: absolute;
    top: 10px;
    right: 100px;
  }

  .vt-modal-setting {
    position: absolute;
    top: -1px;
    right: 65px;
  }

  .vt-modal-easyshare {
    position: absolute;
    top: -1px;
    right: 90px;
  }

  .vt-modal-donate {
    position: absolute;
    top: -1px;
    right: 40px;
  }

  .vt-modal-title-button {
    z-index: 10;
    padding: 0;
    color: #6c6c6c;
    font-weight: 700;
    line-height: 1;
    text-decoration: none;
    background: transparent;
    border: 0;
    outline: 0;
    cursor: pointer;
    transition: color .3s;
  }

  .vt-modal-close {
    position: absolute;
    top: 0;
    right: 15px;
  }

  .vt-modal-close-x {
    width: 18px;
    height: 46px;
    font-size: 16px;
    font-style: normal;
    line-height: 46px;
    text-align: center;
    text-transform: none;
    text-rendering: auto;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .vt-modal-close-x:hover {
    color: #1890ff;
  }

  .error-button {
    color: #ff6f72;
  }

  .error-button:hover {
    color: red;
  }

  .vt-modal-header {
    display: flex;
    padding: 12px;
    color: #000000d9;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
    border-radius: 10px 10px 0 0;
    align-items: center;
  }

  .vt-modal-title {
    margin: 0;
    margin-left: 10px;
    color: #000000d9;
    font-weight: 500;
    font-size: 16px;
    line-height: 22px;
    word-wrap: break-word;
  }

  .vt-modal-body {
    height: 164px;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    font-size: 16px;
    color: black;
    border-radius: 0 0 10px 10px;
    background-size: cover;
  }

  .vt-modal-footer {
    padding: 10px 16px;
    text-align: right;
    background: transparent;
    border-top: 1px solid #f0f0f0;
    border-radius: 0 0 2px 2px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }

  .vt-btn {
    line-height: 1.5715;
    position: relative;
    display: inline-block;
    font-weight: 400;
    white-space: nowrap;
    text-align: center;
    background-image: none;
    border: 1px solid transparent;
    box-shadow: 0 2px #00000004;
    cursor: pointer;
    transition: all .3s cubic-bezier(.645, .045, .355, 1);
    -webkit-user-select: none;
    -moz-user-select: none;
    user-select: none;
    touch-action: manipulation;
    height: 32px;
    padding: 4px 15px;
    font-size: 14px;
    border-radius: 2px;
    color: #000000d9;
    border-color: #d9d9d9;
    background: #fff;
    outline: 0;
    text-shadow: 0 -1px 0 rgb(0 0 0 / 12%);
    box-shadow: 0 2px #0000000b;
  }

  .vt-btn:hover {
    border-color: #e3e5e7 !important;
    background-color: #e3e5e7 !important;
  }

  .vt-btn-primary {
    color: #fff;
    border-color: #1890ff;
    background: #1890ff !important;
  }

  .vt-btn-primary:hover {
    border-color: #6ebff4 !important;
    background-color: #6ebff4 !important;
  }

  .vt-btn-secondary {
    color: #fff;
    border-color: #23d591;
    background: #23d591 !important;
  }

  .vt-btn-secondary:hover {
    border-color: #8af0bf !important;
    background-color: #8af0bf !important;
  }

  .vt-btn-dangerous {
    color: #fff;
    border-color: #ff4d4f;
    background-color: #ff4d4f;
  }

  .vt-btn-dangerous:hover {
    border-color: #f77173 !important;
    background-color: #f77173 !important;
  }

  .vt-modal-content-item {
    cursor: pointer;
    box-shadow: 0px 1px 4px 0px rgba(0, 0, 0, 0.16);
    padding: 0 12px;
    width: 45%;
    height: 60px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
  }

  .vt-modal-content-item:hover {
    background-color: #efefef;
  }

  #videoTogetherSamllIcon {
    z-index: 2147483647;
    position: fixed;
    bottom: 15px;
    right: 15px;
    text-align: center;
  }

  #videoTogetherRoomNameLabel,
  #videoTogetherRoomPasswordLabel {
    display: inline-block;
    width: 76px;
  }

  #videoTogetherRoomNameInput:disabled {
    border: none;
    background-color: transparent;
    color: black;
  }

  #videoTogetherRoomNameInput,
  #videoTogetherRoomPasswordInput {
    width: 150px;
    height: auto;
    font-family: inherit;
    font-size: inherit;
    display: inline-block;
    padding: 0;
    color: #00000073;
    background-color: #ffffff;
    border: 1px solid #e9e9e9;
    margin: 0;
  }

  .lds-ellipsis {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 32px;
  }

  .lds-ellipsis div {
    position: absolute;
    top: 8px;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: #6c6c6c;
    animation-timing-function: cubic-bezier(0, 1, 1, 0);
  }

  .lds-ellipsis div:nth-child(1) {
    left: 8px;
    animation: lds-ellipsis1 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(2) {
    left: 8px;
    animation: lds-ellipsis2 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(3) {
    left: 32px;
    animation: lds-ellipsis2 0.6s infinite;
  }

  .lds-ellipsis div:nth-child(4) {
    left: 56px;
    animation: lds-ellipsis3 0.6s infinite;
  }

  @keyframes lds-ellipsis1 {
    0% {
      transform: scale(0);
    }

    100% {
      transform: scale(1);
    }
  }

  @keyframes lds-ellipsis3 {
    0% {
      transform: scale(1);
    }

    100% {
      transform: scale(0);
    }
  }

  @keyframes lds-ellipsis2 {
    0% {
      transform: translate(0, 0);
    }

    100% {
      transform: translate(24px, 0);
    }
  }




  .range-slider {
    margin: 0px 0 0 0px;
    display: inline-block;
  }

  .range-slider {
    width: 130px
  }

  .slider {
    -webkit-appearance: none;
    width: calc(100% - (0px));
    height: 5px;
    border-radius: 5px;
    background: #d7dcdf;
    outline: none;
    padding: 0;
    margin: 0;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    -webkit-transition: background 0.15s ease-in-out;
    transition: background 0.15s ease-in-out;
  }

  .slider::-moz-range-progress {
    background-color: #1abc9c;
  }

  .slider::-webkit-slider-thumb:hover {
    background: #1abc9c;
  }

  .slider:active::-webkit-slider-thumb {
    background: #1abc9c;
  }

  .slider::-moz-range-thumb {
    width: 10px;
    height: 10px;
    border: 0;
    border-radius: 50%;
    background: #2c3e50;
    cursor: pointer;
    -moz-transition: background 0.15s ease-in-out;
    transition: background 0.15s ease-in-out;
  }

  .slider::-moz-range-thumb:hover {
    background: #1abc9c;
  }

  .slider:active::-moz-range-thumb {
    background: #1abc9c;
  }

  ::-moz-range-track {
    background: #d7dcdf;
    border: 0;
  }

  input::-moz-focus-inner,
  input::-moz-focus-outer {
    border: 0;
  }



  .toggler-wrapper {
    display: inline-block;
    width: 45px;
    height: 20px;
    cursor: pointer;
    position: relative;
  }

  .toggler-wrapper input[type="checkbox"] {
    display: none;
  }

  .toggler-wrapper input[type="checkbox"]:checked+.toggler-slider {
    background-color: #1abc9c;
  }

  .toggler-wrapper .toggler-slider {
    margin-top: 4px;
    background-color: #ccc;
    position: absolute;
    border-radius: 100px;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    -webkit-transition: all 300ms ease;
    transition: all 300ms ease;
  }

  .toggler-wrapper .toggler-knob {
    position: absolute;
    -webkit-transition: all 300ms ease;
    transition: all 300ms ease;
  }

  .toggler-wrapper.style-1 input[type="checkbox"]:checked+.toggler-slider .toggler-knob {
    left: calc(100% - 16px - 3px);
  }

  .toggler-wrapper.style-1 .toggler-knob {
    width: calc(20px - 6px);
    height: calc(20px - 6px);
    border-radius: 50%;
    left: 3px;
    top: 3px;
    background-color: #fff;
  }


  #snackbar {
    visibility: hidden;
    width: auto;
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 16px 0px 16px 0px;
    position: relative;
    z-index: 999999;
    top: -56px;
  }

  #snackbar.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
  }

  @keyframes fadein {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes fadeout {
    from {
      opacity: 1;
    }

    to {
      opacity: 0;
    }
  }

  #downloadProgress {
    display: flex;
    flex-direction: column;
    width: 80%;
    align-items: center;
    margin: auto;
  }

  #speedAndStatus {
    display: flex;
    justify-content: space-between;
  }

  #downloadPannel {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    justify-content: space-between;
  }

  #downloadVideoInfo {
    display: block;
  }
</style></template></div></body></html>